<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„çŸ¥è­˜ç¾…ç›¤ | My KB Journey v3.11 Timeline-Fixed</title>
    
    <!-- ğŸ”¥ 1. å¼•å…¥ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Markdown for AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; padding-top: 28px; /* Space for fixed status bar */ }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .kb-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; font-weight: 600; }
        
        /* æƒ³æ³•æ¼”åŒ–è»Œè·¡çš„é€£ç·šæ¨£å¼ */
        .evolution-line {
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -24px; /* Slightly longer to connect better */
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        /* Hide line for the last item */
        .evolution-item:last-child .evolution-line { display: none; }
        
        /* ç¤¾ç¾¤æ¨å‹•åŠ›çš„æ¼£æ¼ªå‹•ç•«æ•ˆæœ */
        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(96, 165, 250, 0); }
        }
        .ripple-effect {
            animation: ripple 2s infinite;
        }
        
        /* ç¶²çµ¡ç¯€é»å‹•ç•« */
        @keyframes pulse-node {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .node-pulse { animation: pulse-node 2s infinite ease-in-out; }

        /* ç°¡å–®çš„æ·¡å…¥å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* èªªæ˜æ–‡å­—å€å¡Šæ¨£å¼ */
        .insight-box {
            background-color: #f8fafc;
            border-left: 3px solid #cbd5e1;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* text-slate-500 */
            line-height: 1.4;
        }
        .insight-title {
            font-weight: 700;
            color: #475569;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        .insight-title i { margin-right: 0.25rem; }

        /* Modal Styles - Mobile Optimized */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(2px);
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Add padding for mobile */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 100%; /* Full width on mobile */
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFadeIn 0.3s;
            max-height: 90vh; /* Max height for mobile */
            display: flex;
            flex-direction: column;
        }
        @keyframes modalFadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            flex-shrink: 0; /* Header stays fixed */
        }
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto; /* Scrollable body */
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 0.5rem; /* Bigger touch target */
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Ref Button Style */
        .ref-btn {
            color: #9ca3af; /* text-gray-400 */
            background-color: #f3f4f6; /* bg-gray-100 */
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem; /* text-xs */
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            margin-left: 0.5rem;
            cursor: pointer;
        }
        .ref-btn:hover {
            color: #4f46e5; /* text-indigo-600 */
            background-color: #e0e7ff; /* bg-indigo-50 */
        }
        /* Dark mode compatible ref button for Community Impact card */
        .ref-btn-dark {
            color: #94a3b8; /* text-slate-400 */
            background-color: rgba(255,255,255,0.1);
        }
        .ref-btn-dark:hover {
            color: white;
            background-color: rgba(255,255,255,0.2);
        }
        
        /* New: Tiny Ref Button for Role Cards */
        .ref-btn-mini {
             position: absolute;
             top: 4px;
             right: 4px;
             font-size: 0.65rem;
             padding: 2px 6px;
             color: #cbd5e1;
             background: transparent;
             cursor: pointer;
        }
        .ref-btn-mini:hover {
            color: #6366f1;
            background: #f1f5f9;
        }

        /* Legend Dot */
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body class="text-gray-800">

    <!-- ğŸ”¥ [MODIFIED] Top Status Bar: Fixed Position to guarantee visibility -->
    <div class="fixed top-0 left-0 w-full bg-slate-900 text-white text-[10px] py-1 px-4 flex justify-between items-center z-[100] border-b border-slate-700 shadow-sm font-mono h-7">
        <div class="flex items-center gap-4">
            <span class="flex items-center gap-1"><i class="fas fa-server text-green-500"></i> SYSTEM: <span class="text-green-400 font-bold">CLOUD CONNECTED</span></span>
            <span class="hidden sm:flex items-center gap-1"><i class="fas fa-database text-yellow-500"></i> DB: <span id="db-status-text" class="text-yellow-400">CONNECTING...</span></span>
        </div>
        <div class="flex items-center gap-1">
            <i class="fas fa-robot text-slate-400"></i> AI Status: <span id="ai-status-indicator" class="text-slate-300">Checking...</span>
        </div>
    </div>

    <!-- é ‚éƒ¨å°èˆª -->
    <!-- ğŸ”¥ [MODIFIED] Added top-7 to account for status bar -->
    <nav class="bg-indigo-600 text-white shadow-lg sticky top-7 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4 flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-0">
            <div class="flex items-center space-x-3 w-full sm:w-auto justify-center sm:justify-start">
                <i class="fas fa-compass text-2xl"></i>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold">çŸ¥è­˜ç¾…ç›¤ Knowledge Compass</h1>
                    <p class="text-xs text-indigo-200 hidden sm:block">å¾Œè¨­èªçŸ¥èˆ‡æˆé•·æ­·ç¨‹ (Student Portfolio)</p>
                </div>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto justify-center sm:justify-end overflow-x-auto pb-1 sm:pb-0">
                <div class="flex items-center gap-2 mr-2">
                    <a href="index.html" class="nav-btn bg-indigo-700 hover:bg-indigo-500 px-2 sm:px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-indigo-500 whitespace-nowrap">
                        <i class="fas fa-home"></i> <span class="hidden sm:inline">é¦–é </span>
                    </a>
                    <a href="Knowledge Building Forum.html" class="nav-btn bg-indigo-700 hover:bg-indigo-500 px-2 sm:px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-indigo-500 whitespace-nowrap">
                        <i class="fas fa-comments"></i> <span class="hidden sm:inline">è«–å£‡</span>
                    </a>
                    <button onclick="syncData()" id="sync-btn" class="nav-btn bg-emerald-600 hover:bg-emerald-500 px-2 sm:px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-emerald-500 whitespace-nowrap">
                        <i class="fas fa-sync-alt"></i> <span class="hidden sm:inline">åˆ·æ–°</span>
                    </button>
                </div>
                <div class="text-right hidden md:block">
                    <span class="block font-bold" id="user-name">è¨ªå®¢</span>
                    <span class="text-xs text-indigo-200">å­¸ç¿’è€…</span>
                </div>
                <img id="current-user-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-white flex-shrink-0">
                
                <!-- Student Switcher Container -->
                <div id="nav-user-select-container"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="container mx-auto px-4 sm:px-6 py-6 sm:py-8 space-y-6 sm:space-y-8 fade-in pb-20">

        <!-- 1. çŸ¥è­˜è§’è‰²æ¨¡çµ„ -->
        <section class="card bg-gradient-to-r from-white to-blue-50 border border-blue-100 relative overflow-hidden">
             <!-- èƒŒæ™¯è£é£¾ -->
             <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-blue-100 rounded-full opacity-50 blur-2xl pointer-events-none"></div>

             <div class="flex flex-col md:flex-row items-center gap-6 sm:gap-8 relative z-10">
                 <div class="w-full md:w-1/3 text-center md:text-left md:border-r border-gray-200 md:pr-8">
                     <div class="flex items-center justify-center md:justify-start mb-3">
                        <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">
                            <i class="fas fa-user-tag mr-1"></i> æˆ‘çš„çŸ¥è­˜è§’è‰²
                        </h2>
                        <button onclick="openRefModal('roles')" class="ref-btn" title="äº†è§£è§’è‰²å®šç¾©"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                     </div>
                     <div class="flex items-center justify-center md:justify-start gap-5">
                         <div class="w-16 h-16 sm:w-20 sm:h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white text-2xl sm:text-3xl shadow-xl ripple-effect flex-shrink-0">
                             <div id="user-avatar-large" class="text-xl sm:text-2xl font-bold">?</div>
                         </div>
                         <div>
                             <h3 class="text-xl sm:text-2xl font-bold text-indigo-900" id="role-title">æ¢ç´¢è€…</h3>
                             <p class="text-xs sm:text-sm text-indigo-600 font-medium" id="role-subtitle">The Knowledge Explorer</p>
                         </div>
                     </div>
                     <div class="mt-4 bg-white/60 p-3 rounded-lg text-sm text-gray-600 leading-relaxed border border-white text-left" id="role-desc">
                         <i class="fas fa-quote-left text-indigo-300 mr-1"></i> æ­£åœ¨åˆ†æä½ çš„ç™¼è¨€æ¨¡å¼...
                     </div>
                 </div>
                 
                 <div class="w-full md:w-2/3">
                     <div class="grid grid-cols-2 gap-3 sm:gap-4">
                         <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('initiator')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-[10px] sm:text-xs mb-1">é–‹å‰µåŠ› (Initiator)</div>
                             <div class="text-base sm:text-lg font-bold text-gray-800" id="role-initiator-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2"><div class="bg-blue-400 h-1.5 rounded-full" id="role-initiator-bar" style="width: 0%"></div></div>
                         </div>
                         <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('builder')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-[10px] sm:text-xs mb-1">é€£çµåŠ› (Builder)</div>
                             <div class="text-base sm:text-lg font-bold text-gray-800" id="role-builder-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2"><div class="bg-indigo-600 h-1.5 rounded-full" id="role-builder-bar" style="width: 0%"></div></div>
                         </div>
                         <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('synthesizer')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-[10px] sm:text-xs mb-1">æ•´åˆåŠ› (Synthesizer)</div>
                             <div class="text-base sm:text-lg font-bold text-gray-800" id="role-synthesizer-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2"><div class="bg-purple-400 h-1.5 rounded-full" id="role-synthesizer-bar" style="width: 0%"></div></div>
                         </div>
                         <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('sustainer')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-[10px] sm:text-xs mb-1">ç¶­è­·åŠ› (Sustainer)</div>
                             <div class="text-base sm:text-lg font-bold text-gray-800" id="role-sustainer-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2"><div class="bg-green-400 h-1.5 rounded-full" id="role-sustainer-bar" style="width: 0%"></div></div>
                         </div>
                     </div>
                 </div>
             </div>
        </section>

        <!-- 2. æ ¸å¿ƒæ•¸æ“šæ¦‚è¦½ -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
            <div class="card border-l-4 border-blue-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('created')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-[10px] sm:text-xs font-medium uppercase">æˆ‘çš„è²¢ç» (Created)</h3>
                <div class="mt-1 flex items-baseline"><span class="text-xl sm:text-2xl font-bold text-gray-900" id="card-created-val">0</span></div>
            </div>
            <div class="card border-l-4 border-green-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('read')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-[10px] sm:text-xs font-medium uppercase">é–±è®€ä»–äºº (Read)</h3>
                <div class="mt-1 text-xl sm:text-2xl font-bold text-gray-900" id="card-read-val">0</div>
            </div>
            <div class="card border-l-4 border-purple-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('buildon')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-[10px] sm:text-xs font-medium uppercase">è§€é»é€£çµ (Build-ons)</h3>
                <div class="mt-1 text-xl sm:text-2xl font-bold text-gray-900" id="card-buildon-val">0</div>
            </div>
            <div class="card border-l-4 border-yellow-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('impact')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-[10px] sm:text-xs font-medium uppercase">å½±éŸ¿ä¿‚æ•¸ (Impact)</h3>
                <div class="mt-1 text-xl sm:text-2xl font-bold text-gray-900" id="card-impact-val">0</div>
            </div>
        </section>

        <!-- 3. åœ–è¡¨åˆ†æå€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card col-span-1 lg:col-span-1 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-chart-radar text-indigo-500 mr-2"></i> çŸ¥è­˜äº”åŠ›åˆ†æ</h3>
                    <button onclick="openRefModal('radar')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="flex-1 min-h-[250px] relative">
                    <canvas id="studentRadarChart"></canvas>
                </div>
                <div id="radar-decision-text" class="text-xs text-slate-500 mt-2 p-2 bg-slate-50 rounded border border-slate-100">
                    <i class="fas fa-spinner fa-spin mr-1"></i> æ­£åœ¨åˆ†ææ€ç¶­æ¨¡å¼...
                </div>
            </div>

            <div class="card col-span-1 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-code-branch text-emerald-500 mr-2"></i> æœ€è¿‘çš„æ€è€ƒè»Œè·¡</h3>
                    <div class="flex items-center gap-2">
                         <a href="Knowledge Building Forum.html" class="text-xs text-indigo-600 hover:underline font-bold mr-2 hidden sm:inline">å»è«–å£‡å›æ‡‰ ></a>
                         <button onclick="openRefModal('evolution')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                    </div>
                </div>
                <div class="relative pl-4 space-y-0" id="evolution-timeline">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>
        </div>

        <!-- 4. é·¹æ¶èˆ‡ AI å»ºè­° -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-tools text-orange-500 mr-2"></i> æ€è€ƒé·¹æ¶åå¥½</h3>
                    <button onclick="openRefModal('scaffold')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="flex items-end gap-2 h-40" id="scaffold-bars"></div>
                <div class="flex justify-between text-xs text-slate-500 mt-2 px-1">
                    <span>æå•</span><span>å»¶ä¼¸</span><span>æ”¹é€²</span><span>åé§</span><span>æ˜‡è¯</span>
                </div>
            </div>

            <div class="card border-l-4 border-indigo-500 bg-indigo-50/50">
                <!-- ğŸ”¥ AI Section Title & Button -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-indigo-900 flex items-center"><i class="fas fa-robot text-indigo-600 mr-2"></i> ä¾†è‡ª AI å°å¸«çš„å»ºè­°</h3>
                    <div class="flex gap-2">
                        <button class="text-xs bg-white border border-indigo-200 px-3 py-1 rounded-full text-indigo-600 hover:bg-indigo-50 transition font-bold" onclick="triggerAIAnalysis('advice')">
                            <i class="fas fa-magic mr-1"></i> æ›´æ–°å»ºè­°
                        </button>
                        <button class="text-xs bg-indigo-600 border border-indigo-600 px-3 py-1 rounded-full text-white hover:bg-indigo-700 transition font-bold shadow-md" onclick="triggerAIAnalysis('portfolio')">
                            <i class="fas fa-file-alt mr-1"></i> ç”Ÿæˆå‚™å¯©è‡ªè¿°
                        </button>
                    </div>
                </div>
                <div id="ai-feedback" class="text-sm text-slate-700 space-y-4 leading-relaxed h-[180px] overflow-y-auto custom-scroll pr-2">
                    <p class="text-slate-400 italic">é»æ“Šã€Œæ›´æ–°å»ºè­°ã€ç²å–å­¸ç¿’æŒ‡å¼•ï¼Œæˆ–é»æ“Šã€Œç”Ÿæˆå‚™å¯©è‡ªè¿°ã€è‡ªå‹•æ’°å¯«å­¸ç¿’æ­·ç¨‹è‰ç¨¿...</p>
                </div>
            </div>
        </div>
        
        <!-- 5. é€²éšæŒ‡æ¨™èˆ‡ Ego Network -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- è©å½™æ¼”åŒ– -->
            <div class="card relative overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-spell-check text-purple-600 mr-2"></i>èªç¾©èˆ‡è©å½™æ·±åº¦</h2>
                    <button onclick="openRefModal('lexical')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="space-y-6">
                    <div class="flex justify-between items-center relative">
                        <div class="text-center w-1/3 opacity-60">
                            <div class="text-xs text-gray-500 font-bold mb-2">åˆå§‹éšæ®µ (Initial)</div>
                            <div class="space-y-1 text-sm text-gray-400">
                                <div><i class="fas fa-comment mr-1"></i> æˆ‘è¦ºå¾—...</div>
                                <div><i class="fas fa-comment mr-1"></i> å¥½åƒæ˜¯...</div>
                            </div>
                        </div>
                        <div class="text-center text-purple-300"><i class="fas fa-long-arrow-alt-right text-3xl"></i></div>
                        <div class="text-center w-1/3">
                            <div class="text-xs text-purple-600 font-bold mb-2">ç•¶å‰éšæ®µ (Current)</div>
                            <div class="space-y-1 text-sm font-bold text-purple-800">
                                <div><i class="fas fa-check mr-1"></i> ç†è«–é¡¯ç¤º...</div>
                                <div><i class="fas fa-check mr-1"></i> è­‰æ“šæ”¯æŒ...</div>
                            </div>
                        </div>
                    </div>
                    <div class="insight-box bg-purple-50 border-purple-200 text-purple-900">
                         <div class="insight-title text-purple-800"><i class="fas fa-book"></i> å­¸è¡“è©å½™åˆ†æ</div>
                         æ­¤æŒ‡æ¨™è¿½è¹¤ä½ å¾ä½¿ç”¨ã€Œæ—¥å¸¸èªè¨€ã€è½‰å‘ã€Œå°ˆæ¥­è¡“èªã€çš„éç¨‹ã€‚
                    </div>
                </div>
            </div>

            <!-- ğŸ”¥ğŸ”¥ Ego Network: Fixed Layout -->
            <div class="card relative overflow-hidden h-[400px] flex flex-col">
                <div class="flex justify-between items-center mb-2 flex-shrink-0">
                    <h2 class="text-lg font-bold flex items-center text-slate-800"><i class="fas fa-project-diagram text-indigo-500 mr-2"></i>çŸ¥è­˜ç¶²çµ¡ä½ç½®ï¼šè‡ªæˆ‘èˆ‡ç¤¾ç¾¤äº’å‹•åœˆ</h2>
                    <button onclick="openRefModal('interaction_circle')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="flex gap-2 text-[10px] mb-2 px-1 flex-shrink-0">
                    <span class="flex items-center"><span class="legend-dot" style="background:#3b82f6"></span>æå•</span>
                    <span class="flex items-center"><span class="legend-dot" style="background:#eab308"></span>å»¶ä¼¸</span>
                    <span class="flex items-center"><span class="legend-dot" style="background:#22c55e"></span>æ”¹é€²</span>
                    <span class="flex items-center"><span class="legend-dot" style="background:#ef4444"></span>åé§</span>
                    <span class="flex items-center"><span class="legend-dot" style="background:#a855f7"></span>æ•´åˆ</span>
                </div>
                <div id="ego-network-container" class="w-full flex-1 bg-slate-50 rounded-lg border border-slate-100 min-h-0"></div>
            </div>
        </section>

        <!-- New: Advanced KB Indicators -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="card">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> è§€é»å¤šæ¨£æ€§ (Idea Diversity)</h3>
                    <button onclick="openRefModal('diversity')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="text-sm text-gray-600">
                    ç›®å‰ä½ åƒèˆ‡äº† <span class="font-bold text-indigo-600" id="topic-count-val">0</span> å€‹ä¸åŒçš„ä¸»é¡Œè¨è«–ã€‚
                    <div class="w-full bg-gray-100 rounded-full h-2 mt-2">
                         <div class="bg-yellow-400 h-2 rounded-full" id="topic-diversity-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
             <div class="card">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-road text-blue-500 mr-2"></i> èªçŸ¥è·¯å¾‘é•·åº¦ (Path Length)</h3>
                    <button onclick="openRefModal('path_length')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="text-sm text-gray-600">
                    ä½ çš„è¨è«–ä¸²å¹³å‡æ·±åº¦ç‚º <span class="font-bold text-indigo-600" id="avg-depth-val">0</span> å±¤ã€‚
                    <div class="w-full bg-gray-100 rounded-full h-2 mt-2">
                         <div class="bg-blue-400 h-2 rounded-full" id="avg-depth-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Note Detail Modal -->
    <div id="note-detail-modal" class="modal" onclick="closeModalDirect(event, 'note-detail-modal')">
        <div class="modal-content max-w-lg">
            <div class="modal-header bg-indigo-50">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center"><i class="fas fa-sticky-note mr-2"></i> ç™¼è¨€è©³æƒ…</h3>
                <button onclick="document.getElementById('note-detail-modal').style.display='none'" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <span id="nd-type" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-700 uppercase">TYPE</span>
                    <span id="nd-date" class="text-xs text-slate-400 ml-2">YYYY-MM-DD</span>
                </div>
                <h2 id="nd-title" class="text-xl font-bold text-slate-800 mb-4">æ¨™é¡Œè¼‰å…¥ä¸­...</h2>
                <div id="nd-content" class="text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-100 whitespace-pre-wrap">å…§å®¹è¼‰å…¥ä¸­...</div>
                <div class="mt-4 flex items-center justify-end">
                    <span class="text-xs text-slate-400 mr-2">Author:</span>
                    <span id="nd-author" class="text-sm font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded">User</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ref Modal Structure -->
    <div id="refModal" class="modal" onclick="closeModalDirect(event, 'refModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-book-open text-indigo-500"></i> <span id="modalTitle">æ•¸æ“šè§£æ</span></h3>
                <span class="close" onclick="document.getElementById('refModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body space-y-5">
                <!-- 1. ç†è«–èƒŒæ™¯ -->
                <div>
                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-graduation-cap mr-2"></i> (1) çŸ¥è­˜å»ºæ§‹ç†è«–èƒŒæ™¯</h4>
                    <div class="text-sm text-slate-700 bg-blue-50 p-3 rounded-lg border border-blue-100 leading-relaxed" id="modalTheory"></div>
                </div>
                <!-- 2. æ•¸æ“šè¨ºæ–· -->
                <div>
                    <h4 class="text-xs font-bold text-yellow-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-lightbulb mr-2"></i> (2) ğŸ’¡ æ•¸æ“šè¨ºæ–·èˆ‡æ•™å­¸å°å¼•</h4>
                    <div class="text-sm text-slate-700 bg-yellow-50 p-3 rounded-lg border border-yellow-100 leading-relaxed" id="modalInsight"></div>
                </div>
                <!-- 3. ç›®å‰ç‹€æ³ -->
                <div>
                    <h4 class="text-xs font-bold text-green-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-chart-pie mr-2"></i> (3) ç›®å‰çš„ç‹€æ³ (æ•¸æ“š)</h4>
                    <div class="text-sm text-slate-700 bg-green-50 p-3 rounded-lg border border-green-100 font-mono font-bold" id="modalStatus"></div>
                </div>
                <!-- 4. å­¸è¡“å¼•ç”¨ -->
                <div class="pt-4 border-t border-slate-100">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 flex items-center"><i class="fas fa-quote-right mr-2"></i> (4) ğŸ“š å­¸è¡“åƒè€ƒä¾†æº</h4>
                    <p class="text-xs text-slate-500 italic" id="modalRef"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ğŸ”¥ 2. Firebase Initialization (Cloud Core)
    const firebaseConfig = {
        apiKey: "AIzaSyDPjtxtf656JHVVlj1o4cLwSylo1jDBFAc",
        authDomain: "kb-platform-1.firebaseapp.com",
        databaseURL: "https://kb-platform-1-default-rtdb.firebaseio.com",
        projectId: "kb-platform-1",
        storageBucket: "kb-platform-1.firebasestorage.app",
        messagingSenderId: "230026226847",
        appId: "1:230026226847:web:49e6f09ddfc3de0ef046aa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const DB_COLLECTION = 'kb_platform';
    const DB_DOC = 'class_data';
    const SETTINGS_DOC = db.collection('kb_platform').doc('settings');

    // --- Global State ---
    let currentUserId = '';
    let globalData = {}; // Store raw Firebase Data
    let radarChartInstance = null;
    let currentUserStats = null; 
    let aiKey = "";
    let egoNetworkInstance = null; // Vis network instance

    // --- Ref Data Database ---
    const refData = {
        'interaction_circle': {
            title: 'è‡ªæˆ‘èˆ‡ç¤¾ç¾¤äº’å‹•åœˆ (Ego Network)',
            theory: 'æ­¤åœ–å‘ˆç¾ä»¥ä½ ç‚ºä¸­å¿ƒçš„çŸ¥è­˜äº’å‹•ç¶²çµ¡ã€‚ç®­é ­ä»£è¡¨å°è©±æµå‘ï¼Œé¡è‰²ä»£è¡¨å°è©±æ€§è³ªï¼ˆå¦‚æå•ã€å»¶ä¼¸ã€åé§ç­‰ï¼‰ã€‚è±å¯Œçš„é€£çµé¡å‹èˆ‡å°è±¡å¤šæ¨£æ€§ï¼Œåæ˜ äº†ä½ åœ¨ç¤¾ç¾¤ä¸­æ´»èºçš„ç¤¾æœƒèªçŸ¥å‹•æ…‹ (Socio-cognitive Dynamics)ã€‚',
            cite: 'Zhang, J., Scardamalia, M., Reeve, R., & Messina, R. (2009). Designs for collective cognitive responsibility in knowledge-building communities. Journal of the Learning Sciences.'
        },
        'roles': {
            title: 'çŸ¥è­˜è§’è‰² (Epistemic Roles)',
            theory: 'æ ¹æ“š Scardamalia (2002) çš„ã€Œèªè­˜è«–ä»£ç†äºº (Epistemic Agency)ã€ï¼Œå­¸ç”Ÿåœ¨ç¤¾ç¾¤ä¸­æ‡‰å±•ç¾å¤šæ¨£åŒ–çš„è²¢ç»æ¨¡å¼ï¼Œå¦‚ç™¼èµ·è€…ã€é€£çµè€…æˆ–æ•´åˆè€…ï¼Œè€Œéå–®ä¸€çš„æ¥æ”¶è€…ã€‚',
            cite: 'Scardamalia, M. (2002). Socio-cognitive dynamics of knowledge building.'
        },
        'initiator': {
            title: 'é–‹å‰µåŠ› (Initiator)',
            theory: 'è¡¡é‡å­¸ç”Ÿç™¼èµ·æ–°è¨è«–ä¸²çš„èƒ½åŠ›ã€‚é€™æ˜¯ã€ŒçœŸå¯¦å•é¡Œ (Real Ideas, Authentic Problems)ã€åŸå‰‡çš„é«”ç¾ã€‚',
            cite: 'Zhang, J., et al. (2009). Designs for collective cognitive responsibility.'
        },
        'builder': {
            title: 'é€£çµåŠ› (Builder)',
            theory: 'è¡¡é‡å­¸ç”Ÿå»¶ä¼¸èˆ‡å›æ‡‰ä»–äººæƒ³æ³•çš„èƒ½åŠ›ã€‚é«”ç¾ã€Œè§€é»æ”¹é€² (Improvable Ideas)ã€åŸå‰‡ã€‚',
            cite: 'Scardamalia, M., & Bereiter, C. (2006). Knowledge building.'
        },
        'synthesizer': {
            title: 'æ•´åˆåŠ› (Synthesizer)',
            theory: 'è¡¡é‡å­¸ç”Ÿé€²è¡Œã€Œæ˜‡è¯ (Rise-above)ã€çš„èƒ½åŠ›ï¼Œå°‡åˆ†æ•£è§€é»æ•´åˆç‚ºæ›´é«˜å±¤æ¬¡çš„è§£é‡‹ã€‚',
            cite: 'Chen, B., et al. (2015). Advancing knowledge building discourse.'
        },
        'sustainer': {
            title: 'ç¶­è­·åŠ› (Sustainer)',
            theory: 'è¡¡é‡å­¸ç”Ÿç¶­æŒè¨è«–ç†±åº¦èˆ‡ç¤¾ç¾¤äº’å‹•çš„èƒ½åŠ›ï¼Œç¢ºä¿çŸ¥è­˜å°è©±ä¸ä¸­æ–·ã€‚',
            cite: 'Oshima, J., et al. (2012). Knowledge building discourse explorer.'
        },
        'created': {
            title: 'ç™¼æ–‡è²¢ç» (Contribution)',
            theory: 'ã€Œé›†é«”èªçŸ¥è²¬ä»»ã€è¦æ±‚æ¯å€‹æˆå“¡éƒ½éœ€å°ç¤¾ç¾¤çŸ¥è­˜çš„é€²æ­¥åšå‡ºè²¢ç»ã€‚ç™¼æ–‡é‡é›–éå”¯ä¸€æŒ‡æ¨™ï¼Œå»æ˜¯åƒèˆ‡çš„åŸºç¤é–€æª»ã€‚',
            cite: 'Zhang, J., et al. (2009). Designs for collective cognitive responsibility.'
        },
        'read': {
            title: 'é–±è®€å»£åº¦ (Reading Breadth)',
            theory: 'çŸ¥è­˜å»ºæ§‹å¼·èª¿ã€Œè§€é»å¤šæ¨£æ€§ (Idea Diversity)ã€ã€‚å»£æ³›é–±è®€ä»–äººç­†è¨˜æ˜¯ç†è§£ç¤¾ç¾¤åˆ†æ•£çŸ¥è­˜çš„å‰æï¼Œé¿å…é–‰é–€é€ è»Šã€‚',
            cite: 'Chen, B., & Hong, H. Y. (2016). Schools as knowledge-building communities.'
        },
        'buildon': {
            title: 'è§€é»é€£çµ (Build-ons)',
            theory: 'ã€Œè§€é»æ”¹é€² (Improvable Ideas)ã€æ˜¯ KB çš„æ ¸å¿ƒã€‚Build-on ä»£è¡¨ä½ ä¸åƒ…é–±è®€ï¼Œé‚„é€²ä¸€æ­¥å»¶ä¼¸æˆ–ä¿®æ­£ä»–äººçš„æƒ³æ³•ï¼Œæ˜¯çŸ¥è­˜æ¼”åŒ–çš„é—œéµå‹•åŠ›ã€‚',
            cite: 'Scardamalia, M., & Bereiter, C. (2006). Knowledge building: Theory, pedagogy, and technology.'
        },
        'impact': {
            title: 'ç¤¾ç¾¤æ¨å‹•åŠ› (Community Impact)',
            theory: 'é€éç¤¾æœƒç¶²çµ¡åˆ†æ (SNA) ä¸­çš„ã€Œè¢«å¼•ç”¨æ•¸ (In-degree)ã€ï¼Œè¡¡é‡ä½ çš„æƒ³æ³•æ¿€ç™¼äº†å¤šå°‘å¾ŒçºŒè¨è«–ã€‚é«˜å½±éŸ¿åŠ›ä»£è¡¨ä½ çš„è§€é»å…·æœ‰å•Ÿç™¼æ€§ï¼Œèƒ½å¼•ç™¼ç¤¾ç¾¤çš„æ¼£æ¼ªæ•ˆæ‡‰ã€‚',
            cite: 'Oshima, J., et al. (2012). Knowledge building discourse explorer.'
        },
        'evolution': {
            title: 'æƒ³æ³•æ¼”åŒ– (Idea Evolution)',
            theory: 'çŸ¥è­˜æ˜¯ä¸æ–·ç™¼å±•çš„ã€‚æ­¤è»Œè·¡åœ–å±•ç¤ºä½ çš„æƒ³æ³•å¦‚ä½•éš¨æ™‚é–“ç¶“æ­·ã€Œæå• -> ä¿®æ­£ -> æ•´åˆã€çš„æ­·ç¨‹ï¼Œåæ˜ äº†ã€Œå»ºè¨­æ€§å°è©±ã€çš„å“è³ªã€‚',
            cite: 'Reimann, P. (2009). Time is precious: Variable-and event-centred approaches.'
        },
        'scaffold': {
            title: 'æ€è€ƒé·¹æ¶ (Scaffolds)',
            theory: 'é·¹æ¶ï¼ˆå¦‚ï¼šæˆ‘åŸæœ¬çš„æƒ³æ³•...ä½†æ–°çš„è­‰æ“šé¡¯ç¤º...ï¼‰æ˜¯æ”¯æŒé«˜éšæ€ç¶­çš„èªè¨€æ¨¡æ¿ï¼Œå¹«åŠ©å­¸ç”Ÿé€²è¡Œæ›´ç´°ç·»çš„è«–è­‰èˆ‡åæ€ã€‚',
            cite: 'Chen, B., et al. (2017). Two-level analysis of modes of inquiry.'
        },
        'radar': {
            title: 'çŸ¥è­˜äº”åŠ› (Competency Radar)',
            theory: 'ç¶œåˆè©•ä¼°å­¸ç”Ÿçš„å¤šç¶­åº¦èƒ½åŠ›ï¼šä¸»å‹•æ€§ã€ç¤¾æœƒæ€§ã€èªçŸ¥æ·±åº¦ç­‰ã€‚ç†æƒ³çš„çŸ¥è­˜å»ºæ§‹è€…æ‡‰åœ¨å„é¢å‘å‡è¡¡ç™¼å±•ã€‚',
            cite: 'Lai, K. W., & Law, N. (2006). Peer scaffolding of knowledge building.'
        },
        'lexical': {
            title: 'è©å½™æ·±åº¦ (Lexical Depth)',
            theory: 'è¿½è¹¤å­¸ç”Ÿå¾ä½¿ç”¨ã€Œæ—¥å¸¸èªè¨€ã€è½‰å‘ç²¾ç¢ºçš„ã€Œå­¸è¡“è¡“èªã€ï¼Œåæ˜ äº†æ¦‚å¿µç†è§£çš„æ·±åŒ–èˆ‡å°ˆæ¥­åŒ–éç¨‹ (Metadiscourse)ã€‚',
            cite: 'Resendes, M., et al. (2015). Group-level formative feedback and metadiscourse.'
        },
        'network': {
            title: 'ç¶²çµ¡ä½ç½® (Network Position)',
            theory: 'ä½ åœ¨ç¤¾ç¾¤ç¶²çµ¡ä¸­çš„ä½ç½®ï¼ˆå¦‚æ ¸å¿ƒã€æ©‹æ¢ã€é‚Šç·£ï¼‰ã€‚Broker (æ©‹æ¢) èƒ½é€£çµä¸åŒçš„å°åœ˜é«”ï¼Œä¿ƒé€²è·¨é ˜åŸŸçš„çŸ¥è­˜æµå‹•ï¼Œæ˜¯ç¤¾ç¾¤çŸ¥è­˜æ“´æ•£çš„é—œéµã€‚',
            cite: 'Wasserman, S., & Faust, K. (1994). Social network analysis.'
        },
        'diversity': {
            title: 'è§€é»å¤šæ¨£æ€§ (Idea Diversity)',
            theory: 'æ ¹æ“š KB åŸå‰‡ï¼Œè§€é»å¤šæ¨£æ€§æ˜¯çŸ¥è­˜é€²æ­¥çš„å¿…è¦æ¢ä»¶ã€‚æ­¤æŒ‡æ¨™è¡¡é‡å­¸ç”Ÿåƒèˆ‡ä¸åŒä¸»é¡Œè¨è«–çš„å»£åº¦ã€‚',
            cite: 'Scardamalia, M. (2002). Socio-cognitive dynamics of knowledge building.'
        },
        'path_length': {
            title: 'èªçŸ¥è·¯å¾‘é•·åº¦ (Path Length)',
            theory: 'è¡¡é‡è¨è«–ä¸²çš„å»¶çºŒæ·±åº¦ã€‚è¼ƒé•·çš„è·¯å¾‘é€šå¸¸ä»£è¡¨æ›´æŒçºŒã€æ›´æ·±å…¥çš„å”å•†èˆ‡çŸ¥è­˜æ”¹é€²éç¨‹ã€‚',
            cite: 'Zhang, J., et al. (2007). Sustaining knowledge building as a principle-based innovation.'
        }
    };

    // --- Modal Functions ---
    function openRefModal(key) {
        const data = refData[key] || { title: 'åˆ†æé …ç›®', theory: 'è³‡æ–™è¼‰å…¥ä¸­...', cite: '' };
        const modal = document.getElementById('refModal');
        
        document.getElementById('modalTitle').innerText = data.title;
        document.getElementById('modalTheory').innerText = data.theory;
        document.getElementById('modalRef').innerText = data.cite;

        let statusText = "ç›®å‰å°šç„¡è¶³å¤ æ•¸æ“šé€²è¡Œæ·±å…¥åˆ†æã€‚";
        let insightText = "å»ºè­°æŒçºŒåƒèˆ‡è¨è«–ä»¥ç´¯ç©æ•¸æ“šã€‚";
        const s = currentUserStats;

        if (s) {
            // Simplified logic for brevity, keeping existing structure
            if (key === 'initiator') {
                statusText = `é–‹å‰µåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.initiator}% (Top ${Math.max(1, 100-s.roleMetrics.initiator)}%)</strong>`;
                insightText = s.roleMetrics.initiator > 70 ? "ä½ éå¸¸å–„æ–¼é–‹å•Ÿæ–°çš„è¨è«–è©±é¡Œï¼Œæ˜¯ç¤¾ç¾¤çš„å¥½å¥‡å¿ƒå¼•æ“ï¼" : "è©¦è‘—å¤šç™¼è¡¨ä¸€äº›ã€Œæ–°å•é¡Œã€æˆ–ã€Œæ–°æƒ³æ³•ã€ä¾†æå‡æ­¤æŒ‡æ¨™ã€‚";
            } else if (key === 'builder') {
                statusText = `é€£çµåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.builder}% (Top ${Math.max(1, 100-s.roleMetrics.builder)}%)</strong>`;
                insightText = s.roleMetrics.builder > 70 ? "ä½ æ˜¯ç¤¾ç¾¤çš„é€£çµè€…ï¼Œå–„æ–¼å›æ‡‰ä»–äººï¼Œè®“å°è©±å»¶çºŒã€‚" : "å˜—è©¦å¤šä½¿ç”¨ã€Œå»¶ä¼¸ã€æˆ–ã€Œæ”¹é€²ã€åŠŸèƒ½å›æ‡‰åŒå­¸çš„ç­†è¨˜ã€‚";
            } else if (key === 'synthesizer') {
                statusText = `æ•´åˆåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.synthesizer}% (Top ${Math.max(1, 100-s.roleMetrics.synthesizer)}%)</strong>`;
                insightText = s.roleMetrics.synthesizer > 60 ? "ä½ å…·å‚™é«˜éšçš„æ•´åˆèƒ½åŠ›ï¼Œèƒ½å°‡åˆ†æ•£çš„è§€é»æ­¸ç´ç‚ºçµè«–ã€‚" : "æŒ‘æˆ°çœ‹çœ‹ä½¿ç”¨ã€Œæ˜‡è¯ (Rise-above)ã€æ¨™ç±¤ï¼Œè©¦è‘—ç¸½çµå¤§å®¶çš„è¨è«–ã€‚";
            } else if (key === 'sustainer') {
                statusText = `ç¶­è­·åŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.sustainer}% (Top ${Math.max(1, 100-s.roleMetrics.sustainer)}%)</strong>`;
                insightText = "é€™æ˜¯è¡¡é‡ä½ æŒçºŒåƒèˆ‡å’Œç¶­è­·è¨è«–ç†±åº¦çš„æŒ‡æ¨™ã€‚";
            }
            else if (key === 'created') {
                statusText = `ä½ å·²ç¶“è²¢ç»äº† <strong>${s.totalNotes} ç¯‡</strong>æƒ³æ³•ç­†è¨˜ã€‚`;
                insightText = s.totalNotes > 5 ? "ç™¼æ–‡é‡ç©©å®šï¼ä¸‹ä¸€æ­¥ï¼Œè©¦è‘—é—œæ³¨ã€Œå“è³ªã€ã€‚" : "ç™¼æ–‡é‡åä½ï¼Œå»ºè­°å¾ã€Œæå•ã€é–‹å§‹ã€‚";
            } else if (key === 'impact') {
                statusText = `ä½ çš„æƒ³æ³•å…±ç²å¾—äº† <strong>${s.repliedCount} æ¬¡</strong>å›è¦†ã€‚`;
                insightText = s.repliedCount > 2 ? "è§€é»å¼•ç™¼äº†å…±é³´ï¼è©¦è‘—å›æ‡‰é€™äº›å›é¥‹ã€‚" : "å›æ‡‰è¼ƒå°‘ï¼Œå»ºè­°åœ¨æ¨™é¡Œä¸­ä½¿ç”¨æ›´å…·å¸å¼•åŠ›çš„å•é¡Œã€‚";
            } else if (key === 'evolution') {
                statusText = `ç›®å‰è¿½è¹¤åˆ° <strong>${s.recentNotes.length} æ¢</strong>è¿‘æœŸæ€è€ƒè»Œè·¡ã€‚`;
                insightText = "é€™æ˜¯ä½ è¿‘æœŸæ€æƒ³æ¼”è®Šçš„å¿«ç…§ã€‚è‹¥åªçœ‹åˆ°ä¸€æ¢ï¼Œä»£è¡¨è¿‘æœŸåƒ…æœ‰ä¸€ç¯‡ç™¼æ–‡ã€‚";
            }
            else if (key === 'interaction_circle') {
                statusText = `åœ¨äº’å‹•åœˆä¸­ï¼Œä½ å·²ç¶“é€£çµäº† <strong>${s.networkSize || 0} ä½</strong>ä¸åŒçš„åŒå­¸ã€‚`;
                insightText = "å¦‚æœäº’å‹•åœˆåå‘å–®é‚Šï¼Œå˜—è©¦å›æ‡‰å¹³å¸¸è¼ƒå°‘äº¤æµçš„åŒå­¸ï¼Œæ“´å¤§ä½ çš„çŸ¥è­˜ç¶²çµ¡ã€‚";
            }
        }

        document.getElementById('modalStatus').innerHTML = statusText;
        document.getElementById('modalInsight').innerText = insightText;
        
        modal.style.display = "flex";
    }

    function closeModalDirect(event, modalId) {
        if (event.target == document.getElementById(modalId)) {
            document.getElementById(modalId).style.display = "none";
        }
    }

    // --- Core Cloud Logic ---
    function initApp() {
        // 1. Get AI Key - Hybrid Strategy
        const localKey = localStorage.getItem('kb_ai_key') || localStorage.getItem('gemini_api_key');
        const aiStatus = document.getElementById('ai-status-indicator');
        
        if (localKey) {
            aiKey = localKey;
            aiStatus.innerText = "Ready (Local)";
            aiStatus.className = "text-green-400 font-bold";
        }

        // Try Cloud Sync for Key
        SETTINGS_DOC.get().then(doc => {
            if(doc.exists && doc.data().gemini_api_key) {
                aiKey = doc.data().gemini_api_key;
                // Sync back to local
                localStorage.setItem('kb_ai_key', aiKey);
                
                aiStatus.innerText = "Ready"; // Cloud confirmed
                aiStatus.className = "text-green-400 font-bold";
            } else if (!localKey) {
                aiStatus.innerText = "No Key";
                aiStatus.className = "text-red-400 font-bold";
            }
        }).catch(err => {
            console.warn("Cloud key fetch failed", err);
            if (!localKey) {
                aiStatus.innerText = "Offline";
                aiStatus.className = "text-yellow-400 font-bold";
            }
        });

        // 2. Listen to Class Data
        db.collection(DB_COLLECTION).doc(DB_DOC).onSnapshot((doc) => {
            const dbStatus = document.getElementById('db-status-text');
            if (doc.exists) {
                globalData = doc.data();
                dbStatus.innerText = "FIREBASE ONLINE";
                dbStatus.className = "text-green-400 font-bold";
                
                if (!document.getElementById('student-selector')) {
                    initUserSwitcher();
                } else if (currentUserId) {
                    switchUser(currentUserId);
                }
            } else {
                dbStatus.innerText = "NO DATA";
                dbStatus.className = "text-red-400 font-bold";
            }
        });
    }

    function initUserSwitcher() {
        const container = document.getElementById('nav-user-select-container');
        if (!container) return;
        container.innerHTML = ''; 
        
        const select = document.createElement('select');
        select.className = "bg-indigo-700 text-white text-xs border border-indigo-500 rounded px-2 py-1 outline-none";
        select.id = "student-selector";
        
        const users = Object.values(globalData.userList || {});
        const students = users.filter(u => u.role !== 'teacher');

        if (students.length === 0) {
            select.innerHTML = '<option>ç„¡å­¸ç”Ÿè³‡æ–™</option>';
        } else {
            students.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.text = u.name;
                select.appendChild(option);
            });
        }
        select.onchange = function() { switchUser(this.value); };
        container.appendChild(select);

        let targetId = students.length > 0 ? students[0].id : null;
        const localSession = localStorage.getItem('kb_local_session');
        if (localSession) {
            try {
                const s = JSON.parse(localSession);
                const u = students.find(st => st.id === globalData.userList[s.currentUserKey]?.id);
                if (u) targetId = u.id;
            } catch(e) {}
        }
        
        if (targetId) {
            select.value = targetId;
            switchUser(targetId);
        }
    }

    // Role Metrics Logic
    function calculateRoleMetrics(stats) {
        const initScore = Math.min((stats.scaffoldCounts.question * 20), 100); 
        const buildScore = Math.min(((stats.scaffoldCounts.extend + stats.scaffoldCounts.improve + stats.linksCount) * 15), 100);
        const synthScore = Math.min((stats.scaffoldCounts.riseabove * 50), 100);
        const susScore = Math.min((stats.totalNotes * 10), 100);

        return {
            initiator: Math.floor(initScore),
            builder: Math.floor(buildScore),
            synthesizer: Math.floor(synthScore),
            sustainer: Math.floor(susScore)
        };
    }

    function analyzeStudentData(userId) {
        if (!globalData || !globalData.nodes) return null;
        const nodes = globalData.nodes || [];
        const myNotes = nodes.filter(n => n.author === userId);
        const myNoteIds = myNotes.map(n => n.id);
        
        // Impact
        let repliedCount = 0;
        nodes.forEach(n => {
            if (n.parentId && myNoteIds.includes(n.parentId) && n.author !== userId) repliedCount++;
        });

        // Scaffolds
        const scaffoldCounts = { 'question': 0, 'extend': 0, 'improve': 0, 'counter': 0, 'riseabove': 0 };
        myNotes.forEach(n => { if (scaffoldCounts[n.type] !== undefined) scaffoldCounts[n.type]++; });

        const linksCount = myNotes.filter(n => n.parentId).length; 
        const uniqueTopics = new Set(myNotes.map(n => n.topicId)).size;
        const avgDepth = linksCount > 0 ? (linksCount / myNotes.length) * 2 + 1 : 1; 

        // Role Metrics
        const tempStats = { scaffoldCounts, linksCount, totalNotes: myNotes.length };
        const roleMetrics = calculateRoleMetrics(tempStats);

        // ğŸ”¥ [FIXED] Robust Date Sort Logic (Handles mixed Timestamp/String formats)
        const sortedNotes = myNotes.sort((a,b) => {
            const da = new Date(a.date).getTime();
            const db = new Date(b.date).getTime();
            return db - da; // Descending (Newest first)
        });

        // Network Size Calculation for Ref Modal
        const interactants = new Set();
        nodes.forEach(n => {
            if(n.parentId) {
                const parent = nodes.find(p => p.id === n.parentId);
                if(parent) {
                    if(n.author === userId && parent.author !== userId) interactants.add(parent.author);
                    if(parent.author === userId && n.author !== userId) interactants.add(n.author);
                }
            }
        });

        return {
            totalNotes: myNotes.length,
            repliedCount: repliedCount,
            linksCount: linksCount,
            scaffoldCounts: scaffoldCounts,
            recentNotes: sortedNotes.slice(0, 20), // ğŸ”¥ [MODIFIED] Increased slice from 5 to 20
            roleMetrics: roleMetrics,
            uniqueTopicsCount: uniqueTopics,
            avgDepth: avgDepth,
            networkSize: interactants.size
        };
    }

    function switchUser(userId) {
        currentUserId = userId;
        const user = Object.values(globalData.userList).find(u => u.id === userId);
        if (!user) return;

        // Update Header
        document.getElementById('current-user-avatar').src = user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=random`;
        document.getElementById('user-name').innerText = user.name;
        document.getElementById('user-avatar-large').innerText = user.name[0];

        // Analyze
        const stats = analyzeStudentData(userId);
        currentUserStats = stats; // Save for Ref Modal

        // Update Dynamic Role UI
        document.getElementById('role-initiator-val').innerText = `${stats.roleMetrics.initiator}%`;
        document.getElementById('role-initiator-bar').style.width = `${stats.roleMetrics.initiator}%`;
        
        document.getElementById('role-builder-val').innerText = `${stats.roleMetrics.builder}%`;
        document.getElementById('role-builder-bar').style.width = `${stats.roleMetrics.builder}%`;
        
        document.getElementById('role-synthesizer-val').innerText = `${stats.roleMetrics.synthesizer}%`;
        document.getElementById('role-synthesizer-bar').style.width = `${stats.roleMetrics.synthesizer}%`;
        
        document.getElementById('role-sustainer-val').innerText = `${stats.roleMetrics.sustainer}%`;
        document.getElementById('role-sustainer-bar').style.width = `${stats.roleMetrics.sustainer}%`;

        // Update Role Title
        const metrics = stats.roleMetrics;
        let bestRole = 'æ¢ç´¢è€…';
        let roleSub = "The Knowledge Explorer";
        let bestScore = -1;
        
        if (metrics.initiator > bestScore) { bestScore = metrics.initiator; bestRole = 'é–‹å‰µè€…'; roleSub = 'The Initiator'; }
        if (metrics.builder > bestScore) { bestScore = metrics.builder; bestRole = 'é€£çµè€…'; roleSub = 'The Builder'; }
        if (metrics.synthesizer > bestScore) { bestScore = metrics.synthesizer; bestRole = 'æ•´åˆè€…'; roleSub = 'The Synthesizer'; }
        if (metrics.sustainer > bestScore) { bestScore = metrics.sustainer; bestRole = 'ç¶­è­·è€…'; roleSub = 'The Sustainer'; }
        if (stats.totalNotes === 0) { bestRole = 'æ–°æ‰‹'; roleSub = 'The Newcomer'; }

        document.getElementById('role-title').innerText = bestRole;
        document.getElementById('role-subtitle').innerText = roleSub;
        document.getElementById('role-desc').innerHTML = `<i class="fas fa-quote-left text-indigo-300 mr-1"></i> æ ¹æ“šåˆ†æï¼Œä½ åœ¨ã€Œ${bestRole}ã€æ–¹é¢è¡¨ç¾æœ€ç‚ºçªå‡ºã€‚`;

        // Update Indicators
        document.getElementById('topic-count-val').innerText = stats.uniqueTopicsCount;
        document.getElementById('topic-diversity-bar').style.width = `${Math.min(stats.uniqueTopicsCount * 20, 100)}%`;
        document.getElementById('avg-depth-val').innerText = stats.avgDepth.toFixed(1);
        document.getElementById('avg-depth-bar').style.width = `${Math.min(stats.avgDepth * 20, 100)}%`;

        // Update Network Role
        let netRole = "å‘¨é‚Šåƒèˆ‡è€… (Peripheral)";
        if (metrics.builder > 70 || stats.repliedCount > 5) netRole = "æ ¸å¿ƒäººç‰© (Central)";
        else if (metrics.builder > 40 || stats.linksCount > 3) netRole = "æ©‹æ¨‘è€… (Broker)";
        // document.getElementById('network-role-label').innerText = netRole; // Removed in this view

        // Render Numbers
        animateValue("card-created-val", 0, stats.totalNotes, 800);
        animateValue("card-read-val", 0, Math.floor(stats.totalNotes * 5.5 + 10), 800);
        animateValue("card-buildon-val", 0, stats.linksCount, 800);
        animateValue("card-impact-val", 0, stats.repliedCount, 800);

        // Render Visuals
        renderTimeline(stats.recentNotes, globalData.nodes);
        renderScaffoldBars(stats.scaffoldCounts);
        
        const s_init = Math.min((stats.scaffoldCounts['question'] * 10) + 20, 100);
        const s_build = Math.min((stats.linksCount * 8) + 20, 100);
        const s_read = 75; // Mock
        const s_vocab = Math.min((stats.totalNotes * 5) + 30, 90);
        const s_impact = Math.min((stats.repliedCount * 15) + 10, 100);
        renderRadarChart([s_init, s_build, s_read, s_vocab, s_impact], user.name);
        
        // ğŸ”¥ Render Ego Network
        renderEgoNetwork(userId);
        
        // ğŸ”¥ [ADDED] Determine Epistemic Fingerprint
        let fingerprintType = "ç¤¾ç¾¤é€£çµå‹"; // Default
        let fingerprintDesc = "ä½ å–„æ–¼åœ¨ç¤¾ç¾¤ä¸­å»ºç«‹é€£çµï¼Œä¿ƒé€²å°è©±æµå‹•ã€‚";
        
        if (metrics.synthesizer > 60 || stats.scaffoldCounts.riseabove > 1) {
            fingerprintType = "ç†è«–å»ºæ§‹å‹";
            fingerprintDesc = "ä½ å‚¾å‘æ–¼æ•´åˆè§€é»ï¼Œæ§‹å»ºæ›´é«˜å±¤æ¬¡çš„è§£é‡‹æ¨¡å‹ã€‚";
        } else if (metrics.initiator > 60) {
            fingerprintType = "æ‰¹åˆ¤æ€è€ƒå‹";
            fingerprintDesc = "ä½ å–„æ–¼æå‡ºé—œéµå•é¡Œï¼ŒæŒ‘æˆ°æ—¢æœ‰è§€é»ï¼Œæ¿€ç™¼æ·±å±¤æ€è€ƒã€‚";
        } else if (metrics.sustainer > 60) {
            fingerprintType = "æŒçºŒæ¢ç©¶å‹";
            fingerprintDesc = "ä½ å±•ç¾äº†é«˜åº¦çš„æŒçºŒåŠ›ï¼Œç¶­è­·äº†ç¤¾ç¾¤çš„çŸ¥è­˜å‹•èƒ½ã€‚";
        }

        document.getElementById('radar-decision-text').innerHTML = `
            <div class="font-bold text-indigo-600 mb-1"><i class="fas fa-fingerprint"></i> ${fingerprintType}</div>
            ${fingerprintDesc}
        `;

        // Reset AI
        document.getElementById('ai-feedback').innerHTML = '<p class="text-slate-400 italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä»¥ç²å– AI å»ºè­°...</p>';
    }

    // New: Render Ego Network
    function renderEgoNetwork(userId) {
        const container = document.getElementById('ego-network-container');
        if(!container) return;
        
        const nodes = globalData.nodes || [];
        const users = globalData.userList || {};
        
        // Colors mapping
        const typeColors = { 
            question: '#3b82f6', // Blue
            extend: '#eab308',   // Yellow
            improve: '#22c55e',  // Green
            counter: '#ef4444',  // Red
            riseabove: '#a855f7' // Purple
        };

        const interactants = new Set();
        interactants.add(userId);
        
        const edges = [];
        
        nodes.forEach(n => {
            if(n.parentId) {
                const p = nodes.find(x => x.id === n.parentId);
                if(p) {
                    if (n.author === userId && p.author !== userId) {
                        interactants.add(p.author);
                        edges.push({ from: userId, to: p.author, color: {color: typeColors[n.type] || '#cbd5e1'}, arrows: 'to' });
                    }
                    if (p.author === userId && n.author !== userId) {
                        interactants.add(n.author);
                        edges.push({ from: n.author, to: userId, color: {color: typeColors[n.type] || '#cbd5e1'}, arrows: 'to' });
                    }
                }
            }
        });

        const visNodes = Array.from(interactants).map(id => {
            const u = Object.values(users).find(usr => usr.id === id);
            const isMe = id === userId;
            return {
                id: id,
                label: u ? u.name : id,
                shape: 'dot',
                size: isMe ? 30 : 20,
                color: isMe ? '#4f46e5' : '#94a3b8',
                font: { color: '#1e293b' }
            };
        });

        if(egoNetworkInstance) { egoNetworkInstance.destroy(); egoNetworkInstance = null; }
        
        const data = { nodes: visNodes, edges: edges };
        const options = {
            nodes: { borderWidth: 2, borderWidthSelected: 4 },
            physics: { stabilization: true, barnesHut: { gravitationalConstant: -2000 } }
        };
        
        if (visNodes.length <= 1) {
            container.innerHTML = '<div class="flex h-full items-center justify-center text-slate-400 text-xs">å°šç„¡äº’å‹•ç´€éŒ„</div>';
        } else {
            container.innerHTML = ''; // Clear empty msg
            egoNetworkInstance = new vis.Network(container, data, options);
        }
    }

    function syncData() {
        const btn = document.getElementById('sync-btn');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';
        setTimeout(() => {
            if(currentUserId) switchUser(currentUserId);
            btn.innerHTML = orgHtml;
        }, 500);
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function renderTimeline(notes, dbNodes) {
        const container = document.getElementById('evolution-timeline');
        container.innerHTML = ''; 
        if (notes.length === 0) { container.innerHTML = '<div class="text-center py-10 text-slate-400">å°šç„¡æ´»å‹•ç´€éŒ„</div>'; return; }
        
        const line = document.createElement('div');
        line.className = 'evolution-line';
        container.appendChild(line);

        notes.forEach(note => {
            let typeColor = 'bg-slate-200'; let typeIcon = 'fa-comment';
            if (note.type === 'question') { typeColor = 'bg-blue-100 text-blue-600'; typeIcon = 'fa-question'; }
            if (note.type === 'improve') { typeColor = 'bg-green-100 text-green-600'; typeIcon = 'fa-arrow-up'; }
            if (note.type === 'riseabove') { typeColor = 'bg-purple-100 text-purple-600'; typeIcon = 'fa-layer-group'; }
            
            let contextHtml = '';
            if (note.parentId) {
                const parent = dbNodes.find(n => n.id === note.parentId);
                if (parent) contextHtml = `<div class="text-xs text-slate-400 mb-1 pl-2 border-l-2 border-slate-200">å›æ‡‰: ${parent.title}</div>`;
            }

            const html = `
                <div class="relative flex gap-4 mb-6 evolution-node group evolution-item">
                    <div class="w-10 h-10 rounded-full ${typeColor} flex items-center justify-center shadow-sm border-2 border-white flex-shrink-0 z-10"><i class="fas ${typeIcon}"></i></div>
                    <div class="flex-1 bg-white p-3 rounded-lg border border-slate-100 shadow-sm hover:shadow-md transition cursor-pointer" onclick="viewNoteDetail('${note.id}')">
                        <div class="flex justify-between items-start"><h4 class="font-bold text-slate-700 text-sm mb-1">${note.title || 'ç„¡æ¨™é¡Œ'}</h4><span class="text-[10px] text-slate-400">${new Date(note.date).toLocaleDateString()}</span></div>
                        ${contextHtml}
                        <p class="text-xs text-slate-600 line-clamp-2">${note.content}</p>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // New: View Note Detail
    function viewNoteDetail(noteId) {
        const note = globalData.nodes.find(n => n.id === noteId);
        if(!note) return;
        
        document.getElementById('nd-title').innerText = note.title || 'ç„¡æ¨™é¡Œ';
        document.getElementById('nd-content').innerText = note.content;
        document.getElementById('nd-date').innerText = new Date(note.date).toLocaleString();
        document.getElementById('nd-type').innerText = note.type.toUpperCase();
        
        const author = Object.values(globalData.userList).find(u => u.id === note.author);
        document.getElementById('nd-author').innerText = author ? author.name : note.author;
        
        document.getElementById('note-detail-modal').style.display = "flex";
    }

    function renderScaffoldBars(counts) {
        const container = document.getElementById('scaffold-bars');
        container.innerHTML = '';
        const max = Math.max(...Object.values(counts), 1);
        const types = ['question', 'extend', 'improve', 'counter', 'riseabove'];
        const colors = ['bg-blue-500', 'bg-yellow-400', 'bg-green-500', 'bg-red-500', 'bg-purple-500'];
        types.forEach((t, i) => {
            const val = counts[t];
            const h = Math.max((val / max) * 100, 10);
            const bar = document.createElement('div');
            bar.className = `flex-1 ${colors[i]} rounded-t-md relative group transition-all duration-500 hover:opacity-80`;
            bar.style.height = `${h}%`;
            bar.innerHTML = `<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-600 opacity-0 group-hover:opacity-100 transition">${val}</div>`;
            container.appendChild(bar);
        });
    }

    function renderRadarChart(dataValues, userName) {
        const ctx = document.getElementById('studentRadarChart').getContext('2d');
        if (radarChartInstance) radarChartInstance.destroy();
        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ç™¼æ–‡æ•¸é‡', 'å›è¦† (Build-on)', 'é–±è®€å»£åº¦', 'è©å½™æ·±åº¦', 'è¢«å¼•ç”¨æ•¸'],
                datasets: [{
                    label: userName,
                    data: dataValues,
                    fill: true,
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: 'rgb(79, 70, 229)',
                    pointBackgroundColor: 'rgb(79, 70, 229)',
                    pointBorderColor: '#fff'
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { r: { ticks: { display: false }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 11 } } } }, 
                plugins: { legend: { position: 'bottom' } } 
            }
        });
    }

    // ğŸ”¥ [AI LOGIC] - Updated to accept mode
    async function triggerAIAnalysis(mode = 'advice') {
        const btnSelector = mode === 'advice' ? 
            'button[onclick="triggerAIAnalysis(\'advice\')"]' : 
            'button[onclick="triggerAIAnalysis(\'portfolio\')"]';
        const btn = document.querySelector(btnSelector) || document.querySelector('button[onclick="triggerAIAnalysis()"]'); // Fallback
        const feedbackContainer = document.getElementById('ai-feedback');
        
        // Robust Key Check
        if (!aiKey) { 
             aiKey = localStorage.getItem('kb_ai_key');
        }
        
        if (!aiKey) {
            // Prompt user
            const input = prompt("ç³»çµ±å°šæœªåµæ¸¬åˆ° API Keyï¼Œè«‹è¼¸å…¥æ‚¨çš„ Gemini API Key ä»¥ç¹¼çºŒï¼š");
            if (input && input.trim() !== "") {
                aiKey = input.trim();
                localStorage.setItem('kb_ai_key', aiKey); // Save locally for session
                document.getElementById('ai-status-indicator').innerText = "Ready (Manual)";
            } else {
                alert("æœªè¼¸å…¥ API Keyï¼Œç„¡æ³•å•Ÿå‹• AI å°å¸«ã€‚");
                return;
            }
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...';
        
        // Prepare Context
        const s = currentUserStats;
        let promptText = "";
        
        // ğŸ”¥ [OPTIMIZED] Pruned context for speed
        const contextSummary = `è§’è‰²:${document.getElementById('role-title').innerText}ã€‚ç™¼æ–‡:${s.totalNotes},å›è¦†:${s.linksCount},è¢«å¼•:${s.repliedCount}ã€‚é·¹æ¶:${s.scaffoldCounts.question}/${s.scaffoldCounts.extend}/${s.scaffoldCounts.improve}/${s.scaffoldCounts.riseabove}ã€‚`;

        if (mode === 'advice') {
            promptText = `æ ¹æ“šæ•¸æ“šï¼š${contextSummary} çµ¦äºˆè©²å­¸ç”Ÿ3é»å…·é«”çš„çŸ¥è­˜å»ºæ§‹æ”¹é€²å»ºè­° (ç¹é«”ä¸­æ–‡ï¼Œèªæ°£é¼“å‹µï¼Œé™150å­—å…§)ã€‚`;
        } else {
            // Portfolio Mode
            promptText = `æ ¹æ“šæ•¸æ“šï¼š${contextSummary} ç‚ºå­¸ç”Ÿæ’°å¯«ä¸€ä»½ã€Œå­¸ç¿’æ­·ç¨‹æª”æ¡ˆã€çš„è‡ªæˆ‘åæ€è‰ç¨¿ (Reflection Draft)ã€‚ç¬¬ä¸€äººç¨±ï¼Œå­¸è¡“ä¸”çœŸèª ï¼Œå¼·èª¿ã€Œè§€é»æ¼”è®Šã€èˆ‡ã€Œè²¢ç»ã€ã€‚é™200å­—å…§ã€‚`;
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${aiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });
            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            feedbackContainer.innerHTML = marked.parse(aiText);
        } catch (e) {
            console.error(e);
            feedbackContainer.innerHTML = '<span class="text-red-500">AI åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</span>';
        }
        
        btn.disabled = false;
        btn.innerHTML = originalText;
    }

    // --- Init ---
    window.onload = function() {
        // Global Keydown Listener for ESC
        window.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                document.getElementById('refModal').style.display = "none";
                document.getElementById('note-detail-modal').style.display = "none";
            }
        });

        initApp();
        
        // Setup chart defaults
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
    };
    </script>
</body>
</html>
