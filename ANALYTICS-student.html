<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„çŸ¥è­˜ç¾…ç›¤ | My KB Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .kb-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; font-weight: 600; }
        
        /* æƒ³æ³•æ¼”åŒ–è»Œè·¡çš„é€£ç·šæ¨£å¼ */
        .evolution-line {
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        .evolution-item:last-child .evolution-line { display: none; }
        
        /* ç¤¾ç¾¤æ¨å‹•åŠ›çš„æ¼£æ¼ªå‹•ç•«æ•ˆæœ */
        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(96, 165, 250, 0); }
        }
        .ripple-effect {
            animation: ripple 2s infinite;
        }
        
        /* ç¶²çµ¡ç¯€é»å‹•ç•« */
        @keyframes pulse-node {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .node-pulse { animation: pulse-node 2s infinite ease-in-out; }

        /* ç°¡å–®çš„æ·¡å…¥å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* èªªæ˜æ–‡å­—å€å¡Šæ¨£å¼ */
        .insight-box {
            background-color: #f8fafc;
            border-left: 3px solid #cbd5e1;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* text-slate-500 */
            line-height: 1.4;
        }
        .insight-title {
            font-weight: 700;
            color: #475569;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        .insight-title i { margin-right: 0.25rem; }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(2px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFadeIn 0.3s;
        }
        @keyframes modalFadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Ref Button Style */
        .ref-btn {
            color: #9ca3af; /* text-gray-400 */
            background-color: #f3f4f6; /* bg-gray-100 */
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem; /* text-xs */
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            margin-left: 0.5rem;
            cursor: pointer;
        }
        .ref-btn:hover {
            color: #4f46e5; /* text-indigo-600 */
            background-color: #e0e7ff; /* bg-indigo-50 */
        }
        /* Dark mode compatible ref button for Community Impact card */
        .ref-btn-dark {
            color: #94a3b8; /* text-slate-400 */
            background-color: rgba(255,255,255,0.1);
        }
        .ref-btn-dark:hover {
            color: white;
            background-color: rgba(255,255,255,0.2);
        }
        
        /* New: Tiny Ref Button for Role Cards */
        .ref-btn-mini {
             position: absolute;
             top: 4px;
             right: 4px;
             font-size: 0.65rem;
             padding: 2px 6px;
             color: #cbd5e1;
             background: transparent;
             cursor: pointer;
        }
        .ref-btn-mini:hover {
            color: #6366f1;
            background: #f1f5f9;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-indigo-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-compass text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold">çŸ¥è­˜ç¾…ç›¤ Knowledge Compass</h1>
                    <p class="text-xs text-indigo-200">å¾Œè¨­èªçŸ¥èˆ‡æˆé•·æ­·ç¨‹ (Student Portfolio)</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center gap-3 mr-4">
                    <a href="index.html" class="nav-btn bg-indigo-700 hover:bg-indigo-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-indigo-500">
                        <i class="fas fa-home"></i> <span>é¦–é </span>
                    </a>
                    <a href="Knowledge Building Forum.html" class="nav-btn bg-indigo-700 hover:bg-indigo-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-indigo-500">
                        <i class="fas fa-comments"></i> <span>è«–å£‡</span>
                    </a>
                    <button onclick="syncData()" id="sync-btn" class="nav-btn bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 border border-emerald-500">
                        <i class="fas fa-sync-alt"></i> <span>åˆ·æ–°</span>
                    </button>
                </div>
                <div class="text-right hidden md:block">
                    <span class="block font-bold" id="user-name">è¨ªå®¢</span>
                    <span class="text-xs text-indigo-200">å­¸ç¿’è€…</span>
                </div>
                <img id="current-user-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full border-2 border-white">
                <div id="nav-user-select-container"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="container mx-auto px-6 py-8 space-y-8 fade-in">

        <!-- ========================================== -->
        <!-- æ¨¡çµ„ 1: ä½¿ç”¨è€…çŸ¥è­˜è§’è‰² -->
        <!-- ========================================== -->
        <section class="card bg-gradient-to-r from-white to-blue-50 border border-blue-100 relative overflow-hidden">
             <!-- èƒŒæ™¯è£é£¾ -->
             <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-blue-100 rounded-full opacity-50 blur-2xl"></div>

             <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                 <!-- å·¦å´ï¼šè§’è‰²ç¨±è™Ÿ -->
                 <div class="w-full md:w-1/3 text-center md:text-left md:border-r border-gray-200 md:pr-8">
                     <div class="flex items-center justify-center md:justify-start mb-3">
                        <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">
                            <i class="fas fa-user-tag mr-1"></i> æˆ‘çš„çŸ¥è­˜è§’è‰²
                        </h2>
                        <button onclick="openRefModal('roles')" class="ref-btn" title="äº†è§£è§’è‰²å®šç¾©">
                            <i class="fas fa-info-circle mr-1"></i> Ref.
                        </button>
                     </div>
                     <div class="flex items-center justify-center md:justify-start gap-5">
                         <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white text-3xl shadow-xl ripple-effect">
                             <div id="user-avatar-large" class="text-2xl font-bold">?</div>
                         </div>
                         <div>
                             <h3 class="text-2xl font-bold text-indigo-900" id="role-title">æ¢ç´¢è€…</h3>
                             <p class="text-sm text-indigo-600 font-medium" id="role-subtitle">The Knowledge Explorer</p>
                         </div>
                     </div>
                     <div class="mt-4 bg-white/60 p-3 rounded-lg text-sm text-gray-600 leading-relaxed border border-white" id="role-desc">
                         <i class="fas fa-quote-left text-indigo-300 mr-1"></i>
                         æ­£åœ¨åˆ†æä½ çš„ç™¼è¨€æ¨¡å¼...
                     </div>
                 </div>
                 
                 <!-- å³å´ï¼šå››ç¨®èƒ½åŠ›æŒ‡æ¨™ (Dynamic) -->
                 <div class="w-full md:w-2/3">
                     <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                         <!-- èƒ½åŠ› 1: é–‹å‰µåŠ› -->
                         <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('initiator')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-xs mb-1">é–‹å‰µåŠ› (Initiator)</div>
                             <div class="text-lg font-bold text-gray-800" id="role-initiator-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                                 <div class="bg-blue-400 h-1.5 rounded-full" id="role-initiator-bar" style="width: 0%"></div>
                             </div>
                         </div>
                         <!-- èƒ½åŠ› 2: é€£çµåŠ› -->
                         <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('builder')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-xs mb-1">é€£çµåŠ› (Builder)</div>
                             <div class="text-lg font-bold text-gray-800" id="role-builder-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                                 <div class="bg-indigo-600 h-1.5 rounded-full" id="role-builder-bar" style="width: 0%"></div>
                             </div>
                         </div>
                         <!-- èƒ½åŠ› 3: æ•´åˆåŠ› -->
                         <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('synthesizer')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-xs mb-1">æ•´åˆåŠ› (Synthesizer)</div>
                             <div class="text-lg font-bold text-gray-800" id="role-synthesizer-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                                 <div class="bg-purple-400 h-1.5 rounded-full" id="role-synthesizer-bar" style="width: 0%"></div>
                             </div>
                         </div>
                         <!-- èƒ½åŠ› 4: ç¶­è­·åŠ› -->
                         <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition relative">
                             <button onclick="openRefModal('sustainer')" class="ref-btn-mini"><i class="fas fa-info-circle"></i></button>
                             <div class="text-gray-400 text-xs mb-1">ç¶­è­·åŠ› (Sustainer)</div>
                             <div class="text-lg font-bold text-gray-800" id="role-sustainer-val">--%</div>
                             <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                                 <div class="bg-green-400 h-1.5 rounded-full" id="role-sustainer-bar" style="width: 0%"></div>
                             </div>
                         </div>
                     </div>
                     <!-- èªªæ˜ -->
                     <div class="insight-box bg-white/50 border-blue-200 mt-4">
                         <div class="insight-title text-blue-800"><i class="fas fa-info-circle"></i> è§’è‰²åˆ†æèªªæ˜</div>
                         é€™äº›æŒ‡æ¨™åæ˜ äº†ä½ åœ¨ç¤¾ç¾¤ä¸­çš„å‹•æ…‹è²¢ç»ã€‚æ•¸å€¼æ˜¯æ ¹æ“šä½ ç›¸å°æ–¼å…¨ç­å¹³å‡çš„è¡¨ç¾è¨ˆç®—å¾—å‡ºçš„ç›¸å°å¼·åº¦ (0-100%)ã€‚æ¯å€‹è§’è‰²å°æ–¼çŸ¥è­˜å»ºæ§‹éƒ½ä¸å¯æˆ–ç¼ºã€‚
                     </div>
                 </div>
             </div>
        </section>

        <!-- 2. æ ¸å¿ƒæ•¸æ“šæ¦‚è¦½ (Core Metrics) WITH REF BUTTONS -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Card 1 -->
            <div class="card border-l-4 border-blue-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('created')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-xs font-medium uppercase">æˆ‘çš„è²¢ç» (Created)</h3>
                <div class="mt-1 flex items-baseline">
                     <span class="text-2xl font-bold text-gray-900" id="card-created-val">0</span>
                     <span class="ml-2 text-xs text-green-600 font-bold" id="stat-created-trend"></span>
                </div>
            </div>
            
            <!-- Card 2 -->
            <div class="card border-l-4 border-green-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('read')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-xs font-medium uppercase">é–±è®€ä»–äºº (Read)</h3>
                <div class="mt-1 text-2xl font-bold text-gray-900" id="card-read-val">0</div>
            </div>
            
            <!-- Card 3 -->
            <div class="card border-l-4 border-purple-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('buildon')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-xs font-medium uppercase">è§€é»é€£çµ (Build-ons)</h3>
                <div class="mt-1 text-2xl font-bold text-gray-900" id="card-buildon-val">0</div>
            </div>
            
            <!-- Card 4 -->
            <div class="card border-l-4 border-yellow-500 py-4 group hover:shadow-lg transition relative">
                <button onclick="openRefModal('impact')" class="absolute top-2 right-2 ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                <h3 class="text-gray-500 text-xs font-medium uppercase">å½±éŸ¿ä¿‚æ•¸ (Impact)</h3>
                <div class="mt-1 text-2xl font-bold text-gray-900" id="card-impact-val">0</div>
            </div>
        </section>

        <!-- 3. åœ–è¡¨åˆ†æå€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šKB è¡Œç‚ºé›·é” -->
            <div class="card col-span-1 lg:col-span-1 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-chart-radar text-indigo-500 mr-2"></i> çŸ¥è­˜äº”åŠ›åˆ†æ</h3>
                    <button onclick="openRefModal('radar')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="flex-1 min-h-[250px] relative">
                    <canvas id="studentRadarChart"></canvas>
                </div>
            </div>

            <!-- å³å´ï¼šæœ€è¿‘çš„æƒ³æ³•æ¼”åŒ– (Timeline) -->
            <div class="card col-span-1 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-code-branch text-emerald-500 mr-2"></i> æœ€è¿‘çš„æ€è€ƒè»Œè·¡</h3>
                    <div class="flex items-center gap-2">
                         <a href="Knowledge Building Forum.html" class="text-xs text-indigo-600 hover:underline font-bold mr-2">å»è«–å£‡å›æ‡‰ ></a>
                         <button onclick="openRefModal('evolution')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                    </div>
                </div>
                <div class="relative pl-4 space-y-0" id="evolution-timeline">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>
        </div>

        <!-- 4. é·¹æ¶èˆ‡ AI å»ºè­° -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-tools text-orange-500 mr-2"></i> æ€è€ƒé·¹æ¶åå¥½</h3>
                    <button onclick="openRefModal('scaffold')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="flex items-end gap-2 h-40" id="scaffold-bars"></div>
                <div class="flex justify-between text-xs text-slate-500 mt-2 px-1">
                    <span>æå•</span><span>å»¶ä¼¸</span><span>æ”¹é€²</span><span>åé§</span><span>æ˜‡è¯</span>
                </div>
            </div>

            <div class="card border-l-4 border-indigo-500 bg-indigo-50/50">
                <h3 class="font-bold text-indigo-900 mb-3 flex items-center"><i class="fas fa-robot text-indigo-600 mr-2"></i> ä¾†è‡ª AI å°å¸«çš„å»ºè­°</h3>
                <div id="ai-feedback" class="text-sm text-slate-700 space-y-2 leading-relaxed">
                    <p><i class="fas fa-circle-notch fa-spin text-indigo-400 mr-2"></i> æ­£åœ¨åˆ†æä½ çš„å­¸ç¿’æ­·ç¨‹...</p>
                </div>
                <div class="mt-4 text-right">
                    <button class="text-xs bg-white border border-indigo-200 px-3 py-1 rounded-full text-indigo-600 hover:bg-indigo-50 transition font-bold" onclick="refreshAIFeedback()">
                        <i class="fas fa-magic mr-1"></i> æ›´æ–°å»ºè­°
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 5. é€²éšæŒ‡æ¨™ (New Sections based on requests) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- è©å½™æ¼”åŒ– -->
            <div class="card relative overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-spell-check text-purple-600 mr-2"></i>èªç¾©èˆ‡è©å½™æ·±åº¦</h2>
                    <button onclick="openRefModal('lexical')" class="ref-btn"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="space-y-6">
                    <div class="flex justify-between items-center relative">
                        <div class="text-center w-1/3 opacity-60">
                            <div class="text-xs text-gray-500 font-bold mb-2">åˆå§‹éšæ®µ (Initial)</div>
                            <div class="space-y-1 text-sm text-gray-400">
                                <div><i class="fas fa-comment mr-1"></i> æˆ‘è¦ºå¾—...</div>
                                <div><i class="fas fa-comment mr-1"></i> å¥½åƒæ˜¯...</div>
                            </div>
                        </div>
                        <div class="text-center text-purple-300"><i class="fas fa-long-arrow-alt-right text-3xl"></i></div>
                        <div class="text-center w-1/3">
                            <div class="text-xs text-purple-600 font-bold mb-2">ç•¶å‰éšæ®µ (Current)</div>
                            <div class="space-y-1 text-sm font-bold text-purple-800">
                                <div><i class="fas fa-check mr-1"></i> ç†è«–é¡¯ç¤º...</div>
                                <div><i class="fas fa-check mr-1"></i> è­‰æ“šæ”¯æŒ...</div>
                            </div>
                        </div>
                    </div>
                    <div class="insight-box bg-purple-50 border-purple-200 text-purple-900">
                         <div class="insight-title text-purple-800"><i class="fas fa-book"></i> å­¸è¡“è©å½™åˆ†æ</div>
                         æ­¤æŒ‡æ¨™è¿½è¹¤ä½ å¾ä½¿ç”¨ã€Œæ—¥å¸¸èªè¨€ã€è½‰å‘ã€Œå°ˆæ¥­è¡“èªã€çš„éç¨‹ã€‚
                    </div>
                </div>
            </div>

            <!-- çŸ¥è­˜ç¶²çµ¡ -->
            <div class="card relative overflow-hidden bg-slate-800 text-white border-0">
                <div class="flex justify-between items-center mb-6 relative z-10">
                    <h2 class="text-lg font-bold flex items-center"><i class="fas fa-project-diagram text-blue-400 mr-2"></i>çŸ¥è­˜ç¶²çµ¡ä½ç½®</h2>
                    <button onclick="openRefModal('network')" class="ref-btn ref-btn-dark"><i class="fas fa-info-circle mr-1"></i> Ref.</button>
                </div>
                <div class="relative h-32 w-full flex items-center justify-center">
                     <div class="absolute w-2/3 h-0.5 bg-gray-600"></div>
                     <!-- Simulated Node -->
                     <div class="absolute z-10 flex flex-col items-center node-pulse">
                        <div class="w-12 h-12 rounded-full bg-blue-500 border-4 border-slate-900 flex items-center justify-center font-bold">You</div>
                        <span class="text-xs mt-2 text-blue-200" id="network-role-label">Broker (ä»²ä»‹è€…)</span>
                    </div>
                     <!-- Simulated Connections -->
                     <div class="absolute left-1/4 w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-xs opacity-50">A</div>
                     <div class="absolute right-1/4 w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-xs opacity-50">B</div>
                </div>
                <div class="mt-4 text-[10px] text-gray-300 bg-gray-800/80 p-3 rounded border border-gray-700 relative z-10">
                    <strong><i class="fas fa-share-alt"></i> ç¤¾ç¾¤æ¨å‹•åŠ› (Community Impact)ï¼š</strong>
                    é€™é¡¯ç¤ºäº†ä½ çš„æƒ³æ³•åœ¨ç¤¾ç¾¤ä¸­æ¿€ç™¼äº†å¤šå°‘æ¼£æ¼ªã€‚ä½œç‚º <strong>Broker</strong>ï¼Œä½ é€£çµäº†ä¸åŒçš„å°çµ„è¨è«–ã€‚
                </div>
            </div>
        </section>

    </div>

    <!-- Ref Modal Structure -->
    <div id="refModal" class="modal" onclick="closeRefModalOnClick(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-book-open text-indigo-500"></i> <span id="modalTitle">æ•¸æ“šè§£æ</span></h3>
                <span class="close" onclick="closeRefModal()">&times;</span>
            </div>
            <div class="modal-body space-y-5">
                <!-- 1. ç†è«–èƒŒæ™¯ -->
                <div>
                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-graduation-cap mr-2"></i> (1) çŸ¥è­˜å»ºæ§‹ç†è«–èƒŒæ™¯</h4>
                    <div class="text-sm text-slate-700 bg-blue-50 p-3 rounded-lg border border-blue-100 leading-relaxed" id="modalTheory"></div>
                </div>
                <!-- 2. æ•¸æ“šè¨ºæ–· -->
                <div>
                    <h4 class="text-xs font-bold text-yellow-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-lightbulb mr-2"></i> (2) ğŸ’¡ æ•¸æ“šè¨ºæ–·èˆ‡æ•™å­¸å°å¼•</h4>
                    <div class="text-sm text-slate-700 bg-yellow-50 p-3 rounded-lg border border-yellow-100 leading-relaxed" id="modalInsight"></div>
                </div>
                <!-- 3. ç›®å‰ç‹€æ³ -->
                <div>
                    <h4 class="text-xs font-bold text-green-600 uppercase tracking-widest mb-2 flex items-center"><i class="fas fa-chart-pie mr-2"></i> (3) ç›®å‰çš„ç‹€æ³ (æ•¸æ“š)</h4>
                    <div class="text-sm text-slate-700 bg-green-50 p-3 rounded-lg border border-green-100 font-mono font-bold" id="modalStatus"></div>
                </div>
                <!-- 4. å­¸è¡“å¼•ç”¨ -->
                <div class="pt-4 border-t border-slate-100">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 flex items-center"><i class="fas fa-quote-right mr-2"></i> (4) ğŸ“š å­¸è¡“åƒè€ƒä¾†æº</h4>
                    <p class="text-xs text-slate-500 italic" id="modalRef"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Global State ---
    const STORAGE_KEY = 'kb_platform_v2_28_data';
    let currentUserId = '';
    let radarChartInstance = null;
    let scaffoldChartInstance = null;
    let currentUserStats = null; // Store for Ref modal context

    // --- Ref Data Database (International Journal Standards) ---
    const refData = {
        'roles': {
            title: 'çŸ¥è­˜è§’è‰² (Epistemic Roles)',
            theory: 'æ ¹æ“š Scardamalia (2002) çš„ã€Œèªè­˜è«–ä»£ç†äºº (Epistemic Agency)ã€ï¼Œå­¸ç”Ÿåœ¨ç¤¾ç¾¤ä¸­æ‡‰å±•ç¾å¤šæ¨£åŒ–çš„è²¢ç»æ¨¡å¼ï¼Œå¦‚ç™¼èµ·è€…ã€é€£çµè€…æˆ–æ•´åˆè€…ï¼Œè€Œéå–®ä¸€çš„æ¥æ”¶è€…ã€‚',
            cite: 'Scardamalia, M. (2002). Socio-cognitive dynamics of knowledge building.'
        },
        'initiator': {
            title: 'é–‹å‰µåŠ› (Initiator)',
            theory: 'è¡¡é‡å­¸ç”Ÿç™¼èµ·æ–°è¨è«–ä¸²çš„èƒ½åŠ›ã€‚é€™æ˜¯ã€ŒçœŸå¯¦å•é¡Œ (Real Ideas, Authentic Problems)ã€åŸå‰‡çš„é«”ç¾ã€‚',
            cite: 'Zhang, J., et al. (2009). Designs for collective cognitive responsibility.'
        },
        'builder': {
            title: 'é€£çµåŠ› (Builder)',
            theory: 'è¡¡é‡å­¸ç”Ÿå»¶ä¼¸èˆ‡å›æ‡‰ä»–äººæƒ³æ³•çš„èƒ½åŠ›ã€‚é«”ç¾ã€Œè§€é»æ”¹é€² (Improvable Ideas)ã€åŸå‰‡ã€‚',
            cite: 'Scardamalia, M., & Bereiter, C. (2006). Knowledge building.'
        },
        'synthesizer': {
            title: 'æ•´åˆåŠ› (Synthesizer)',
            theory: 'è¡¡é‡å­¸ç”Ÿé€²è¡Œã€Œæ˜‡è¯ (Rise-above)ã€çš„èƒ½åŠ›ï¼Œå°‡åˆ†æ•£è§€é»æ•´åˆç‚ºæ›´é«˜å±¤æ¬¡çš„è§£é‡‹ã€‚',
            cite: 'Chen, B., et al. (2015). Advancing knowledge building discourse.'
        },
        'sustainer': {
            title: 'ç¶­è­·åŠ› (Sustainer)',
            theory: 'è¡¡é‡å­¸ç”Ÿç¶­æŒè¨è«–ç†±åº¦èˆ‡ç¤¾ç¾¤äº’å‹•çš„èƒ½åŠ›ï¼Œç¢ºä¿çŸ¥è­˜å°è©±ä¸ä¸­æ–·ã€‚',
            cite: 'Oshima, J., et al. (2012). Knowledge building discourse explorer.'
        },
        'created': {
            title: 'ç™¼æ–‡è²¢ç» (Contribution)',
            theory: 'ã€Œé›†é«”èªçŸ¥è²¬ä»»ã€è¦æ±‚æ¯å€‹æˆå“¡éƒ½éœ€å°ç¤¾ç¾¤çŸ¥è­˜çš„é€²æ­¥åšå‡ºè²¢ç»ã€‚ç™¼æ–‡é‡é›–éå”¯ä¸€æŒ‡æ¨™ï¼Œå»æ˜¯åƒèˆ‡çš„åŸºç¤é–€æª»ã€‚',
            cite: 'Zhang, J., et al. (2009). Designs for collective cognitive responsibility.'
        },
        'read': {
            title: 'é–±è®€å»£åº¦ (Reading Breadth)',
            theory: 'çŸ¥è­˜å»ºæ§‹å¼·èª¿ã€Œè§€é»å¤šæ¨£æ€§ (Idea Diversity)ã€ã€‚å»£æ³›é–±è®€ä»–äººç­†è¨˜æ˜¯ç†è§£ç¤¾ç¾¤åˆ†æ•£çŸ¥è­˜çš„å‰æï¼Œé¿å…é–‰é–€é€ è»Šã€‚',
            cite: 'Chen, B., & Hong, H. Y. (2016). Schools as knowledge-building communities.'
        },
        'buildon': {
            title: 'è§€é»é€£çµ (Build-ons)',
            theory: 'ã€Œè§€é»æ”¹é€² (Improvable Ideas)ã€æ˜¯ KB çš„æ ¸å¿ƒã€‚Build-on ä»£è¡¨ä½ ä¸åƒ…é–±è®€ï¼Œé‚„é€²ä¸€æ­¥å»¶ä¼¸æˆ–ä¿®æ­£ä»–äººçš„æƒ³æ³•ï¼Œæ˜¯çŸ¥è­˜æ¼”åŒ–çš„é—œéµå‹•åŠ›ã€‚',
            cite: 'Scardamalia, M., & Bereiter, C. (2006). Knowledge building: Theory, pedagogy, and technology.'
        },
        'impact': {
            title: 'ç¤¾ç¾¤æ¨å‹•åŠ› (Community Impact)',
            theory: 'é€éç¤¾æœƒç¶²çµ¡åˆ†æ (SNA) ä¸­çš„ã€Œè¢«å¼•ç”¨æ•¸ (In-degree)ã€ï¼Œè¡¡é‡ä½ çš„æƒ³æ³•æ¿€ç™¼äº†å¤šå°‘å¾ŒçºŒè¨è«–ã€‚é«˜å½±éŸ¿åŠ›ä»£è¡¨ä½ çš„è§€é»å…·æœ‰å•Ÿç™¼æ€§ï¼Œèƒ½å¼•ç™¼ç¤¾ç¾¤çš„æ¼£æ¼ªæ•ˆæ‡‰ã€‚',
            cite: 'Oshima, J., et al. (2012). Knowledge building discourse explorer.'
        },
        'evolution': {
            title: 'æƒ³æ³•æ¼”åŒ– (Idea Evolution)',
            theory: 'çŸ¥è­˜æ˜¯ä¸æ–·ç™¼å±•çš„ã€‚æ­¤è»Œè·¡åœ–å±•ç¤ºä½ çš„æƒ³æ³•å¦‚ä½•éš¨æ™‚é–“ç¶“æ­·ã€Œæå• -> ä¿®æ­£ -> æ•´åˆã€çš„æ­·ç¨‹ï¼Œåæ˜ äº†ã€Œå»ºè¨­æ€§å°è©±ã€çš„å“è³ªã€‚',
            cite: 'Reimann, P. (2009). Time is precious: Variable-and event-centred approaches.'
        },
        'scaffold': {
            title: 'æ€è€ƒé·¹æ¶ (Scaffolds)',
            theory: 'é·¹æ¶ï¼ˆå¦‚ï¼šæˆ‘åŸæœ¬çš„æƒ³æ³•...ä½†æ–°çš„è­‰æ“šé¡¯ç¤º...ï¼‰æ˜¯æ”¯æŒé«˜éšæ€ç¶­çš„èªè¨€æ¨¡æ¿ï¼Œå¹«åŠ©å­¸ç”Ÿé€²è¡Œæ›´ç´°ç·»çš„è«–è­‰èˆ‡åæ€ã€‚',
            cite: 'Chen, B., et al. (2017). Two-level analysis of modes of inquiry.'
        },
        'radar': {
            title: 'çŸ¥è­˜äº”åŠ› (Competency Radar)',
            theory: 'ç¶œåˆè©•ä¼°å­¸ç”Ÿçš„å¤šç¶­åº¦èƒ½åŠ›ï¼šä¸»å‹•æ€§ã€ç¤¾æœƒæ€§ã€èªçŸ¥æ·±åº¦ç­‰ã€‚ç†æƒ³çš„çŸ¥è­˜å»ºæ§‹è€…æ‡‰åœ¨å„é¢å‘å‡è¡¡ç™¼å±•ã€‚',
            cite: 'Lai, K. W., & Law, N. (2006). Peer scaffolding of knowledge building.'
        },
        'lexical': {
            title: 'è©å½™æ·±åº¦ (Lexical Depth)',
            theory: 'è¿½è¹¤å­¸ç”Ÿå¾ä½¿ç”¨ã€Œæ—¥å¸¸èªè¨€ã€è½‰å‘ç²¾ç¢ºçš„ã€Œå­¸è¡“è¡“èªã€ï¼Œåæ˜ äº†æ¦‚å¿µç†è§£çš„æ·±åŒ–èˆ‡å°ˆæ¥­åŒ–éç¨‹ (Metadiscourse)ã€‚',
            cite: 'Resendes, M., et al. (2015). Group-level formative feedback and metadiscourse.'
        },
        'network': {
            title: 'ç¶²çµ¡ä½ç½® (Network Position)',
            theory: 'ä½ åœ¨ç¤¾ç¾¤ç¶²çµ¡ä¸­çš„ä½ç½®ï¼ˆå¦‚æ ¸å¿ƒã€æ©‹æ¢ã€é‚Šç·£ï¼‰ã€‚Broker (æ©‹æ¢) èƒ½é€£çµä¸åŒçš„å°åœ˜é«”ï¼Œä¿ƒé€²è·¨é ˜åŸŸçš„çŸ¥è­˜æµå‹•ï¼Œæ˜¯ç¤¾ç¾¤çŸ¥è­˜æ“´æ•£çš„é—œéµã€‚',
            cite: 'Wasserman, S., & Faust, K. (1994). Social network analysis.'
        }
    };

    // --- Modal Functions ---
    function openRefModal(key) {
        const data = refData[key] || { title: 'åˆ†æé …ç›®', theory: 'è³‡æ–™è¼‰å…¥ä¸­...', cite: '' };
        const modal = document.getElementById('refModal');
        
        // 1. è¨­å®šæ¨™é¡Œèˆ‡ç†è«–
        document.getElementById('modalTitle').innerText = data.title;
        document.getElementById('modalTheory').innerText = data.theory;
        document.getElementById('modalRef').innerText = data.cite;

        // 2. è¨­å®šæ•¸æ“šèˆ‡è¨ºæ–· (Context Aware with Narrative)
        let statusText = "ç›®å‰å°šç„¡è¶³å¤ æ•¸æ“šé€²è¡Œæ·±å…¥åˆ†æã€‚";
        let insightText = "å»ºè­°æŒçºŒåƒèˆ‡è¨è«–ä»¥ç´¯ç©æ•¸æ“šã€‚";
        const s = currentUserStats;

        if (s) {
            // New Role Metrics Logic for Modal
            if (key === 'initiator') {
                statusText = `é–‹å‰µåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.initiator}%</strong>`;
                insightText = s.roleMetrics.initiator > 70 ? "ä½ éå¸¸å–„æ–¼é–‹å•Ÿæ–°çš„è¨è«–è©±é¡Œï¼Œæ˜¯ç¤¾ç¾¤çš„å¥½å¥‡å¿ƒå¼•æ“ï¼" : "è©¦è‘—å¤šç™¼è¡¨ä¸€äº›ã€Œæ–°å•é¡Œã€æˆ–ã€Œæ–°æƒ³æ³•ã€ä¾†æå‡æ­¤æŒ‡æ¨™ã€‚";
            } else if (key === 'builder') {
                statusText = `é€£çµåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.builder}%</strong>`;
                insightText = s.roleMetrics.builder > 70 ? "ä½ æ˜¯ç¤¾ç¾¤çš„é€£çµè€…ï¼Œå–„æ–¼å›æ‡‰ä»–äººï¼Œè®“å°è©±å»¶çºŒã€‚" : "å˜—è©¦å¤šä½¿ç”¨ã€Œå»¶ä¼¸ã€æˆ–ã€Œæ”¹é€²ã€åŠŸèƒ½å›æ‡‰åŒå­¸çš„ç­†è¨˜ã€‚";
            } else if (key === 'synthesizer') {
                statusText = `æ•´åˆåŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.synthesizer}%</strong>`;
                insightText = s.roleMetrics.synthesizer > 60 ? "ä½ å…·å‚™é«˜éšçš„æ•´åˆèƒ½åŠ›ï¼Œèƒ½å°‡åˆ†æ•£çš„è§€é»æ­¸ç´ç‚ºçµè«–ã€‚" : "æŒ‘æˆ°çœ‹çœ‹ä½¿ç”¨ã€Œæ˜‡è¯ (Rise-above)ã€æ¨™ç±¤ï¼Œè©¦è‘—ç¸½çµå¤§å®¶çš„è¨è«–ã€‚";
            } else if (key === 'sustainer') {
                statusText = `ç¶­è­·åŠ›å¼·åº¦ï¼š<strong>${s.roleMetrics.sustainer}%</strong>`;
                insightText = "é€™æ˜¯è¡¡é‡ä½ æŒçºŒåƒèˆ‡å’Œç¶­è­·è¨è«–ç†±åº¦çš„æŒ‡æ¨™ã€‚";
            }
            // Existing Logic
            else if (key === 'created') {
                statusText = `åœ¨é€™æ®µæ¢ç©¶æ—…ç¨‹ä¸­ï¼Œä½ å·²ç¶“è²¢ç»äº† <strong>${s.totalNotes} ç¯‡</strong>æƒ³æ³•ç­†è¨˜ã€‚ç›¸è¼ƒæ–¼ç¤¾ç¾¤å¹³å‡æ°´å¹³ï¼Œé€™æ˜¯ä¸€å€‹${s.totalNotes > 5 ? 'ç›¸ç•¶æ´»èº' : 'èµ·æ­¥éšæ®µ'}çš„æ•¸å­—ã€‚é€™é¡¯ç¤ºäº†ä½ ${s.totalNotes > 5 ? 'ç©æ¥µæ‰¿æ“”äº†æ¨å‹•ç¤¾ç¾¤çŸ¥è­˜å‰é€²çš„è²¬ä»»' : 'æ­£åœ¨å˜—è©¦èå…¥é€™å€‹çŸ¥è­˜å»ºæ§‹çš„æ–‡åŒ–'}ã€‚`;
                insightText = s.totalNotes > 5 ? "ä½ çš„ç™¼æ–‡é‡ç©©å®šï¼Œé€™æ˜¯éå¸¸æ£’çš„åŸºç¤ï¼ä¸‹ä¸€æ­¥ï¼Œè©¦è‘—é—œæ³¨è‡ªå·±ç™¼æ–‡çš„ã€Œå“è³ªã€æ˜¯å¦éš¨æ™‚é–“æå‡ï¼Œä¾‹å¦‚æ˜¯å¦æå‡ºäº†æ›´æ·±å±¤çš„å•é¡Œï¼Ÿ" : "ç™¼æ–‡é‡åä½æ˜¯æ­£å¸¸çš„é–‹å§‹ã€‚å»ºè­°å¾ã€Œæå•ã€é–‹å§‹ï¼ŒæŠŠä½ å°ä¸»é¡Œçš„å¥½å¥‡å¿ƒè½‰åŒ–ç‚ºç¤¾ç¾¤çš„è¨è«–èµ·é»ã€‚";
            } else if (key === 'buildon') {
                const ratio = s.totalNotes > 0 ? Math.round((s.linksCount / s.totalNotes) * 100) : 0;
                statusText = `ä½ ç›®å‰é‡å°ä»–äººçš„æƒ³æ³•é€²è¡Œäº† <strong>${s.linksCount} æ¬¡</strong>é€£çµèˆ‡å»¶ä¼¸ï¼ˆBuild-onï¼‰ã€‚é€™ä½”äº†ä½ ç¸½ç™¼è¨€çš„ <strong>${ratio}%</strong>ã€‚é€™å€‹æ¯”ä¾‹åæ˜ äº†ä½ ${ratio > 30 ? 'éå¸¸é‡è¦–èˆ‡ä»–äººçš„å°è©±ï¼Œå–„æ–¼ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šæ€è€ƒ' : 'æ¯”è¼ƒå‚¾å‘æ–¼ç™¼è¡¨ç¨ç«‹çš„è¦‹è§£ï¼Œè¼ƒå°‘ç›´æ¥å›æ‡‰ä»–äºº'}ã€‚`;
                insightText = s.linksCount > 3 ? "ä½ å–„æ–¼é€£çµä»–äººæƒ³æ³•ï¼Œé€™æ˜¯ç¤¾ç¾¤çŸ¥è­˜æ¼”åŒ–çš„é—œéµå‹•åŠ›ã€‚è«‹ç¹¼çºŒä¿æŒé€™ç¨®ã€Œå°è©±å¼ã€çš„æ€è€ƒç¿’æ…£ï¼" : "å˜—è©¦å¤šä½¿ç”¨ã€Œå»¶ä¼¸ (Extend)ã€æˆ–ã€Œæ”¹é€² (Improve)ã€é·¹æ¶ä¾†å›æ‡‰åŒå­¸çš„è§€é»ã€‚ä¸è¦è®“è¨è«–æ–·åœ¨è‡ªå·±é€™è£¡ï¼Œè©¦è‘—æŠŠåˆ¥äººçš„é»å­è®Šå¾—æ›´å¥½ã€‚";
            } else if (key === 'impact') {
                statusText = `ä½ çš„æƒ³æ³•å…±ç²å¾—äº† <strong>${s.repliedCount} æ¬¡</strong>å›è¦†ï¼Œå½¢æˆäº†ä¸€è‚¡ç¤¾ç¾¤æ¨å‹•åŠ›ã€‚é€™æ„å‘³è‘—ä½ çš„è§€é»åœ¨ç¤¾ç¾¤ä¸­ç”¢ç”Ÿäº†<strong>${s.repliedCount > 2 ? 'é¡¯è‘—çš„å…±é³´èˆ‡è¨è«–æ¼£æ¼ª' : 'åˆæ­¥çš„èƒ½è¦‹åº¦'}</strong>ã€‚`;
                insightText = s.repliedCount > 2 ? "ä½ çš„è§€é»æˆåŠŸå¼•ç™¼äº†å…±é³´ï¼é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„è¨Šè™Ÿã€‚æ¥ä¸‹ä¾†ï¼Œè©¦è‘—å›æ‡‰é€™äº›å›é¥‹ï¼Œé€²è¡Œæ›´æ·±å±¤çš„è¾¯è­‰ï¼Œæˆ–è¨±èƒ½æ¿€ç™¼å‡ºæ–°çš„æ•´åˆè§€é»ã€‚" : "ç›®å‰å›æ‡‰è¼ƒå°‘ã€‚å»ºè­°åœ¨æ¨™é¡Œä¸­ä½¿ç”¨æ›´å…·å¸å¼•åŠ›çš„å•é¡Œï¼Œæˆ–è€…åœ¨æ–‡ä¸­ç›´æ¥æ¨™è¨»ï¼ˆTagï¼‰ä½ èªç‚ºå¯èƒ½æœƒæ„Ÿèˆˆè¶£çš„åŒå­¸ï¼Œä¸»å‹•é‚€è«‹ä»–å€‘åƒèˆ‡è¨è«–ã€‚";
            } else if (key === 'radar') {
                statusText = "ä½ çš„äº”åŠ›é›·é”åœ–å‘ˆç¾äº†ä½ åœ¨ç™¼æ–‡æ•¸é‡ã€å›è¦†äº’å‹•ã€é–±è®€å»£åº¦ã€è©å½™æ·±åº¦åŠè¢«å¼•ç”¨æ•¸é€™äº”å€‹ç¶­åº¦ä¸Šçš„ç•¶å‰ç‹€æ…‹ã€‚åœ–å½¢é¢ç©è¶Šå¤§ï¼Œä»£è¡¨ä½ çš„ç¶œåˆåƒèˆ‡åº¦è¶Šé«˜ã€‚";
                insightText = "è§€å¯Ÿåœ–å½¢å‡¹é™·è™•å³ç‚ºä½ çš„æˆé•·æ©Ÿæœƒé»ã€‚ä¾‹å¦‚ï¼Œè‹¥åœ–å½¢åœ¨ã€Œè¢«å¼•ç”¨æ•¸ã€æ–¹é¢è¼ƒå¼±ï¼Œå¯èƒ½éœ€è¦æ€è€ƒå¦‚ä½•è®“ä½ çš„æ¨™é¡Œæ›´å…·å¸å¼•åŠ›ï¼›è‹¥ã€Œè©å½™æ·±åº¦ã€è¼ƒä½ï¼Œå‰‡å¯å˜—è©¦åœ¨ç™¼è¨€ä¸­é‹ç”¨æ›´å¤šèª²å ‚å­¸åˆ°çš„å°ˆæ¥­è¡“èªã€‚";
            } else if (key === 'scaffold') {
                // Determine dominant scaffold
                let maxScaffold = 'question';
                let maxCount = 0;
                for (const [type, count] of Object.entries(s.scaffoldCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        maxScaffold = type;
                    }
                }
                const scaffoldMap = {'question': 'æå•', 'extend': 'å»¶ä¼¸', 'improve': 'æ”¹é€²', 'counter': 'åé§', 'riseabove': 'æ•´åˆ'};
                statusText = `å¾åœ“é¤…åœ–å¯ä»¥çœ‹å‡ºï¼Œä½ ç›®å‰æœ€å¸¸ä½¿ç”¨çš„æ€è€ƒç­–ç•¥æ˜¯ã€Œ<strong>${scaffoldMap[maxScaffold]}</strong>ã€ã€‚é€™é¡¯ç¤ºäº†ä½ ç›®å‰çš„æ€è€ƒç¿’æ…£åå‘æ–¼${maxScaffold === 'question' ? 'ç™¼æ•£èˆ‡æ¢ç´¢' : (maxScaffold === 'riseabove' ? 'æ”¶æ–‚èˆ‡ç¸½çµ' : 'å°è©±èˆ‡ä¿®æ­£')}ã€‚`;
                insightText = "ç†æƒ³çš„çŸ¥è­˜å»ºæ§‹è€…æœƒéˆæ´»é‹ç”¨å„ç¨®ç­–ç•¥ã€‚è‹¥ä½ çš„åœ–è¡¨åå‘å–®ä¸€é¡è‰²ï¼ˆä¾‹å¦‚åªæœ‰è—è‰²çš„æå•ï¼‰ï¼Œå»ºè­°å˜—è©¦æŒ‘æˆ°ä½¿ç”¨å…¶ä»–é¡è‰²çš„é·¹æ¶ï¼Œä¾‹å¦‚ç´«è‰²çš„ã€Œæ•´åˆ (Rise-above)ã€ï¼Œè©¦è‘—å°‡åˆ†æ•£çš„è¨è«–æ­¸ç´å‡ºçµè«–ã€‚";
            } else if (key === 'roles') {
                statusText = "å·¦å´çš„è§’è‰²å¡ç‰‡æ˜¯ç³»çµ±æ ¹æ“šä½ è¿‘æœŸçš„ç™¼è¨€è¡Œç‚ºæ¨¡å¼æ‰€è³¦äºˆçš„ç¨±è™Ÿã€‚å®ƒåæ˜ äº†ä½ åœ¨ç¤¾ç¾¤ç”Ÿæ…‹ç³»ä¸­çš„åŠŸèƒ½å®šä½ã€‚";
                insightText = "ä½ çš„è§’è‰²ä¸¦éå›ºå®šä¸è®Šã€‚éš¨è‘—ä½ æ”¹è®Šç™¼è¨€ç­–ç•¥ï¼ˆä¾‹å¦‚å¾å¤šæå•è½‰ç‚ºå¤šç¸½çµï¼‰ï¼Œä½ çš„è§’è‰²ä¹Ÿæœƒéš¨ä¹‹é€²åŒ–ã€‚å˜—è©¦æŒ‘æˆ°è§£é–ä¸åŒçš„è§’è‰²ï¼Œè±å¯Œä½ çš„å­¸ç¿’é«”é©—ï¼";
            } else if (key === 'evolution') {
                statusText = "æ­¤æ™‚é–“è»¸å±•ç¤ºäº†ä½ è¿‘æœŸåƒèˆ‡çš„è¨è«–ä¸²ã€‚æ¯ä¸€æ¢ç·šä»£è¡¨ä¸€å€‹æƒ³æ³•çš„ç”Ÿå‘½é€±æœŸï¼Œå¾èª•ç”Ÿåˆ°è¢«ä¿®æ­£ã€è¢«æ•´åˆçš„éç¨‹ã€‚";
                insightText = "å›é¡§é€™äº›è»Œè·¡ï¼Œæ€è€ƒä¸€ä¸‹ï¼šå“ªäº›æƒ³æ³•ã€Œå­˜æ´»ã€å¾—æœ€ä¹…ï¼Ÿå“ªäº›æƒ³æ³•å¼•ç™¼äº†æœ€æ¿€çƒˆçš„è¨è«–ï¼Ÿé€™äº›éƒ½æ˜¯ä½ çŸ¥è­˜å»ºæ§‹æ­·ç¨‹ä¸­çš„äº®é»ã€‚";
            } else if (key === 'lexical') {
                 statusText = "æ­¤åˆ†ææ¯”è¼ƒäº†ä½ åœ¨æ¢ç©¶åˆæœŸèˆ‡è¿‘æœŸçš„ç”¨è©å·®ç•°ã€‚ç³»çµ±åµæ¸¬åˆ°ä½ çš„è©å½™æ­£é€æ¼¸å¾ç”Ÿæ´»ç”¨èªè½‰å‘æ›´ç²¾ç¢ºçš„å­¸ç§‘è¡“èªã€‚";
                 insightText = "è©å½™çš„è½‰è®Šä»£è¡¨æ¦‚å¿µçš„æ·±åŒ–ã€‚ç¹¼çºŒå˜—è©¦åœ¨è¨è«–ä¸­ä½¿ç”¨æ›´å°ˆæ¥­çš„è¡“èªä¾†æè¿°ç¾è±¡ï¼Œé€™æœ‰åŠ©æ–¼ä½ æ›´ç²¾æº–åœ°è¡¨é”è¤‡é›œçš„ç§‘å­¸æ¦‚å¿µã€‚";
            } else if (key === 'network') {
                 const role = s.repliedCount > 5 ? "æ ¸å¿ƒäººç‰© (Central)" : (s.linksCount > 3 ? "æ©‹æ¨‘è€… (Broker)" : "å‘¨é‚Šåƒèˆ‡è€… (Peripheral)");
                 statusText = `ç¶²çµ¡åˆ†æé¡¯ç¤ºä½ ç›®å‰çš„è§’è‰²å‚¾å‘æ–¼ï¼š<strong>${role}</strong>ã€‚ä½ çš„ä½ç½®é¡¯ç¤ºäº†ä½ åœ¨è³‡è¨Šæµå‹•ä¸­çš„é‡è¦æ€§ã€‚`;
                 insightText = "å¦‚æœä½ ä½æ–¼ç¶²çµ¡ä¸­å¿ƒï¼Œè«‹å–„ç”¨å½±éŸ¿åŠ›å¸¶å‹•è¨è«–ï¼›å¦‚æœä½ ä½æ–¼é‚Šç·£æˆ–æ“”ä»»æ©‹æ¨‘ï¼Œè«‹å˜—è©¦å°‡ä¸åŒå°çµ„çš„è§€é»é€£çµèµ·ä¾†ï¼Œä¿ƒé€²çŸ¥è­˜çš„è·¨åŸŸæµå‹•ã€‚";
            }
        }

        document.getElementById('modalStatus').innerHTML = statusText;
        document.getElementById('modalInsight').innerText = insightText;
        
        modal.style.display = "flex";
    }

    function closeRefModal() {
        document.getElementById('refModal').style.display = "none";
    }

    function closeRefModalOnClick(event) {
        if (event.target == document.getElementById('refModal')) {
            closeRefModal();
        }
    }

    // --- Core Logic ---
    function getRealData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        try { return JSON.parse(raw); } catch (e) { return null; }
    }

    function initUserSwitcher(db) {
        const container = document.getElementById('nav-user-select-container');
        if (!container) return;
        
        const select = document.createElement('select');
        select.className = "bg-indigo-700 text-white text-xs border border-indigo-500 rounded px-2 py-1 outline-none";
        select.id = "student-selector"; // Important for sync
        
        const users = Object.values(db.userList || {});
        const students = users.filter(u => u.role !== 'teacher');

        if (students.length === 0) {
            select.innerHTML = '<option>ç„¡å­¸ç”Ÿè³‡æ–™</option>';
        } else {
            students.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.text = u.name;
                select.appendChild(option);
            });
        }
        select.onchange = function() { switchUser(this.value); };
        container.appendChild(select);

        // Auto select
        if (students.length > 0) {
            let targetId = students[0].id;
            if (db.currentUserKey && db.userList[db.currentUserKey] && db.userList[db.currentUserKey].role !== 'teacher') {
                targetId = db.userList[db.currentUserKey].id;
            }
            select.value = targetId;
            switchUser(targetId);
        }
    }

    // NEW: Dynamic Role Metrics Calculation
    function calculateRoleMetrics(stats) {
        // 1. Initiator (é–‹å‰µåŠ›): åŸºæ–¼ "question" æ•¸é‡èˆ‡æ¯”ä¾‹
        // å‡è¨­åŸºæº–: è‡³å°‘ 1 å€‹å•é¡Œæ‰é–‹å§‹è¨ˆåˆ†, 5 å€‹æ»¿åˆ†
        const initScore = Math.min((stats.scaffoldCounts.question * 20), 100); 
        
        // 2. Builder (é€£çµåŠ›): åŸºæ–¼ "extend" + "improve" + "linksCount" (ç™¼æ–‡æœ‰ parentId)
        // å‡è¨­åŸºæº–: 5 æ¬¡é€£çµæ»¿åˆ†
        const buildScore = Math.min(((stats.scaffoldCounts.extend + stats.scaffoldCounts.improve + stats.linksCount) * 15), 100);
        
        // 3. Synthesizer (æ•´åˆåŠ›): åŸºæ–¼ "riseabove"
        // å‡è¨­åŸºæº–: 2 æ¬¡æ˜‡è¯æ»¿åˆ† (å› ç‚ºå¾ˆé›£)
        const synthScore = Math.min((stats.scaffoldCounts.riseabove * 50), 100);
        
        // 4. Sustainer (ç¶­è­·åŠ›): åŸºæ–¼ "totalNotes" (æŒçºŒåƒèˆ‡åº¦)
        // å‡è¨­åŸºæº–: 10 ç¯‡ç­†è¨˜æ»¿åˆ†
        const susScore = Math.min((stats.totalNotes * 10), 100);

        return {
            initiator: Math.floor(initScore),
            builder: Math.floor(buildScore),
            synthesizer: Math.floor(synthScore),
            sustainer: Math.floor(susScore)
        };
    }

    function analyzeStudentData(db, userId) {
        if (!db || !db.nodes) return null;
        const myNotes = db.nodes.filter(n => n.author === userId);
        const myNoteIds = myNotes.map(n => n.id);
        
        // Impact Calc
        let repliedCount = 0;
        db.nodes.forEach(n => {
            if (n.parentId && myNoteIds.includes(n.parentId) && n.author !== userId) repliedCount++;
        });

        // Scaffold Calc
        const scaffoldCounts = { 'question': 0, 'extend': 0, 'improve': 0, 'counter': 0, 'riseabove': 0 };
        myNotes.forEach(n => { if (scaffoldCounts[n.type] !== undefined) scaffoldCounts[n.type]++; });

        const totalLength = myNotes.reduce((acc, n) => acc + (n.content ? n.content.length : 0), 0);
        const avgLength = myNotes.length ? Math.round(totalLength / myNotes.length) : 0;
        const linksCount = myNotes.filter(n => n.parentId).length; 

        // Calc Role Metrics Dynamically
        const tempStats = { scaffoldCounts, linksCount, totalNotes: myNotes.length };
        const roleMetrics = calculateRoleMetrics(tempStats);

        return {
            totalNotes: myNotes.length,
            repliedCount: repliedCount,
            linksCount: linksCount,
            scaffoldCounts: scaffoldCounts,
            avgLength: avgLength,
            replyOthersCount: linksCount, // Simplified
            recentNotes: myNotes.sort((a,b) => b.date - a.date).slice(0, 5),
            roleMetrics: roleMetrics // Add this
        };
    }

    function switchUser(userId) {
        currentUserId = userId;
        const db = getRealData();
        if (!db) return;

        const user = Object.values(db.userList).find(u => u.id === userId);
        if (user) {
            // Update Header
            document.getElementById('current-user-avatar').src = `https://ui-avatars.com/api/?name=${user.name}&background=random`;
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-avatar-large').innerText = user.name[0];

            // Analyze
            const stats = analyzeStudentData(db, userId);
            currentUserStats = stats; // Save for Ref Modal

            // Update Dynamic Role UI
            document.getElementById('role-initiator-val').innerText = `${stats.roleMetrics.initiator}%`;
            document.getElementById('role-initiator-bar').style.width = `${stats.roleMetrics.initiator}%`;
            
            document.getElementById('role-builder-val').innerText = `${stats.roleMetrics.builder}%`;
            document.getElementById('role-builder-bar').style.width = `${stats.roleMetrics.builder}%`;
            
            document.getElementById('role-synthesizer-val').innerText = `${stats.roleMetrics.synthesizer}%`;
            document.getElementById('role-synthesizer-bar').style.width = `${stats.roleMetrics.synthesizer}%`;
            
            document.getElementById('role-sustainer-val').innerText = `${stats.roleMetrics.sustainer}%`;
            document.getElementById('role-sustainer-bar').style.width = `${stats.roleMetrics.sustainer}%`;

            // Update Role Title based on best metric
            const metrics = stats.roleMetrics;
            let bestRole = 'æ¢ç´¢è€…';
            let bestScore = -1; // Allow 0 to be best if all are 0
            
            // Check max score
            if (metrics.initiator > bestScore) { bestScore = metrics.initiator; bestRole = 'é–‹å‰µè€… (Initiator)'; }
            if (metrics.builder > bestScore) { bestScore = metrics.builder; bestRole = 'é€£çµè€… (Builder)'; }
            if (metrics.synthesizer > bestScore) { bestScore = metrics.synthesizer; bestRole = 'æ•´åˆè€… (Synthesizer)'; }
            if (metrics.sustainer > bestScore) { bestScore = metrics.sustainer; bestRole = 'ç¶­è­·è€… (Sustainer)'; }

            // If no activity at all
            if (stats.totalNotes === 0) bestRole = 'æ–°æ‰‹ (Newcomer)';

            document.getElementById('role-title').innerText = bestRole;
            document.getElementById('role-desc').innerHTML = `<i class="fas fa-quote-left text-indigo-300 mr-1"></i> æ ¹æ“šåˆ†æï¼Œä½ åœ¨ã€Œ${bestRole.split(' ')[0]}ã€æ–¹é¢è¡¨ç¾æœ€ç‚ºçªå‡ºã€‚`;


            // Render Numbers
            animateValue("stat-total-notes", 0, stats.totalNotes, 800);
            animateValue("stat-replied", 0, stats.repliedCount, 800);
            animateValue("stat-links", 0, stats.linksCount, 800);
            document.getElementById('card-created-val').innerText = stats.totalNotes;
            // é–±è®€æ•¸æš«ç”¨æ¨¡æ“¬å…¬å¼
            document.getElementById('card-read-val').innerText = Math.floor(stats.totalNotes * 5.5 + 10);
            document.getElementById('card-buildon-val').innerText = stats.linksCount;
            document.getElementById('card-impact-val').innerText = stats.repliedCount;

            // Render Visuals
            renderTimeline(stats.recentNotes, db.nodes);
            renderScaffoldBars(stats.scaffoldCounts);
            
            // Radar Data Prep
            const s_init = Math.min((stats.scaffoldCounts['question'] * 10) + 20, 100);
            const s_build = Math.min((stats.linksCount * 8) + 20, 100);
            const s_read = 75; // Mock
            const s_vocab = Math.min((stats.totalNotes * 5) + 30, 90);
            const s_impact = Math.min((stats.repliedCount * 15) + 10, 100);
            renderRadarChart([s_init, s_build, s_read, s_vocab, s_impact], user.name);

            // Generate AI Feedback
            generateFeedback(stats);
        }
    }

    function syncData() {
        const btn = document.getElementById('sync-btn');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';
        setTimeout(() => {
            const db = getRealData();
            if(db) {
                // Re-init switcher or just reload current user
                if(currentUserId) switchUser(currentUserId);
                else initUserSwitcher(db);
            }
            btn.innerHTML = orgHtml;
        }, 500);
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function renderTimeline(notes, dbNodes) {
        const container = document.getElementById('evolution-timeline');
        container.innerHTML = ''; 
        if (notes.length === 0) { container.innerHTML = '<div class="text-center py-10 text-slate-400">å°šç„¡æ´»å‹•ç´€éŒ„</div>'; return; }
        
        const line = document.createElement('div');
        line.className = 'evolution-line';
        container.appendChild(line);

        notes.forEach(note => {
            let typeColor = 'bg-slate-200'; let typeIcon = 'fa-comment';
            if (note.type === 'question') { typeColor = 'bg-blue-100 text-blue-600'; typeIcon = 'fa-question'; }
            if (note.type === 'improve') { typeColor = 'bg-green-100 text-green-600'; typeIcon = 'fa-arrow-up'; }
            if (note.type === 'riseabove') { typeColor = 'bg-purple-100 text-purple-600'; typeIcon = 'fa-layer-group'; }
            
            let contextHtml = '';
            if (note.parentId) {
                const parent = dbNodes.find(n => n.id === note.parentId);
                if (parent) contextHtml = `<div class="text-xs text-slate-400 mb-1 pl-2 border-l-2 border-slate-200">å›æ‡‰: ${parent.title}</div>`;
            }

            const html = `
                <div class="relative flex gap-4 mb-6 evolution-node group evolution-item">
                    <div class="w-10 h-10 rounded-full ${typeColor} flex items-center justify-center shadow-sm border-2 border-white flex-shrink-0 z-10"><i class="fas ${typeIcon}"></i></div>
                    <div class="flex-1 bg-white p-3 rounded-lg border border-slate-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start"><h4 class="font-bold text-slate-700 text-sm mb-1">${note.title || 'ç„¡æ¨™é¡Œ'}</h4><span class="text-[10px] text-slate-400">${new Date(note.date).toLocaleDateString()}</span></div>
                        ${contextHtml}
                        <p class="text-xs text-slate-600 line-clamp-2">${note.content}</p>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderScaffoldBars(counts) {
        const container = document.getElementById('scaffold-bars');
        container.innerHTML = '';
        const max = Math.max(...Object.values(counts), 1);
        const types = ['question', 'extend', 'improve', 'counter', 'riseabove'];
        const colors = ['bg-blue-500', 'bg-yellow-400', 'bg-green-500', 'bg-red-500', 'bg-purple-500'];
        types.forEach((t, i) => {
            const val = counts[t];
            const h = Math.max((val / max) * 100, 10);
            const bar = document.createElement('div');
            bar.className = `flex-1 ${colors[i]} rounded-t-md relative group transition-all duration-500 hover:opacity-80`;
            bar.style.height = `${h}%`;
            bar.innerHTML = `<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-600 opacity-0 group-hover:opacity-100 transition">${val}</div>`;
            container.appendChild(bar);
        });
    }

    function renderRadarChart(dataValues, userName) {
        const ctx = document.getElementById('studentRadarChart').getContext('2d');
        if (radarChartInstance) radarChartInstance.destroy();
        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ç™¼æ–‡æ•¸é‡', 'å›è¦† (Build-on)', 'é–±è®€å»£åº¦', 'è©å½™æ·±åº¦', 'è¢«å¼•ç”¨æ•¸'],
                datasets: [{
                    label: userName,
                    data: dataValues,
                    fill: true,
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: 'rgb(79, 70, 229)',
                    pointBackgroundColor: 'rgb(79, 70, 229)',
                    pointBorderColor: '#fff'
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { r: { ticks: { display: false }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 11 } } } }, 
                plugins: { legend: { position: 'bottom' } } 
            }
        });
    }

    function generateFeedback(stats) {
        const container = document.getElementById('ai-feedback');
        let msgs = [];
        if (stats.totalNotes === 0) msgs.push("ğŸ‘‹ æ­¡è¿ä¾†åˆ°çŸ¥è­˜è«–å£‡ï¼è©¦è‘—å¾ã€Œæå•ã€é–‹å§‹ä½ çš„ç¬¬ä¸€æ­¥ã€‚");
        else {
            if (stats.scaffoldCounts.question > stats.scaffoldCounts.improve) msgs.push("ğŸ¤” ä½ çš„å•é¡Œå¾ˆæœ‰è¶£ï¼è©¦è‘—ç”¨ã€Œæ”¹é€²ã€é·¹æ¶ä¾†å˜—è©¦å›ç­”çœ‹çœ‹ã€‚");
            if (stats.scaffoldCounts.riseabove > 0) msgs.push("ğŸš€ å¾ˆæ£’ï¼ä½ å·²ç¶“é–‹å§‹å˜—è©¦æ•´åˆè§€é»ï¼Œé€™æ˜¯é«˜éšçš„çŸ¥è­˜å»ºæ§‹æŠ€å·§ã€‚");
        }
        if (msgs.length === 0) msgs.push("ğŸ‘ ä½ çš„åƒèˆ‡å¾ˆç©©å®šï¼Œè©¦è‘—å»å›æ‡‰é‚£äº›é‚„æ²’æœ‰äººç†æœƒçš„æƒ³æ³•å§ï¼");
        container.innerHTML = msgs.map(m => `<div class="bg-white p-3 rounded border border-indigo-100 shadow-sm flex gap-3"><i class="fas fa-lightbulb text-yellow-500 mt-1"></i><div>${m}</div></div>`).join('');
    }

    function refreshAIFeedback() {
        const container = document.getElementById('ai-feedback');
        container.innerHTML = '<p><i class="fas fa-spinner fa-spin text-indigo-400 mr-2"></i> åˆ†æä¸­...</p>';
        setTimeout(() => { if(currentUserId) generateFeedback(currentUserStats); }, 600);
    }

    // --- Init ---
    window.onload = function() {
        const db = getRealData();
        if (db) {
            console.log("DB Loaded");
            initUserSwitcher(db);
        } else {
            document.getElementById('ai-feedback').innerHTML = "å°šç„¡æ•¸æ“š";
        }
        
        // Setup chart defaults
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
    };
    </script>
</body>
</html>
