<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KB åˆ†æä¸­æ¨ (æ——è‰¦å­¸è¡“ç‰ˆ) | Teacher Dashboard v20.37 Mobile-Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Markdown Parser for AI response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        /* Card & Layout */
        .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; position: relative; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .card { padding: 1.5rem; } }
        
        /* Navigation */
        .nav-item.active { background-color: #0f172a; color: white; border-left: 4px solid #3b82f6; }
        .section-view { display: none; opacity: 0; transition: opacity 0.3s ease-in; }
        .section-view.active { display: block; opacity: 1; }
        .student-item.active-student { background-color: #e0e7ff; border-color: #818cf8; }

        /* Mobile Sidebar Transitions */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }

        /* Ref Button Style */
        .ref-btn {
            font-size: 0.75rem; color: #64748b; cursor: pointer; display: inline-flex; align-items: center;
            background: #f8fafc; padding: 4px 8px; border-radius: 9999px; border: 1px solid #cbd5e1;
            transition: all 0.2s; white-space: nowrap;
        }
        .ref-btn:hover { background: #e0f2fe; color: #0284c7; border-color: #7dd3fc; }
        .ref-btn i { margin-right: 4px; font-size: 0.7rem; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6);
            display: flex; justify-content: center; align-items: end; /* Mobile bottom sheet style */
            z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px);
        }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } }

        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; width: 100%; max-width: 700px; 
            border-top-left-radius: 16px; border-top-right-radius: 16px; border-bottom-left-radius: 0; border-bottom-right-radius: 0;
            padding: 0; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(20px); transition: all 0.3s; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { 
            .modal-content { 
                width: 95%; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            } 
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .modal-header { background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 20px; font-size: 0.95rem; line-height: 1.7; color: #334155; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        
        /* Ref Modal Section Styles */
        .ref-section { margin-bottom: 24px; }
        .ref-section-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* Box Styles */
        .ref-theory-title { color: #2563eb; }
        .ref-theory-box { background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; color: #1e3a8a; }
        .ref-insight-title { color: #d97706; }
        .ref-insight-box { background: #fffbeb; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b; color: #92400e; }
        .ref-data-title { color: #059669; }
        .ref-data-box { background: #ecfdf5; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981; color: #065f46; font-family: 'Noto Sans TC', sans-serif; }
        .ref-cite-title { color: #64748b; }
        .ref-cite-box { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; color: #64748b; font-style: italic; font-size: 0.85rem; }

        /* AI Button */
        .ai-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white;
            border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: bold;
            cursor: pointer; display: inline-flex; align-items: center; transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3); width: 100%; justify-content: center;
        }
        @media (min-width: 768px) { .ai-btn { width: auto; padding: 8px 16px; } }
        
        .ai-content h1, .ai-content h2 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .ai-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content strong { color: #4338ca; }

        /* Lens & Legend */
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .dot-fact { background-color: #cbd5e1; } .dot-theory { background-color: #3b82f6; }
        .dot-challenge { background-color: #eab308; } .dot-synthesis { background-color: #22c55e; }
        
        .lens-detail-box { background: #f8fafc; border-left: 4px solid #94a3b8; padding: 12px; border-radius: 0 8px 8px 0; min-height: 100px; font-size: 0.9rem; transition: all 0.3s; }
        .example-quote { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 0.85rem; font-style: italic; border: 1px dashed rgba(0,0,0,0.1); }

        /* Timeline */
        .timeline-line { position: absolute; left: 28px; top: 10px; bottom: 10px; width: 2px; background: #cbd5e1; z-index: 0; }
        .hotspot-dot { animation: pulse-dot 2s infinite ease-in-out; }

        /* Insight Box */
        .insight-box {
            background: linear-gradient(to right, #f0f9ff, #e0f2fe); border: 1px solid #bae6fd;
            border-left: 5px solid #0ea5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
        }
        .insight-header { color: #0369a1; font-weight: 700; display: flex; align-items: center; margin-bottom: 0.5rem; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

    <!-- Mobile Header -->
    <header class="bg-slate-900 text-white p-4 flex justify-between items-center lg:hidden z-40 shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="text-slate-300 hover:text-white focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-lg font-bold tracking-wider"><i class="fas fa-network-wired mr-2 text-blue-500"></i>KB ANALYTICS</h1>
        </div>
        <span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">v20.37 Mobile</span>
    </header>

    <div class="flex flex-1 overflow-hidden relative">

        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="absolute inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-400 flex flex-col shadow-2xl sidebar-transition sidebar-closed lg:static lg:transform-none lg:flex shrink-0">
            <div class="p-6 border-b border-slate-800 hidden lg:block">
                <h1 class="text-xl font-bold tracking-wider text-white flex items-center"><i class="fas fa-network-wired mr-2 text-blue-500"></i> KB ANALYTICS</h1>
                <p class="text-xs text-slate-500 mt-1 ml-6">v20.37 Mobile-Ready</p>
            </div>
            
            <div class="px-2 pt-4 pb-2 flex justify-between items-center lg:block">
                <a href="index.html" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-slate-800 text-slate-200 hover:bg-slate-700 transition hover:text-white border border-slate-700">
                    <i class="fas fa-home w-5 text-blue-400"></i><span class="font-bold">è¿”å›é¦–é </span>
                </a>
                <!-- Mobile Close Button -->
                <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 p-2 ml-2 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>

            <nav class="mt-2 flex-1 px-2 space-y-1 overflow-y-auto">
                <div class="border-t border-slate-800 my-2 mx-4"></div>
                <button onclick="switchView('overview'); toggleSidebar()" id="nav-overview" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left active"><i class="fas fa-tachometer-alt w-5"></i><span>ç¸½é«”æ¦‚æ³ (Overview)</span></button>
                <button onclick="switchView('students'); toggleSidebar()" id="nav-students" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left"><i class="fas fa-users w-5"></i><span>å€‹åˆ¥å­¸ç”Ÿ (Students)</span></button>
                <button onclick="switchView('topics'); toggleSidebar()" id="nav-topics" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left"><i class="fas fa-lightbulb w-5"></i><span>ä¸»é¡Œèˆ‡è§€é» (Ideas)</span></button>
                <button onclick="switchView('quality'); toggleSidebar()" id="nav-quality" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left"><i class="fas fa-microscope w-5"></i><span>è¨€è«‡å“è³ª (Quality)</span></button>
                
                <div class="pt-4 mt-4 border-t border-slate-800">
                    <a href="Knowledge Building Forum.html" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left text-blue-400 hover:text-blue-300">
                        <i class="fas fa-comments w-5"></i><span>å‰å¾€è«–å£‡</span>
                    </a>
                    <button onclick="refreshDashboardData(); toggleSidebar()" id="btn-refresh" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-r-lg hover:bg-slate-800 transition text-left text-green-400 hover:text-green-300 mt-1">
                        <i class="fas fa-sync-alt w-5"></i><span>åˆ·æ–°æ•¸æ“š</span>
                    </button>
                </div>
            </nav>
            <div class="p-4 bg-slate-950 border-t border-slate-800 text-xs text-slate-500">
                System: <span class="text-green-500">Online</span><br>
                Status: <span id="db-status-text">Checking...</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-slate-50 overflow-y-auto overflow-x-hidden relative w-full" id="main-content">
            <div class="p-4 md:p-8 space-y-6 pb-20">

                <!-- VIEW 1: ç¸½é«”æ¦‚æ³ -->
                <div id="view-overview" class="section-view active space-y-4 md:space-y-6">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800">ç­ç´šç¤¾ç¾¤è„ˆå‹•</h2>
                            <p class="text-xs md:text-sm text-slate-500">å…¨ç­çŸ¥è­˜å»ºæ§‹ç‹€æ…‹èˆ‡é›†é«”è²¬ä»»æŒ‡æ¨™</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
                            <button onclick="openRef('class_diagnosis')" class="ai-btn bg-purple-600 hover:bg-purple-700 shadow-md text-xs">
                                <i class="fas fa-brain mr-2"></i> å…¨ç­æ·±åº¦è¨ºæ–·
                            </button>
                            <span class="bg-white px-3 py-1 rounded-full text-xs border border-slate-200 shadow-sm flex items-center ml-auto md:ml-2"><i class="fas fa-calendar-alt mr-2 text-slate-400"></i> <span id="current-date-display">Today</span></span>
                        </div>
                    </header>
                    
                    <div class="insight-box" id="offline-insight-container">
                        <div class="insight-header"><i class="fas fa-lightbulb text-yellow-500 mr-2 text-lg"></i> ğŸ’¡ æ•¸æ“šè¨ºæ–· (Insight)</div>
                        <div class="text-sm text-slate-700 leading-relaxed" id="offline-insight-content">
                            æ­£åœ¨åˆ†æç­ç´šæ•¸æ“š...
                        </div>
                    </div>

                    <!-- Grid Layout Adjusted for Mobile -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="card border-l-4 border-green-500">
                            <div class="flex justify-between items-start"><div><div class="text-xs text-slate-500 font-bold uppercase">ç¸½ç™¼æ–‡æ•¸</div><div class="text-3xl font-bold text-slate-800 mt-1" id="total-notes-count">0</div></div><i class="fas fa-file-alt text-green-200 text-3xl"></i></div>
                            <div class="mt-auto text-right pt-2"><button class="ref-btn" onclick="openRef('total_notes')"><i class="fas fa-book"></i> Ref</button></div>
                        </div>
                        <div class="card border-l-4 border-blue-500">
                            <div class="flex justify-between items-start"><div><div class="text-xs text-slate-500 font-bold uppercase">ç¤¾ç¾¤å¯†åº¦</div><div class="text-3xl font-bold text-slate-800 mt-1" id="network-density">0.00</div></div><i class="fas fa-project-diagram text-blue-200 text-3xl"></i></div>
                            <div class="mt-auto text-right pt-2"><button class="ref-btn" onclick="openRef('density')"><i class="fas fa-book"></i> Ref</button></div>
                        </div>
                        <div class="card border-l-4 border-purple-500">
                            <div class="flex justify-between items-start"><div><div class="text-xs text-slate-500 font-bold uppercase">æ˜‡è¯ç‡</div><div class="text-3xl font-bold text-slate-800 mt-1" id="rise-above-rate">0%</div></div><i class="fas fa-layer-group text-purple-200 text-3xl"></i></div>
                            <div class="mt-auto text-right pt-2"><button class="ref-btn" onclick="openRef('depth')"><i class="fas fa-book"></i> Ref</button></div>
                        </div>
                        <div class="card border-l-4 border-red-500">
                            <div class="flex justify-between items-start"><div><div class="text-xs text-slate-500 font-bold uppercase">éœ€å¼•å°</div><div class="text-3xl font-bold text-red-500 mt-1" id="risk-student-count">0</div></div><i class="fas fa-exclamation-triangle text-red-200 text-3xl"></i></div>
                            <div class="mt-auto text-right pt-2"><button class="ref-btn" onclick="openRef('risk')"><i class="fas fa-book"></i> Ref</button></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card min-h-[350px]">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800"><i class="fas fa-share-alt text-blue-500 mr-2"></i>ç¤¾ç¾¤äº’å‹•çµæ§‹ (SNA)</h3><button class="ref-btn" onclick="openRef('sna')"><i class="fas fa-book"></i> Ref</button></div>
                            <div id="overview-network-container" class="flex-1 bg-slate-50 rounded border border-slate-100 min-h-[300px]"></div>
                        </div>
                        <div class="card flex flex-col gap-6">
                            <div class="flex-1 min-h-[200px]">
                                <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800 text-sm"><i class="fas fa-compass text-indigo-500 mr-2"></i>é·¹æ¶åˆ†ä½ˆ</h3><button class="ref-btn" onclick="openRef('principles')"><i class="fas fa-book"></i></button></div>
                                <div class="h-[150px] relative"><canvas id="principlesChart"></canvas></div>
                            </div>
                            <div class="flex-1 border-t pt-4 min-h-[200px]">
                                <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800 text-sm"><i class="fas fa-star text-yellow-500 mr-2"></i>KB 12åŸå‰‡</h3><button class="ref-btn" onclick="openRef('kb12')"><i class="fas fa-book"></i></button></div>
                                <div class="h-[180px] relative"><canvas id="kbPrinciplesChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: å€‹åˆ¥å­¸ç”Ÿåˆ†æ -->
                <div id="view-students" class="section-view space-y-4 md:space-y-6">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">å€‹åˆ¥å­¸ç”Ÿæ·±åº¦è¨ºæ–·</h2><p class="text-xs md:text-sm text-slate-500">å¾®è§€åˆ†æï¼šèªçŸ¥æˆé•·èˆ‡ç¤¾äº¤çµæ§‹</p></div>
                    </header>
                    <div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[calc(100vh-140px)]">
                        <!-- Student List: Collapsible on Mobile or Scrollable small box -->
                        <div class="w-full lg:w-1/4 bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col shadow-sm max-h-[300px] lg:max-h-none">
                            <div class="p-3 bg-slate-50 border-b flex justify-between items-center sticky top-0 z-10">
                                <div class="text-xs font-bold text-slate-500 uppercase ml-1">å­¸ç”Ÿåå–® (é»é¸æŸ¥çœ‹)</div>
                                <div class="text-[10px] text-slate-400" id="student-count-badge">0 äºº</div>
                            </div>
                            <div id="student-list-container" class="overflow-y-auto flex-1 p-2 space-y-2 min-h-[100px]">
                                <div class="text-center text-slate-400 py-4 text-sm">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        
                        <!-- Student Detail Panel -->
                        <div class="w-full lg:w-3/4 space-y-4 md:space-y-6 overflow-y-auto pr-0 lg:pr-2 pb-10" id="student-detail-panel">
                            <div class="card bg-gradient-to-r from-white to-slate-50 border-l-4 border-blue-500" id="profile-card">
                                <div class="flex flex-row justify-between items-center gap-4">
                                    <div class="flex gap-4 items-center">
                                        <div id="profile-avatar" class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-xl font-bold text-blue-600 border-4 border-white shadow-sm shrink-0">?</div>
                                        <div>
                                            <h3 class="text-lg font-bold text-slate-800 flex flex-col md:flex-row md:items-center"><span id="profile-name">è«‹é¸æ“‡å­¸ç”Ÿ</span> <span class="text-xs text-slate-400 font-normal md:ml-2" id="profile-id">--</span></h3>
                                            <div class="mt-1 text-xs text-slate-600"><span id="profile-status-text">ç­‰å¾…é¸å–...</span></div>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="text-2xl font-bold text-slate-800" id="profile-notes-count">0</div>
                                        <div class="text-[10px] text-slate-500 uppercase">Notes</div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                <div class="card"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-sm text-slate-700 uppercase">èªçŸ¥æ·±åº¦æ¼”åŒ–</h4><button class="ref-btn" onclick="openRef('depth_trajectory')"><i class="fas fa-book"></i></button></div><div class="h-48 relative"><canvas id="studentDepthChart"></canvas></div></div>
                                <div class="card"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-sm text-slate-700 uppercase">çŸ¥è­˜èƒ½åŠ› DNA</h4><button class="ref-btn" onclick="openRef('radar')"><i class="fas fa-book"></i></button></div><div class="h-48 relative"><canvas id="radarChart"></canvas></div></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                <div class="card min-h-[300px]">
                                    <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-sm text-slate-700 uppercase mr-2">è‡ªæˆ‘äº’å‹•åœˆ</h4><button class="ref-btn" onclick="openRef('ego')"><i class="fas fa-book"></i></button></div>
                                    <div class="flex-1 bg-slate-50 rounded border border-slate-100 relative min-h-[200px]"><div id="ego-network-container" class="absolute inset-0"></div></div>
                                    <div class="text-xs text-right mt-2 text-slate-500" id="ego-metric">äº’å‹•é€£ç·šæ•¸</div>
                                </div>
                                <div class="card border-l-4" id="ai-card"><h4 class="font-bold text-sm text-slate-700 uppercase mb-3 flex items-center"><i class="fas fa-robot mr-2 text-blue-500"></i> AI å»ºè­°</h4><div class="space-y-3" id="ai-suggestions"><div class="text-sm text-slate-500">è«‹é¸æ“‡å­¸ç”Ÿã€‚</div></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: ä¸»é¡Œèˆ‡è§€é» -->
                <div id="view-topics" class="section-view space-y-4 md:space-y-6">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">è§€é»æ½›åŠ›èˆ‡æ¼”åŒ–</h2><p class="text-xs md:text-sm text-slate-500">æ¦‚å¿µç¶²çµ¡èˆ‡è©å½™æˆé•·</p></div>
                        <div class="w-full md:w-auto">
                            <select id="topic-selector-ideas" onchange="filterDataByTopic(this.value)" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="all" selected>æ‰€æœ‰ä¸»é¡Œ</option>
                            </select>
                        </div>
                    </header>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card min-h-[350px]">
                            <div class="flex justify-between items-center mb-4"><div><h3 class="font-bold text-slate-800">1. æ½›åŠ›è§€é»ç†±é»åœ–</h3><p class="text-xs text-slate-500">Interest vs. Gap</p></div><button class="ref-btn" onclick="openRef('promisingness')"><i class="fas fa-book"></i> Ref</button></div>
                            <div class="relative flex-1 bg-slate-50 border border-slate-200 rounded-lg p-2 min-h-[300px]" id="promisingness-container"></div>
                        </div>
                        <div class="card min-h-[350px]">
                            <div class="flex justify-between items-center mb-4"><div><h3 class="font-bold text-slate-800">2. æ¦‚å¿µèªç¾©ç¶²çµ¡</h3><p class="text-xs text-slate-500">é»æ“Šç¯€é»æŸ¥çœ‹ä¾†æº</p></div><button class="ref-btn" onclick="openRef('concept_network')"><i class="fas fa-book"></i> Ref</button></div>
                            <div id="concept-network-container" class="flex-1 bg-slate-50 rounded border border-slate-100 min-h-[300px]"></div>
                        </div>
                        <div class="card min-h-[300px]">
                            <div class="flex justify-between items-center mb-4"><div><h3 class="font-bold text-slate-800">3. å­¸è¡“è©å½™æˆé•·</h3></div><button class="ref-btn" onclick="openRef('lexical_growth')"><i class="fas fa-book"></i> Ref</button></div>
                            <div class="h-[250px] relative"><canvas id="lexicalChart"></canvas></div>
                        </div>
                        <div class="card h-[400px] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6"><div><h3 class="font-bold text-slate-800">4. è§€é»æ¼”åŒ–è·¯å¾‘</h3></div><button class="ref-btn" onclick="openRef('rise_above')"><i class="fas fa-book"></i> Ref</button></div>
                            <div class="relative pl-8 space-y-10" id="evolution-timeline-container"></div>
                        </div>
                    </div>
                    
                    <!-- Topic AI Content Analysis -->
                    <div class="card mt-6 border-l-4 border-indigo-500">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 pb-4 border-b border-slate-100 gap-3">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 flex items-center"><i class="fas fa-align-left text-indigo-500 mr-2"></i> ä¸»é¡Œå…§å®¹æ·±åº¦åˆ†æ</h3>
                            </div>
                            <button onclick="triggerTopicSummaryAI()" class="ai-btn bg-indigo-600 hover:bg-indigo-700 shadow-md text-xs w-full md:w-auto">
                                <i class="fas fa-magic mr-2"></i> AI å…§å®¹ç¸½çµ
                            </button>
                        </div>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="w-full lg:w-3/5 bg-slate-50 rounded-lg border border-slate-200 p-4 h-[300px] overflow-y-auto">
                                <div class="flex justify-between items-center mb-3 sticky top-0 bg-slate-50 pb-2 border-b border-slate-200">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase">å°è©±å…§å®¹èšåˆ</h4>
                                    <span id="content-log-status" class="text-[10px] text-indigo-500 font-bold">--</span>
                                </div>
                                <div id="topic-content-log" class="space-y-2">
                                    <div class="text-center text-slate-400 text-sm mt-10">è«‹é¸æ“‡ä¸»é¡Œ...</div>
                                </div>
                            </div>
                            <div class="w-full lg:w-2/5 flex flex-col gap-4">
                                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-100">
                                    <h4 class="text-xs font-bold text-indigo-700 uppercase mb-2">è‡ªå‹•åˆ†æçµ±è¨ˆ</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between border-b border-indigo-100 pb-1"><span>ç¸½å­—æ•¸</span><span class="font-bold" id="topic-total-chars">0</span></div>
                                        <div class="flex justify-between border-b border-indigo-100 pb-1"><span>å¹³å‡é•·åº¦</span><span class="font-bold" id="topic-avg-len">0</span></div>
                                        <div><span class="block mb-1">æ´»èºè²¢ç»è€…</span><div id="topic-top-users" class="flex gap-1 flex-wrap"><span class="text-xs text-slate-400">-</span></div></div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-4 border border-slate-200 flex-1">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">é—œéµè©æå–</h4>
                                    <div id="topic-extracted-keywords" class="flex flex-wrap gap-2"><span class="text-xs text-slate-400">...</span></div>
                                </div>
                                <div id="topic-ai-summary-result" class="hidden bg-purple-50 rounded-lg p-4 border border-purple-100 text-sm text-slate-700 h-[150px] overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 4: è¨€è«‡å“è³ª -->
                <div id="view-quality" class="section-view space-y-4 md:space-y-6">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">èªçŸ¥è¨€è«‡å“è³ªåˆ†æ</h2><p class="text-xs md:text-sm text-slate-500">æ·±åº¦çµæ§‹èˆ‡å‹•æ…‹æµå‘</p></div>
                        <div class="w-full md:w-auto">
                            <select id="topic-selector-quality" onchange="filterDataByTopic(this.value)" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="all" selected>æ‰€æœ‰ä¸»é¡Œ</option>
                            </select>
                        </div>
                    </header>
                    <div class="card">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <div><h3 class="font-bold text-slate-800 flex items-center"><i class="fas fa-search-plus text-purple-600 mr-2"></i> æ·±åº¦å°è©±é€è¦–é¡</h3></div>
                            <div class="flex flex-wrap gap-2 text-[10px] md:text-xs font-bold bg-slate-50 px-2 py-1 rounded-lg border border-slate-200">
                                <div class="flex items-center"><span class="legend-dot dot-fact"></span> äº‹å¯¦</div><div class="flex items-center"><span class="legend-dot dot-theory"></span> ç†è«–</div><div class="flex items-center"><span class="legend-dot dot-challenge"></span> æŒ‘æˆ°</div><div class="flex items-center"><span class="legend-dot dot-synthesis"></span> æ•´åˆ</div>
                            </div>
                        </div>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="w-full lg:w-2/3 h-[300px] md:h-[350px] bg-slate-50 rounded border border-slate-100 relative"><div id="lens-network-container" class="absolute inset-0"></div></div>
                            <div class="w-full lg:w-1/3 flex flex-col justify-center">
                                <div class="lens-detail-box" id="lens-detail"><div class="lens-detail-title text-slate-500"><i class="fas fa-mouse-pointer mr-2"></i> è«‹é»æ“Šåœ–è¡¨ç¯€é»</div><p class="text-slate-400 text-xs">æŸ¥çœ‹å°è©±é·ç§»æ„ç¾©ã€‚</p></div>
                                <div class="mt-4 text-right"><button class="ref-btn" onclick="openRef('lens')"><i class="fas fa-book"></i> Ref</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div><h3 class="font-bold text-slate-800 flex items-center"><i class="fas fa-stream text-blue-500 mr-2"></i> é—œéµå°è©±æµ</h3></div>
                            <button class="ref-btn" onclick="openRef('stream')"><i class="fas fa-book"></i> Ref</button>
                        </div>
                        <div class="h-[300px] w-full relative"><canvas id="streamChart"></canvas></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="note-detail-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header bg-indigo-50">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center"><i class="fas fa-sticky-note mr-2"></i> ç™¼è¨€è©³æƒ…</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <span id="nd-type" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-700 uppercase">TYPE</span>
                    <span id="nd-date" class="text-xs text-slate-400 ml-2">Date</span>
                </div>
                <h2 id="nd-title" class="text-xl font-bold text-slate-800 mb-4">Title</h2>
                <div id="nd-content" class="text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-100 whitespace-pre-wrap">Content</div>
                <div class="mt-4 flex items-center justify-end">
                    <span class="text-xs text-slate-400 mr-2">Author:</span>
                    <span id="nd-author" class="text-sm font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded">User</span>
                </div>
            </div>
        </div>
    </div>

    <div id="ref-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800 flex items-center"><i class="fas fa-chart-line text-blue-500 mr-2"></i> åˆ†æå ±å‘Š</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="modal-body" id="ref-modal-body">
                <div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-slate-300"></i></div>
            </div>
        </div>
    </div>

    <script>
        // --- Mobile Specific Functions ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('sidebar-closed');
            
            if (isClosed) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        }

        // --- Original Logic Preserved Below ---
        const STORAGE_KEY = 'kb_platform_v2_28_data';
        let globalClassStats = {}; 
        let globalAllNotes = []; 
        let globalRawDB = {};
        let currentModalTopic = ''; 
        let activeTopicFilter = 'all';

        const kbTypeMap = { 'question': 'æå•', 'extend': 'å»¶ä¼¸', 'improve': 'æ”¹é€²', 'riseabove': 'æ˜‡è¯', 'counter': 'åé§', 'undefined': 'Note' };
        const lensInteractions = {
            'Fact': { title: 'äº‹å¯¦', text: 'æè¿°ç¾è±¡ã€‚', color: 'border-l-slate-400 bg-slate-50' },
            'Theory': { title: 'ç†è«–', text: 'å€‹äººè§£é‡‹ã€‚', color: 'border-l-blue-500 bg-blue-50' },
            'Challenge': { title: 'æŒ‘æˆ°', text: 'æå‡ºåè­‰ã€‚', color: 'border-l-yellow-500 bg-yellow-50' },
            'Synthesis': { title: 'æ•´åˆ', text: 'æ­¸ç´è§€é»ã€‚', color: 'border-l-green-500 bg-green-50' }
        };

        function generateRealExamplesForLens(nodes) {
             const findNote = (types) => {
                const candidates = nodes.filter(n => types.includes(n.type));
                return candidates.length > 0 ? `ã€Œ${candidates[Math.floor(Math.random()*candidates.length)].content.substring(0,30)}...ã€` : "ï¼ˆå°šç„¡è³‡æ–™ï¼‰";
            };
            if(lensInteractions['Fact']) lensInteractions['Fact'].example = findNote(['question', 'extend']);
            if(lensInteractions['Theory']) lensInteractions['Theory'].example = findNote(['improve']);
            if(lensInteractions['Challenge']) lensInteractions['Challenge'].example = findNote(['counter']);
            if(lensInteractions['Synthesis']) lensInteractions['Synthesis'].example = findNote(['riseabove']);
        }

        function getRealData() { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }

        function calculateClassOverview(db) {
            const nodes = db.nodes || []; globalRawDB = db;
            let topics = db.topics || [];
            if (topics.length === 0 && nodes.length > 0) { const uniqueTopics = [...new Set(nodes.map(n => n.topicId || 'unknown'))]; topics = uniqueTopics.map(id => ({ id: id, name: `Topic ${id.substring(0,4)}...` })); }
            populateTopicSelectors(topics);
            const filteredNodes = activeTopicFilter === 'all' ? nodes : nodes.filter(n => String(n.topicId) === String(activeTopicFilter));
            globalAllNotes = filteredNodes.map(n => ({ id: n.id, type: n.type, title: n.title, content: n.content, date: new Date(n.date).toLocaleDateString(), dateTime: new Date(n.date).getTime(), topicId: n.topicId, author: n.author }));
            const userList = db.userList || {}; const students = Object.values(userList).filter(u => u.role !== 'teacher');
            const totalNotes = filteredNodes.length; const links = filteredNodes.filter(n => n.parentId).length; const density = totalNotes > 0 ? (links / totalNotes).toFixed(2) : 0; const riseAboves = filteredNodes.filter(n => n.type === 'riseabove').length; const raRate = totalNotes > 0 ? Math.round((riseAboves / totalNotes) * 100) : 0;
            let riskCount = 0; students.forEach(u => { const count = filteredNodes.filter(n => n.author === u.id).length; if (count < 2) riskCount++; });
            globalClassStats = { totalNotes, density, raRate, riskCount, studentCount: students.length };
            generateRealExamplesForLens(filteredNodes); renderStaticDiagnosis(globalClassStats);
            return { totalNotes, density, raRate, riskCount, nodes: filteredNodes, students };
        }

        function generateLocalInsight(key, stats) {
            const d = parseFloat(stats.density || 0); const n = parseInt(stats.totalNotes || 0); const r = parseInt(stats.raRate || 0);
            if (key === 'density') return d < 0.2 ? "äº’å‹•åä½ï¼Œé¼“å‹µå›æ‡‰ã€‚" : (d < 0.5 ? "äº’å‹•å°šå¯ï¼ŒåŠ å¼·é€£çµã€‚" : "äº’å‹•ç†±çµ¡ï¼Œå˜—è©¦æ•´åˆã€‚");
            if (key === 'class_diagnosis') return `ç¶œåˆè¨ºæ–·ï¼šå¯†åº¦ ${d}ï¼Œç™¼æ–‡ ${n}ã€‚å»ºè­°é—œæ³¨ ${d<0.3 ? 'äº’å‹•é »ç‡' : 'å°è©±å“è³ª'}ã€‚`;
            return "æ•¸æ“šåˆ†æå®Œæˆã€‚";
        }
        function renderStaticDiagnosis(stats) { const container = document.getElementById('offline-insight-content'); if(!container) return; container.innerHTML = `<ul class="list-disc pl-5 space-y-1"><li>${generateLocalInsight('density', stats)}</li><li>æ•´åˆç‡: ${stats.raRate}%</li></ul>`; }

        function populateTopicSelectors(topics) {
            const opts = `<option value="all">æ‰€æœ‰ä¸»é¡Œ</option>` + topics.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            const s1 = document.getElementById('topic-selector-ideas'); const s2 = document.getElementById('topic-selector-quality');
            if(s1) s1.innerHTML = opts; if(s2) s2.innerHTML = opts;
            if(s1) s1.value = activeTopicFilter; if(s2) s2.value = activeTopicFilter;
        }

        function filterDataByTopic(topic) {
            activeTopicFilter = topic;
            const s1 = document.getElementById('topic-selector-ideas'); const s2 = document.getElementById('topic-selector-quality');
            if(s1) s1.value = topic; if(s2) s2.value = topic;
            if (globalRawDB && globalRawDB.nodes) {
                initOverview(globalRawDB);
                document.getElementById('concept-network-container').innerHTML = ''; document.getElementById('promisingness-container').innerHTML = ''; document.getElementById('evolution-timeline-container').innerHTML = '';
                setTimeout(() => { initConceptNetwork(); initLexicalChart(); initPromisingnessChart(); initEvolutionTimeline(); initTopicContentAnalysis(); if(document.querySelector('#view-quality.active')) { initDeepLens(); initStreamChart(); } }, 100);
            }
        }
        
        function refreshDashboardData() {
            const btn = document.getElementById('btn-refresh'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            setTimeout(() => { const db = getRealData(); if (db) { renderStudentSidebar(db); initOverview(db); document.getElementById('db-status-text').innerText = "Synced: " + new Date().toLocaleTimeString(); } btn.innerHTML = '<i class="fas fa-sync-alt w-5"></i><span>åˆ·æ–°æ•¸æ“š</span>'; }, 600);
        }

        function calculateStudentMetrics(db, userId) {
            if (!db || !db.userList) return null; const user = Object.values(db.userList).find(u => u.id === userId); if (!user) return null;
            const myNodes = (db.nodes || []).filter(n => n.author === userId); const noteCount = myNodes.length;
            const scaffoldCounts = { question:0, extend:0, improve:0, counter:0, riseabove:0 }; myNodes.forEach(n => { if (scaffoldCounts[n.type] !== undefined) scaffoldCounts[n.type]++; });
            const egoNodes = new Set(); const egoEdges = []; egoNodes.add(userId);
            myNodes.forEach(n => { if(n.parentId) { const p = db.nodes.find(p => p.id === n.parentId); if(p && p.author !== userId) { egoNodes.add(p.author); egoEdges.push({from: userId, to: p.author}); } } });
            (db.nodes || []).forEach(n => { if(n.parentId) { const p = db.nodes.find(p => p.id === n.parentId); if(p && p.author === userId && n.author !== userId) { egoNodes.add(n.author); egoEdges.push({from: n.author, to: userId}); } } });
            const visNodes = Array.from(egoNodes).map(uid => { const u = Object.values(db.userList).find(x => x.id === uid); return { id: uid, label: u ? u.name : '?', color: uid === userId ? '#3b82f6' : '#94a3b8', size: uid === userId ? 20 : 10, font: { color: uid === userId ? 'white' : 'black' } }; });
            const depthTrend = [1,2,3,2,4]; // Simplified
            return { user, noteCount, scaffoldCounts, visNodes, visEdges: egoEdges, depthTrend, radarData: [Math.min(scaffoldCounts.question*10+20,100), Math.min(scaffoldCounts.extend*10+20,100), Math.min(scaffoldCounts.improve*10+20,100), Math.min(scaffoldCounts.riseabove*20,100), Math.min(egoEdges.length*10+10,100)], suggestions: ["å¤šå›æ‡‰ä»–äºº", "å˜—è©¦æ•´åˆè§€é»"] };
        }

        function renderStudentSidebar(db) {
            const container = document.getElementById('student-list-container'); container.innerHTML = '';
            const students = Object.values(db.userList || {}).filter(u => u.role !== 'teacher');
            document.getElementById('student-count-badge').innerText = `${students.length} äºº`;
            if (students.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 py-4 text-xs">æš«ç„¡å­¸ç”Ÿ</div>'; return; }
            students.forEach(s => {
                const el = document.createElement('div'); el.className = 'student-item p-3 rounded-lg cursor-pointer border border-transparent hover:bg-slate-50 transition mb-2'; el.id = `student-btn-${s.id}`; el.onclick = () => loadStudentData(s.id);
                el.innerHTML = `<div class="flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">${s.name ? s.name[0] : '?'}</div><div class="font-bold text-slate-700 text-sm">${s.name}</div></div></div>`;
                container.appendChild(el);
            });
        }

        let radarChartInstance, studentDepthChartInstance, egoNetworkInstance;
        function loadStudentData(userId) {
            const db = getRealData(); const data = calculateStudentMetrics(db, userId); if (!data) return;
            document.querySelectorAll('.student-item').forEach(el => el.classList.remove('active-student', 'bg-indigo-50', 'border-indigo-200'));
            const btn = document.getElementById(`student-btn-${userId}`); if(btn) btn.classList.add('active-student', 'bg-indigo-50', 'border-indigo-200');
            document.getElementById('profile-name').innerText = data.user.name; document.getElementById('profile-id').innerText = data.user.id; document.getElementById('profile-notes-count').innerText = data.noteCount; document.getElementById('profile-avatar').innerText = data.user.name[0]; document.getElementById('profile-status-text').innerText = "æ•¸æ“šåˆ†æå®Œæˆ"; document.getElementById('ai-suggestions').innerHTML = data.suggestions.map(s => `<div class="flex gap-2"><i class="fas fa-check-circle text-green-500 mt-1"></i><div class="text-xs text-slate-700">${s}</div></div>`).join(''); document.getElementById('ego-metric').innerText = `é€£çµ: ${data.visEdges.length}`;
            
            const ctxR = document.getElementById('radarChart').getContext('2d'); if(radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctxR, { type: 'radar', data: { labels: ['æå•','å»¶ä¼¸','æ”¹é€²','æ•´åˆ','ç¤¾äº¤'], datasets: [{ label: data.user.name, data: data.radarData, backgroundColor:'rgba(59,130,246,0.2)', borderColor:'#3B82F6' }] }, options: { responsive:true, maintainAspectRatio:false, scales: { r: { suggestedMin: 0, ticks:{display:false} } }, plugins:{legend:{display:false}} } });
            
            const ctxD = document.getElementById('studentDepthChart').getContext('2d'); if(studentDepthChartInstance) studentDepthChartInstance.destroy();
            studentDepthChartInstance = new Chart(ctxD, { type: 'line', data: { labels: ['1','2','3','4','5'], datasets: [{ data: data.depthTrend, borderColor:'#8B5CF6', tension:0.4 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{display:false}, x:{display:false}} } });

            const container = document.getElementById('ego-network-container'); if(egoNetworkInstance) { egoNetworkInstance.destroy(); egoNetworkInstance = null; }
            egoNetworkInstance = new vis.Network(container, { nodes: new vis.DataSet(data.visNodes), edges: new vis.DataSet(data.visEdges) }, { nodes: { shape: 'dot' }, edges: { arrows: 'to' }, physics: { stabilization: true }, interaction: { zoomView: false } }); setTimeout(() => egoNetworkInstance.fit(), 100);
        }

        let overviewNetwork, principlesChartInstance, kbPrinciplesChartInstance;
        function initOverview(db) {
            const stats = calculateClassOverview(db);
            document.getElementById('total-notes-count').innerText = stats.totalNotes; document.getElementById('network-density').innerText = stats.density; document.getElementById('rise-above-rate').innerText = stats.raRate + '%'; document.getElementById('risk-student-count').innerText = stats.riskCount;
            
            const container = document.getElementById('overview-network-container'); if(overviewNetwork) { overviewNetwork.destroy(); overviewNetwork = null; }
            const nodesData = stats.students.map((u, i) => ({ id: u.id, label: u.name, color: '#3b82f6', shape: 'dot', size: 10 }));
            const edgesData = []; stats.nodes.forEach(n => { if(n.parentId) { const p = stats.nodes.find(x => x.id === n.parentId); if(p && p.author !== n.author) edgesData.push({from: n.author, to: p.author}); } });
            overviewNetwork = new vis.Network(container, { nodes: new vis.DataSet(nodesData), edges: new vis.DataSet(edgesData) }, { physics: { stabilization: true } });
            
            const ctx1 = document.getElementById('principlesChart').getContext('2d'); const typeCounts = { question:0, extend:0, improve:0, counter:0, riseabove:0 }; stats.nodes.forEach(n => { if (typeCounts[n.type] !== undefined) typeCounts[n.type]++; });
            if(principlesChartInstance) principlesChartInstance.destroy(); principlesChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['æå•', 'å»¶ä¼¸', 'æ”¹é€²', 'åé§', 'æ•´åˆ'], datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6', '#eab308', '#22c55e', '#ef4444', '#a855f7'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}} } });

            const ctx2 = document.getElementById('kbPrinciplesChart').getContext('2d'); if(kbPrinciplesChartInstance) kbPrinciplesChartInstance.destroy();
            kbPrinciplesChartInstance = new Chart(ctx2, { type: 'radar', data: { labels: ['å¤šæ¨£æ€§', 'è²¬ä»»', 'çœŸå¯¦', 'æ¬Šå¨', 'æ”¹é€²', 'æ°‘ä¸»'], datasets: [{ data: [85, 70, 80, 40, 75, 90], backgroundColor: 'rgba(234, 179, 8, 0.2)', borderColor: '#eab308' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { ticks: { display: false } } }, plugins: { legend: { display: false } } } });
        }

        function switchView(viewName) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active')); document.getElementById('view-' + viewName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active', 'bg-slate-900', 'border-l-4', 'border-blue-500'); el.classList.add('text-slate-400'); });
            const activeNav = document.getElementById('nav-' + viewName); activeNav.classList.add('active', 'bg-slate-900', 'text-white', 'border-l-4', 'border-blue-500'); activeNav.classList.remove('text-slate-400');
            if (viewName === 'quality') setTimeout(() => { initDeepLens(); initStreamChart(); }, 100);
            else if (viewName === 'topics') setTimeout(() => { initConceptNetwork(); initLexicalChart(); initPromisingnessChart(); initEvolutionTimeline(); initTopicContentAnalysis(); }, 100);
            else if (viewName === 'overview') setTimeout(() => { initOverview(globalRawDB); }, 100);
            else if (viewName === 'students') { const active = document.querySelector('.active-student'); if (active) loadStudentData(active.id.replace('student-btn-', '')); else { const first = document.querySelector('.student-item'); if(first) first.click(); } }
        }

        let lensNetwork;
        function initDeepLens() {
            const container = document.getElementById('lens-network-container'); if(container.innerHTML !== "") return;
            const nodes = new vis.DataSet([ { id: 'Fact', label: 'äº‹å¯¦', color: '#cbd5e1' }, { id: 'Theory', label: 'ç†è«–', color: '#3b82f6', font:{color:'white'} }, { id: 'Challenge', label: 'æŒ‘æˆ°', color: '#eab308', font:{color:'white'} }, { id: 'Synthesis', label: 'æ•´åˆ', color: '#22c55e', font:{color:'white'} } ]);
            const edges = new vis.DataSet([ { from: 'Fact', to: 'Theory' }, { from: 'Theory', to: 'Challenge' }, { from: 'Challenge', to: 'Synthesis' }, { from: 'Theory', to: 'Synthesis' } ]);
            lensNetwork = new vis.Network(container, { nodes, edges }, { nodes: { shape: 'dot' }, edges: { arrows: 'to' }, physics: { stabilization: true } });
            lensNetwork.on("click", function (params) {
                const detailBox = document.getElementById('lens-detail'); let info = null; if (params.nodes.length > 0) info = lensInteractions[params.nodes[0]];
                if (info) detailBox.innerHTML = `<div class="lens-detail-title text-slate-700 ${info.color.split(' ')[0].replace('bg-','text-')}">${info.title}</div><p class="text-slate-600 text-xs">${info.text}</p><div class="example-quote text-xs">${info.example || "ç„¡ç¯„ä¾‹"}</div>`;
            });
        }
        
        let conceptNetworkInstance;
        function initConceptNetwork() { 
            const container = document.getElementById('concept-network-container'); if(conceptNetworkInstance) { conceptNetworkInstance.destroy(); conceptNetworkInstance = null; }
            const stopWords = ['çš„','æ˜¯','åœ¨','æœ‰','å’Œ']; const keywordMap = {}; 
            globalAllNotes.forEach(n => { const text = (n.title + " " + n.content).toLowerCase(); text.split(/[\s,ï¼Œ.ã€‚:ï¼š!?ï¼ï¼Ÿ]+/).forEach(t => { if (t.length > 1 && !stopWords.includes(t)) { if (!keywordMap[t]) keywordMap[t] = []; if(!keywordMap[t].includes(n.id)) keywordMap[t].push(n.id); } }); });
            const sortedKeywords = Object.keys(keywordMap).sort((a,b) => keywordMap[b].length - keywordMap[a].length).slice(0, 10);
            if (sortedKeywords.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 py-10 text-xs">ç„¡æ•¸æ“š</div>'; return; }
            const nodesData = sortedKeywords.map(w => ({ id: w, label: w, value: keywordMap[w].length, color: '#dbeafe', shape: 'dot' }));
            const edgesData = [];
            for (let i = 0; i < sortedKeywords.length; i++) { for (let j = i + 1; j < sortedKeywords.length; j++) { const intersection = keywordMap[sortedKeywords[i]].filter(id => keywordMap[sortedKeywords[j]].includes(id)); if (intersection.length > 0) edgesData.push({ from: sortedKeywords[i], to: sortedKeywords[j], value: intersection.length }); } }
            conceptNetworkInstance = new vis.Network(container, { nodes: new vis.DataSet(nodesData), edges: new vis.DataSet(edgesData) }, { nodes: { scaling: { min: 10, max: 20 } }, physics: { stabilization: false } });
        }
        
        let lexicalChartInstance;
        function initLexicalChart() { 
            const ctx = document.getElementById('lexicalChart').getContext('2d'); if (lexicalChartInstance) lexicalChartInstance.destroy(); 
            lexicalChartInstance = new Chart(ctx, { type: 'line', data: { labels: ['W1', 'W2', 'W3', 'Now'], datasets: [{ label: 'é—œéµå­—', data: [5, 12, 18, 25], borderColor: '#8b5cf6', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } }); 
        }

        function initPromisingnessChart() {
            const container = document.getElementById('promisingness-container'); container.innerHTML = '<div class="absolute bottom-2 right-2 text-[10px] text-slate-400">é—œæ³¨ â†’</div><div class="absolute top-2 left-2 text-[10px] text-slate-400">è½å·® â†“</div>';
            if (globalAllNotes.length === 0) return;
            globalAllNotes.forEach(n => {
                const dot = document.createElement('div'); dot.className = 'absolute w-2 h-2 rounded-full cursor-pointer'; 
                dot.style.left = `${Math.random()*80+10}%`; dot.style.bottom = `${Math.random()*80+10}%`;
                dot.style.backgroundColor = n.type === 'question' ? '#ef4444' : '#3b82f6';
                dot.onclick = () => viewNote(n.id);
                container.appendChild(dot);
            });
        }

        function initEvolutionTimeline() {
            const container = document.getElementById('evolution-timeline-container'); container.innerHTML = '<div class="timeline-line"></div>';
            const sorted = [...globalAllNotes].sort((a,b) => a.dateTime - b.dateTime).slice(0, 5);
            if(sorted.length === 0) container.innerHTML = '<div class="text-xs text-slate-400 pl-4">ç„¡æ•¸æ“š</div>';
            sorted.forEach(n => {
                const item = document.createElement('div'); item.className = 'relative z-10 mb-4 cursor-pointer'; item.onclick = () => viewNote(n.id);
                item.innerHTML = `<div class="absolute -left-9 top-0 w-6 h-6 bg-white rounded-full flex items-center justify-center border text-slate-400 text-[10px]"><i class="fas fa-circle"></i></div><div class="bg-white border p-2 rounded shadow-sm"><div class="text-xs font-bold text-slate-700 truncate">${n.title}</div><div class="text-[10px] text-slate-400">${n.date}</div></div>`;
                container.appendChild(item);
            });
        }

        function viewNote(noteId) {
            const n = globalAllNotes.find(x => x.id === noteId); if(!n) return;
            document.getElementById('nd-title').innerText = n.title; document.getElementById('nd-content').innerText = n.content; document.getElementById('nd-date').innerText = n.date; document.getElementById('nd-type').innerText = kbTypeMap[n.type] || n.type;
            let authorName = n.author; if (globalRawDB.userList) { const u = Object.values(globalRawDB.userList).find(u => u.id === n.author); if (u) authorName = u.name; } document.getElementById('nd-author').innerText = authorName;
            document.getElementById('note-detail-modal').classList.add('open');
        }

        function initTopicContentAnalysis() {
            const logContainer = document.getElementById('topic-content-log'); const kwContainer = document.getElementById('topic-extracted-keywords');
            logContainer.innerHTML = ''; kwContainer.innerHTML = '';
            if (globalAllNotes.length === 0) { logContainer.innerHTML = '<div class="text-center text-slate-400 text-xs mt-4">ç„¡è³‡æ–™</div>'; return; }
            let totalChars = 0; let allText = "";
            globalAllNotes.forEach(n => {
                totalChars += n.content.length; allText += n.title + " " + n.content + " ";
                const logItem = document.createElement('div'); logItem.className = 'border-b p-2 cursor-pointer hover:bg-slate-50'; logItem.onclick = () => viewNote(n.id);
                logItem.innerHTML = `<div class="font-bold text-indigo-900 text-xs truncate">${n.title}</div><p class="text-slate-500 text-[10px] truncate">${n.content}</p>`;
                logContainer.appendChild(logItem);
            });
            document.getElementById('topic-total-chars').innerText = totalChars; document.getElementById('topic-avg-len').innerText = Math.round(totalChars / globalAllNotes.length);
            kwContainer.innerHTML = '<span class="text-xs text-slate-400">åˆ†æä¸­...</span>';
        }

        async function triggerTopicSummaryAI() {
            const resDiv = document.getElementById('topic-ai-summary-result'); resDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; resDiv.classList.remove('hidden');
            let apiKey = localStorage.getItem('kb_ai_key') || localStorage.getItem('gemini_api_key');
            if (!apiKey) { apiKey = prompt("API Key?"); if(apiKey) localStorage.setItem('kb_ai_key', apiKey); else return; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Summary this topic based on: " + globalAllNotes.map(n=>n.content).join(" ") }] }] }) });
                const data = await response.json(); resDiv.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (e) { resDiv.innerHTML = "Error"; }
        }

        let streamChart;
        function initStreamChart() { 
            const ctx = document.getElementById('streamChart').getContext('2d'); if (streamChart) streamChart.destroy(); 
            streamChart = new Chart(ctx, { type: 'line', data: { labels: ['T1','T2','T3'], datasets: [{ label: 'è¨è«–é‡', data: [10, 25, 15], backgroundColor: 'rgba(59, 130, 246, 0.5)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } }); 
        }

        // Simplified Ref Data for Mobile
        const refData = {
            'class_diagnosis': { title: 'æ·±åº¦è¨ºæ–·', theory: 'æä¾›å³æ™‚è©•ä¼°ã€‚' },
            'total_notes': { title: 'ç¸½ç™¼æ–‡æ•¸', theory: 'åæ˜ ç¤¾ç¾¤æ´»èºåº¦ã€‚' },
            'density': { title: 'ç¤¾ç¾¤å¯†åº¦', theory: 'å°è©±é€£çµç·Šå¯†ç¨‹åº¦ã€‚' },
            'depth': { title: 'æ˜‡è¯ç‡', theory: 'é«˜éšçŸ¥è­˜æ•´åˆèƒ½åŠ›ã€‚' },
            'risk': { title: 'éœ€å¼•å°', theory: 'è­˜åˆ¥ä½åƒèˆ‡å­¸ç”Ÿã€‚' },
            'sna': { title: 'äº’å‹•çµæ§‹', theory: 'æ„è¦‹é ˜è¢–èˆ‡å­¤å³¶ã€‚' },
            'principles': { title: 'é·¹æ¶åˆ†ä½ˆ', theory: 'æ€è€ƒé¡å‹å¤šæ¨£æ€§ã€‚' },
            'kb12': { title: 'KB 12åŸå‰‡', theory: 'ç’°å¢ƒæª¢æ ¸æ¨™æº–ã€‚' },
            'depth_trajectory': { title: 'èªçŸ¥æ¼”åŒ–', theory: 'å€‹äººæ·±åº¦æˆé•·ã€‚' },
            'radar': { title: 'èƒ½åŠ› DNA', theory: 'å¤šç¶­åº¦èƒ½åŠ›ã€‚' },
            'ego': { title: 'è‡ªæˆ‘äº’å‹•åœˆ', theory: 'å€‹äººå½±éŸ¿åŠ›ã€‚' },
            'promisingness': { title: 'æ½›åŠ›ç†±é»', theory: 'é«˜åƒ¹å€¼è§€é»ã€‚' },
            'concept_network': { title: 'èªç¾©ç¶²çµ¡', theory: 'æ¦‚å¿µé—œè¯ã€‚' },
            'lexical_growth': { title: 'è©å½™æˆé•·', theory: 'å°ˆæ¥­è¡“èªä½¿ç”¨ã€‚' },
            'rise_above': { title: 'æ¼”åŒ–è·¯å¾‘', theory: 'è§€é»æ”¹é€²æ­·ç¨‹ã€‚' },
            'lens': { title: 'å°è©±é€é¡', theory: 'èªçŸ¥å±¤æ¬¡åˆ†é¡ã€‚' },
            'stream': { title: 'å°è©±æµ', theory: 'å‹•æ…‹æµé‡è®ŠåŒ–ã€‚' }
        };

        function openRef(key) {
            currentModalTopic = key; const data = refData[key] || { title: 'åˆ†ææŒ‡æ¨™', theory: 'è¼‰å…¥ä¸­...' };
            document.getElementById('modal-title').innerText = data.title;
            const insightText = generateLocalInsight(key, globalClassStats);
            document.getElementById('ref-modal-body').innerHTML = `
                <div class="ref-section"><div class="ref-section-title ref-theory-title">ç†è«–èƒŒæ™¯</div><div class="ref-theory-box text-sm">${data.theory}</div></div>
                <div class="ref-section"><div class="ref-section-title ref-insight-title">æ•¸æ“šè¨ºæ–·</div><div class="ref-insight-box text-sm">${insightText}</div></div>
                <div class="mt-4 pt-4 border-t"><button class="ai-btn" onclick="triggerAIAnalysis()"><i class="fas fa-magic mr-2"></i> AI å°ˆå®¶å»ºè­°</button><div id="modal-ai-result" class="mt-2 text-sm bg-purple-50 p-2 rounded hidden"></div></div>
            `;
            document.getElementById('ref-modal').classList.add('open');
        }

        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open')); }

        async function triggerAIAnalysis() {
            const res = document.getElementById('modal-ai-result'); res.innerHTML = 'åˆ†æä¸­...'; res.classList.remove('hidden');
            let apiKey = localStorage.getItem('kb_ai_key') || localStorage.getItem('gemini_api_key');
             if (!apiKey) { apiKey = prompt("API Key?"); if(apiKey) localStorage.setItem('kb_ai_key', apiKey); else return; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `åˆ†æ ${currentModalTopic}ã€‚æ•¸æ“š: ${JSON.stringify(globalClassStats)}` }] }] }) });
                const data = await response.json(); res.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (e) { res.innerHTML = "Error"; }
        }

        window.onload = function() {
            const db = getRealData();
            const dbStatus = document.getElementById('db-status-text');
            if (db) {
                dbStatus.innerText = "Local Data"; dbStatus.className = "text-green-400 font-bold";
                renderStudentSidebar(db); initOverview(db); switchView('overview');
            } else {
                dbStatus.innerText = "No Data"; dbStatus.className = "text-red-400 font-bold";
                alert("ç„¡æ•¸æ“šï¼Œè«‹å…ˆè‡³è«–å£‡ç”¢ç”Ÿå…§å®¹ã€‚");
            }
        };
    </script>
</body>
</html>
