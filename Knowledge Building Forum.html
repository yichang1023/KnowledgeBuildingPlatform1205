<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çŸ¥è­˜å»ºæ§‹å”ä½œå¹³å° (KB Platform) - Mobile Optimized</title>
    
    <!-- ğŸ”¥ [ADDED] 1. å¼•å…¥ Firebase SDK (é›²ç«¯é€šè¨Šæ¨¡çµ„) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        kb: {
                            blue: '#3b82f6',
                            yellow: '#eab308',
                            green: '#22c55e',
                            red: '#ef4444',
                            purple: '#a855f7',
                        }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    <style>
        html, body { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ²å‹•ï¼Œäº¤ç”±å®¹å™¨è™•ç† */
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        #canvas-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: -1;
        }
        
        /* é€šç”¨æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scroll {
            -webkit-overflow-scrolling: touch; /* iOS æ»‘é †æ»¾å‹• */
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .node-card {
            transition: box-shadow 0.2s, transform 0.2s; 
            user-select: none; touch-action: none; -webkit-user-select: none;
            will-change: left, top; 
        }
        .node-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }
        .node-card.selected-node {
            box-shadow: 0 0 0 3px #3b82f6, 0 10px 15px -3px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            z-index: 60;
        }
        .promising-node {
            box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.3), 0 0 20px rgba(251, 146, 60, 0.4);
            border-color: #f97316 !important;
        }
        .cluster-zone {
            position: absolute;
            border: 2px dashed rgba(203, 213, 225, 0.6);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
            pointer-events: none;
            transition: all 0.5s ease-in-out;
            background: rgba(255, 255, 255, 0.4);
        }
        .cluster-title {
            font-weight: 700;
            font-size: 1rem;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        path.connection { fill: none; stroke-width: 2; transition: stroke 0.3s; pointer-events: none; }
        
        #selection-box {
            position: fixed;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.5);
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @keyframes pulse-gentle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .ai-pulse { animation: pulse-gentle 2s infinite; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in-up 0.5s ease-out forwards; }
        
        .category-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .category-scroll-container::-webkit-scrollbar { display: none; }
        @media (min-width: 768px) {
            .category-scroll-container { overflow-x: visible; }
        }

        .nav-btn.active { color: #4f46e5; background-color: #e0e7ff; }
        .mobile-nav-btn.active { color: #4f46e5; }
        .filter-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; border-color: rgb(226, 232, 240); }
        .filter-btn.active { background-color: rgb(238, 242, 255); color: rgb(79, 70, 229); border-color: rgb(165, 180, 252); }
        
        #canvas-wrapper { touch-action: none; }
        .category-tag { cursor: pointer; transition: all 0.2s; user-select: none; }
        .category-tag.selected { background-color: #e0e7ff; color: #4338ca; border-color: #818cf8; }

        /* Mobile specific padding helper */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-full w-full flex flex-col font-sans">

    <!-- Top Navbar -->
    <nav class="h-14 md:h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 z-50 shadow-sm relative shrink-0">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg md:text-xl shrink-0">KB</div>
            <div>
                <h1 class="font-bold text-base md:text-lg leading-tight text-slate-800 truncate max-w-[120px] md:max-w-none">çŸ¥è­˜å»ºæ§‹å¹³å°</h1>
                <p class="text-[10px] md:text-xs text-slate-500 hidden md:block">Knowledge Building Environment (v2.30)</p>
            </div>
        </div>
        
        <!-- Desktop Nav -->
        <div class="hidden md:flex items-center bg-slate-100 p-1 rounded-lg gap-1">
            <button onclick="window.location.href='index.html'" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition flex items-center gap-1"><i class="fa-solid fa-home"></i> é¦–é </button>
            <button onclick="window.app.router('entrance')" data-nav="entrance" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition flex items-center gap-1"><i class="fa-solid fa-layer-group"></i> è«–å£‡å…¥å£</button>
            <button onclick="window.app.router('canvas')" data-nav="canvas" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition flex items-center gap-1"><i class="fa-solid fa-project-diagram"></i> çŸ¥è­˜åœ°åœ–</button>
            
            <!-- External Links Dropdown -->
            <div class="relative group">
                <button class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition flex items-center gap-1">
                    <i class="fa-solid fa-chart-line"></i> åˆ†æä¸­æ¨ <i class="fa-solid fa-chevron-down text-[10px] ml-1"></i>
                </button>
                <div class="absolute top-full right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-slate-100 hidden group-hover:block overflow-hidden z-50">
                    <a href="ANALYTICS-student.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-indigo-600"><i class="fa-solid fa-user-graduate mr-2"></i> å­¸ç”Ÿå„€è¡¨æ¿</a>
                    <a href="ANALYTICS-teacher.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-indigo-600"><i class="fa-solid fa-chalkboard-user mr-2"></i> è€å¸«å„€è¡¨æ¿</a>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-4">
            <div id="ai-persona-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs font-medium border border-indigo-100">
                <i class="fa-solid fa-robot ai-pulse"></i>
                <span id="active-ai-role">AI å”ä½œä¸­</span>
            </div>
            <div class="h-6 w-px bg-slate-200 mx-1 md:mx-2 hidden md:block"></div>
            <div class="flex items-center gap-2 group relative">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-slate-200 object-cover border border-slate-300 shrink-0">
                <div class="text-right hidden sm:block">
                    <div id="user-name" class="text-sm font-semibold">User</div>
                    <div id="user-role" class="text-xs text-slate-500">Role</div>
                </div>
                <button onclick="window.app.toggleUserMenu()" class="ml-1 md:ml-2 text-slate-400 hover:text-indigo-600 p-1"><i class="fa-solid fa-chevron-down"></i></button>
                <div id="user-menu" class="absolute top-full right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-slate-100 hidden overflow-hidden z-[100]"></div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 relative overflow-hidden bg-slate-50 w-full"></main>

    <!-- Desktop Footer -->
    <footer class="hidden md:flex bg-white border-t border-slate-200 px-4 py-2 text-center z-40 text-[10px] md:text-xs text-slate-500 justify-center items-center gap-2 shrink-0">
        <i class="fa-solid fa-seedling text-green-500"></i>
        <span class="truncate">çŸ¥è­˜å»ºæ§‹ï¼šåœ¨æœªå®Œæˆçš„ç†è§£ä¸­å½¼æ­¤æ‰¿æ“”è²¬ä»»ï¼Œä½¿æƒ³æ³•åœ¨ç¤¾ç¾¤è£¡ä¸æ–·å‘æ›´å¥½çš„è§£é‡‹æ¼”åŒ–ã€‚</span>
    </footer>

    <!-- Mobile Bottom Navigation (Fixed at bottom) -->
    <!-- Added padding-bottom for safe area -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center z-50 pb-safe h-14 box-content">
        <button onclick="window.location.href='index.html'" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full pt-1 text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-home text-lg mb-0.5"></i> <span class="text-[10px]">é¦–é </span></button>
        <button onclick="window.app.router('entrance')" data-nav="entrance" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full pt-1 text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-layer-group text-lg mb-0.5"></i> <span class="text-[10px]">è«–å£‡</span></button>
        <button onclick="window.app.router('canvas')" data-nav="canvas" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full pt-1 text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-project-diagram text-lg mb-0.5"></i> <span class="text-[10px]">åœ°åœ–</span></button>
        <button onclick="window.app.openAnalyticsMenu()" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full pt-1 text-slate-400 hover:text-indigo-600"><i class="fa-solid fa-chart-line text-lg mb-0.5"></i> <span class="text-[10px]">åˆ†æ</span></button>
    </div>

    <!-- Mobile Analytics Menu Modal -->
    <div id="modal-analytics-menu" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-end justify-center">
        <div class="bg-white w-full rounded-t-xl p-6 pb-10 space-y-4 animate-fade-in-up">
            <h3 class="text-lg font-bold text-slate-800 border-b pb-2 mb-2">å‰å¾€åˆ†æä¸­æ¨</h3>
            <a href="ANALYTICS-student.html" class="flex items-center gap-3 p-4 bg-indigo-50 text-indigo-700 rounded-xl font-bold hover:bg-indigo-100 transition">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-xl"><i class="fa-solid fa-user-graduate"></i></div>
                <span>å­¸ç”Ÿå„€è¡¨æ¿ (Student)</span>
            </a>
            <a href="ANALYTICS-teacher.html" class="flex items-center gap-3 p-4 bg-emerald-50 text-emerald-700 rounded-xl font-bold hover:bg-emerald-100 transition">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-xl"><i class="fa-solid fa-chalkboard-user"></i></div>
                <span>è€å¸«å„€è¡¨æ¿ (Teacher)</span>
            </a>
            <button onclick="window.ui.closeModal('modal-analytics-menu')" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl mt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Trash Can FAB (Adjusted position for Mobile) -->
    <button onclick="window.app.openTrash()" id="btn-trash-fab" class="fixed bottom-20 left-4 md:bottom-8 md:left-8 z-[60] bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-full w-12 h-12 md:w-14 md:h-14 shadow-lg flex items-center justify-center text-xl transition transform hover:scale-105 group" title="è³‡æºå›æ”¶æ¡¶">
        <i class="fa-solid fa-trash-can group-hover:text-red-500 transition-colors"></i>
        <span id="trash-count-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden border-2 border-white">0</span>
    </button>

    <!-- Modals (Improved Mobile Responsiveness) -->
    
    <!-- Topic Create Modal -->
    <div id="modal-topic" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-end md:items-center justify-center p-4">
        <div class="bg-white rounded-t-xl md:rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 max-h-[85vh] overflow-y-auto mb-safe md:mb-0">
            <h3 id="modal-topic-title" class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-plus text-indigo-600"></i> é–‹å•Ÿæ¢ç©¶ä¸»é¡Œ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ ¸å¿ƒå•é¡Œ</label>
                    <input type="text" id="topic-name" placeholder="ä¾‹å¦‚ï¼šç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">é¡åˆ¥ (å¯è¤‡é¸)</label>
                    <div id="topic-category-selector" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scroll p-1"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">èƒŒæ™¯èªªæ˜</label>
                    <textarea id="topic-desc" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 transition"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3 pb-safe">
                <button onclick="window.ui.closeModal('modal-topic')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button id="btn-topic-save" onclick="window.app.saveTopic()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <!-- Node Composer Modal -->
    <div id="modal-node" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-end md:items-center justify-center sm:p-4">
        <div class="bg-white rounded-t-xl sm:rounded-xl shadow-2xl w-full max-w-2xl p-4 sm:p-6 relative max-h-[90vh] overflow-y-auto flex flex-col mb-safe md:mb-0">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-lg md:text-xl font-bold">è²¢ç»æƒ³æ³•</h3>
                 <button onclick="window.ui.closeModal('modal-node')" class="text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll pb-2">
                <div class="grid grid-cols-5 gap-1 md:gap-2 mb-4"><div id="scaffold-selector" class="contents"></div></div>
                <div id="scaffold-desc" class="hidden"></div>
                <div class="mb-3">
                    <input type="text" id="node-title" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none font-bold text-base md:text-lg placeholder:font-normal" placeholder="è¼¸å…¥æƒ³æ³•æ¨™é¡Œ...">
                </div>
                <div class="relative">
                    <textarea id="node-content" rows="4" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none text-base" placeholder="è¼¸å…¥è©³ç´°å…§å®¹..."></textarea>
                </div>
                <!-- AI Box moved inside scrollable area for mobile -->
                <div id="ai-suggestion-box" class="hidden mt-2 bg-blue-50 border border-blue-100 text-blue-800 p-3 rounded-lg text-sm flex items-start gap-3 shadow-sm"><i class="fa-solid fa-lightbulb text-yellow-500 mt-1 shrink-0"></i><div><span class="font-bold block text-xs uppercase text-blue-400 mb-1">AI å»ºè­°</span><p class="text-xs md:text-sm">è©¦è‘—ç”¨ã€Œæˆ‘çš„ç†è«–æ˜¯...å› ç‚º...ã€ä¾†å»¶ä¼¸ï¼Ÿ</p></div></div>
            </div>
            
            <div class="mt-4 flex justify-end shrink-0 pt-2 border-t border-slate-100">
                <button onclick="window.app.submitNode()" class="px-6 py-2.5 bg-slate-900 text-white rounded-lg w-full md:w-auto font-bold">ç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- Node Detail Modal -->
    <div id="modal-detail" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh]">
            <div class="px-4 py-3 md:px-6 md:py-4 border-b border-slate-100 flex items-center justify-between shrink-0 bg-slate-50 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <div id="detail-scaffold-icon" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white text-lg"></div>
                    <div>
                        <div id="detail-scaffold-label" class="text-xs font-bold uppercase mb-0.5">TYPE</div>
                        <div class="flex gap-2 text-[10px] md:text-xs text-slate-500"><span id="detail-author"></span><span>â€¢</span><span id="detail-date"></span></div>
                    </div>
                </div>
                <button onclick="window.ui.closeModal('modal-detail')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto custom-scroll flex-1">
                <h2 id="detail-title" class="text-lg md:text-2xl font-bold mb-4 text-slate-900 leading-snug"></h2>
                <p id="detail-content" class="text-sm md:text-lg leading-relaxed whitespace-pre-wrap text-slate-700"></p>
            </div>
            <div class="p-3 md:p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-3 shrink-0">
                <button id="btn-detail-reply" class="px-5 py-2 bg-indigo-600 text-white rounded-lg flex items-center gap-2 text-sm font-medium w-full md:w-auto justify-center"><i class="fa-solid fa-reply"></i> å»¶ä¼¸</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/50 z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl text-center">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="text-lg font-bold mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-slate-500 text-sm mb-6">å°‡é€£åŒå­ç¯€é»ä¸€ä½µåˆªé™¤ã€‚</p>
            <div class="flex justify-center gap-3"><button onclick="window.ui.closeModal('modal-confirm')" class="px-4 py-2 border rounded-lg w-full">å–æ¶ˆ</button><button id="btn-confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg w-full">åˆªé™¤</button></div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="modal-addUser" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-user-plus text-indigo-600"></i> æ–°å¢ä½¿ç”¨è€…</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">æš±ç¨± (Nickname)</label><input type="text" id="new-user-name" placeholder="ä¾‹å¦‚ï¼šå°æ˜" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">è§’è‰²</label><select id="new-user-role" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none bg-white"><option value="student">å”åŒç ”ç©¶å“¡ (å­¸ç”Ÿ)</option><option value="teacher">é¦–å¸­ç ”ç©¶å“¡ (è€å¸«)</option></select></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="window.ui.closeModal('modal-addUser')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="window.app.createNewUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Trash Modal -->
    <div id="modal-trash" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between shrink-0 bg-red-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-red-700 flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> è³‡æºå›æ”¶æ¡¶</h3>
                <button onclick="window.ui.closeModal('modal-trash')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 text-red-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto custom-scroll flex-1"><div id="trash-list" class="space-y-3"></div></div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-between gap-3 shrink-0">
                <button onclick="window.app.emptyTrash()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-bold"><i class="fa-solid fa-ban"></i> æ¸…ç©º</button>
                <button onclick="window.ui.closeModal('modal-trash')" class="px-5 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg shadow-sm text-sm">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="selection-box"></div>
    <div id="toast-container" class="fixed bottom-20 md:bottom-10 right-4 md:right-6 z-[120] flex flex-col gap-2 pointer-events-none w-full max-w-[300px] md:w-auto items-end"></div>

    <script>
        // ğŸ”¥ [ADDED] 2. Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDPjtxtf656JHVVlj1o4cLwSylo1jDBFAc",
            authDomain: "kb-platform-1.firebaseapp.com",
            databaseURL: "https://kb-platform-1-default-rtdb.firebaseio.com",
            projectId: "kb-platform-1",
            storageBucket: "kb-platform-1.firebasestorage.app",
            messagingSenderId: "230026226847",
            appId: "1:230026226847:web:49e6f09ddfc3de0ef046aa"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const DB_COLLECTION = 'kb_platform';
        const DB_DOC = 'class_data';

        // --- 1. Global Constants ---
        window.ROLES = { LEAD: 'teacher', CO: 'student' };
        window.SCAFFOLDS = {
            question: { id: 'question', label: 'Question', icon: 'fa-circle-question', color: 'bg-blue-500', border: 'border-blue-500', bgSoft: 'bg-blue-50', text: 'text-blue-700', desc: 'æå‡ºä½ æ„Ÿèˆˆè¶£çš„å•é¡Œæˆ–ç›®å‰çš„å›°æƒ‘ï¼Œé‚€è«‹å¤¥ä¼´å€‘ä¸€èµ·æ¢ç´¢ç­”æ¡ˆã€‚' },
            extend: { id: 'extend', label: 'Build on', icon: 'fa-plus', color: 'bg-yellow-500', border: 'border-yellow-500', bgSoft: 'bg-yellow-50', text: 'text-yellow-700', desc: 'åƒè€ƒå¤¥ä¼´çš„è§€é»ï¼Œè©¦è‘—è£œå……æ›´å¤šè³‡è¨Šæˆ–æ¥çºŒè¨è«–ï¼Œè®“æƒ³æ³•æ›´é€²ä¸€æ­¥ã€‚' },
            improve: { id: 'improve', label: 'Improve', icon: 'fa-bolt', color: 'bg-green-500', border: 'border-green-500', bgSoft: 'bg-green-50', text: 'text-green-700', desc: 'ä¿®æ­£æˆ–æ”¹è‰¯ç¾æœ‰çš„è§€é»ï¼Œè®“è§£é‡‹æ›´æœ‰èªªæœåŠ›ï¼›æˆ–æ˜¯è¨˜éŒ„éˆå…‰ä¸€é–ƒçš„æ–°é»å­ã€‚' },
            counter: { id: 'counter', label: 'Counter', icon: 'fa-triangle-exclamation', color: 'bg-red-500', border: 'border-red-500', bgSoft: 'bg-red-50', text: 'text-red-700', desc: 'æå‡ºä¸åŒçš„çœ‹æ³•ã€åä¾‹æˆ–è­‰æ“šï¼Œè©¦è‘—æŒ‘æˆ°ç¾æœ‰çš„æƒ³æ³•ï¼Œæ¿€ç›ªå‡ºæ›´å¤šå¯èƒ½ã€‚' },
            riseabove: { id: 'riseabove', label: 'Rise Above', icon: 'fa-rocket', color: 'bg-purple-500', border: 'border-purple-500', bgSoft: 'bg-purple-50', text: 'text-purple-700', desc: 'æ•´åˆå¤§å®¶åˆ†æ•£çš„è¨è«–ï¼Œæ­¸ç´å‡ºä¸€å€‹æ›´å®Œæ•´ã€å±¤æ¬¡æ›´é«˜çš„çµè«–æˆ–æ–°ç™¼ç¾ã€‚' }
        };
        window.TOPIC_CATEGORIES = { 'ç§‘å­¸': 'ğŸ”¬ ç§‘å­¸', 'STEAM': 'ğŸ’¡ STEAM', 'å°ˆé¡Œèª²': 'ğŸ“ å°ˆé¡Œèª²', 'é›»æ©Ÿé›»å­': 'ğŸ“¡ é›»æ©Ÿé›»å­', 'AI': 'ğŸ¤– AI', 'èªè¨€å­¸ç¿’': 'ğŸ“™ èªè¨€å­¸ç¿’', 'æ–‡å­¸': 'ğŸ“– æ–‡å­¸', 'ç¤¾æœƒè­°é¡Œ': 'â˜ï¸ ç¤¾æœƒè­°é¡Œ', 'ç‰©ç†': 'âš›ï¸ ç‰©ç†å­¸', 'å‹•æ¼«': 'ğŸ¨ å‹•æ¼«', 'ç¨‹å¼': 'ğŸ’» ç¨‹å¼è¨­è¨ˆ', 'æ­·å²': 'ğŸ“œ æ­·å²', 'å“²å­¸': 'ğŸ¤” å“²å­¸', 'è—è¡“': 'ğŸ­ è—è¡“', 'å…¶ä»–': 'ğŸ“¦ å…¶ä»–' };
        window.STORAGE_KEY = 'kb_platform_v2_28_data'; 
        window.CLUSTER_CENTERS = { 
            'A': {x: 250, y: 300, title: 'æ ¸å¿ƒå•é¡Œæ¢ç©¶å€ (Core Question)', width: 600, height: 600}, 
            'B': {x: 1050, y: 300, title: 'å»¶ä¼¸è®Šå› è¨è«–å€ (Variables)', width: 600, height: 600}, 
            'C': {x: 650, y: 1000, title: 'çŸ¥è­˜æ˜‡è¯æ•´åˆå€ (Rise-Above)', width: 800, height: 500} 
        };

        // ğŸ”¥ [ENRICHED] Seed Data with extensive KB dialogue
        window.SEED_DATA = {
            userList: {
                teacher: { id: 'u1', name: 'ç‹æ•™æˆ', role: window.ROLES.LEAD, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=Felix' },
                student1: { id: 'u2', name: 'å°ç¾', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S1' },
                student2: { id: 'u3', name: 'å¤§è¯', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S2' },
                student3: { id: 'u4', name: 'é˜¿å‡±', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S3' },
                student4: { id: 'u5', name: 'èŠ·å©·', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S4' },
                student5: { id: 'u6', name: 'å­ç¿', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S5' },
                student6: { id: 'u7', name: 'å°è±ª', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S6' },
                student7: { id: 'u8', name: 'å®‰å®‰', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S7' },
                student8: { id: 'u9', name: 'Leo', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S8' },
                student9: { id: 'u10', name: 'Vicky', role: window.ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S9' }
            },
            topics: [
                { id: 't1', name: 'ç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ', categories: ['ç§‘å­¸', 'ç‰©ç†'], desc: 'æ¢è¨å…‰ç·šæ•£å°„èˆ‡å¤§æ°£å±¤çš„é—œä¿‚ã€‚', author: 'u1', date: '2023-10-01' },
                { id: 't2', name: 'AI æ˜¯å¦å…·æœ‰å‰µé€ åŠ›ï¼Ÿ', categories: ['AI', 'ç¤¾æœƒè­°é¡Œ', 'å“²å­¸'], desc: 'å®šç¾©å‰µé€ åŠ›èˆ‡æ©Ÿå™¨æ™ºæ…§çš„ç•Œç·šã€‚', author: 'u1', date: '2023-10-05' },
                { id: 't3', name: 'é€²æ“Šçš„å·¨äººä¸­çš„è‡ªç”±æ„å¿—', categories: ['å‹•æ¼«', 'å“²å­¸', 'æ–‡å­¸'], desc: 'è‰¾é€£çš„é¸æ“‡æ˜¯è‡ªç”±çš„å—ï¼Ÿé‚„æ˜¯è¢«å‘½é‹æŸç¸›ï¼Ÿ', author: 'u2', date: '2023-10-08' },
                { id: 't4', name: 'å¦‚ä½•ç”¨ Python è£½ä½œ Discord Bot', categories: ['ç¨‹å¼', 'STEAM'], desc: 'æ–°æ‰‹å…¥é–€æ•™å­¸èˆ‡è¨è«–ã€‚', author: 'u3', date: '2023-10-10' },
                { id: 't5', name: 'æ–‡è—å¾©èˆˆå°ç¾ä»£è—è¡“çš„å½±éŸ¿', categories: ['æ­·å²', 'è—è¡“'], desc: 'å¾é”æ–‡è¥¿åˆ°ç±³é–‹æœ—åŸºç¾…çš„éºç”¢ã€‚', author: 'u1', date: '2023-10-12' },
                { id: 't7', name: 'è‹±æ–‡å£èªªç·´ç¿’æŠ€å·§', categories: ['èªè¨€å­¸ç¿’'], desc: 'å¦‚ä½•å…‹æœé–‹å£èªªè‹±æ–‡çš„ææ‡¼ï¼Ÿ', author: 'u3', date: '2023-10-18' },
                { id: 't8', name: 'ç—…æ¯’ç®—æ˜¯ç”Ÿç‰©å—ï¼Ÿ', categories: ['ç§‘å­¸', 'å“²å­¸'], desc: 'ç”Ÿç‰©èˆ‡éç”Ÿç‰©çš„ç•Œç·šåœ¨å“ªè£¡ï¼Ÿ', author: 'u1', date: '2023-10-20' },
                { id: 't9', name: 'æ•¸å­¸æ˜¯è¢«ç™¼ç¾çš„é‚„æ˜¯è¢«ç™¼æ˜çš„ï¼Ÿ', categories: ['å“²å­¸', 'ç§‘å­¸'], desc: 'æ•¸å­¸æ˜¯å®‡å®™çš„èªè¨€é‚„æ˜¯äººé¡çš„å·¥å…·ï¼Ÿ', author: 'u1', date: '2023-10-22' }
            ],
            nodes: [
                // --- T1: ç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ (15+ nodes) ---
                { id: 'n1-1', topicId: 't1', type: 'question', title: 'æ™´å¤©èˆ‡å¤•é™½çš„é¡è‰²å·®ç•°', content: 'æˆ‘å¥½å¥‡ç‚ºä»€éº¼åªæœ‰æ™´å¤©æ˜¯è—è‰²ï¼Œå¤•é™½å»æ˜¯ç´…è‰²ï¼Ÿé€™è·Ÿå¤ªé™½çš„ä½ç½®æœ‰é—œå—ï¼Ÿ', author: 'u2', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 30 },
                { id: 'n1-2', topicId: 't1', type: 'improve', title: 'è·é›¢èˆ‡é¡è‰²çš„é—œä¿‚', content: 'é€™æ‡‰è©²è·Ÿå…‰ç·šç©¿éå¤§æ°£å±¤çš„è·é›¢æœ‰é—œã€‚è·é›¢è¶Šé•·ï¼Œç•™ä¸‹çš„å…‰è¶Šç´…ã€‚', author: 'u3', x: 100, y: 300, parentId: 'n1-1', date: Date.now()-90000, cluster: 'B', promisingness: 45 },
                { id: 'n1-3', topicId: 't1', type: 'extend', title: 'ç‘åˆ©æ•£å°„ç†è«–', content: 'æˆ‘çš„ç†è«–æ˜¯ç‘åˆ©æ•£å°„ (Rayleigh Scattering)ã€‚è—å…‰æ³¢é•·çŸ­ï¼Œå®¹æ˜“è¢«æ°£é«”åˆ†å­æ•£å°„ã€‚', author: 'u1', x: 400, y: 300, parentId: 'n1-1', date: Date.now()-85000, cluster: 'A', promisingness: 85 },
                { id: 'n1-4', topicId: 't1', type: 'counter', title: 'é™°å¤©èˆ‡é›²çš„ä¾‹å¤–', content: 'ä½†ç‘åˆ©æ•£å°„ä¸èƒ½è§£é‡‹ç‚ºä»€éº¼é™°å¤©ä¹Ÿæ˜¯ç™½è‰²çš„ï¼Œæˆ–æ˜¯é›²ç‚ºä»€éº¼æ˜¯ç™½çš„ï¼Ÿé›²ä¹Ÿæ˜¯ç”±æ°´çµ„æˆçš„å§ï¼Ÿ', author: 'u4', x: 400, y: 500, parentId: 'n1-3', date: Date.now()-80000, cluster: 'A', promisingness: 90 },
                { id: 'n1-5', topicId: 't1', type: 'improve', title: 'ç±³æ°æ•£å°„è§£é‡‹é›²æœµ', content: 'é›²æ˜¯ç™½è‰²çš„å¯ä»¥ç”¨ã€Œç±³æ°æ•£å°„ (Mie Scattering)ã€è§£é‡‹ï¼Œå› ç‚ºæ°´æ»´é¡†ç²’æ¯”æ°£é«”åˆ†å­å¤§å¾ˆå¤šï¼Œæ‰€æœ‰æ³¢é•·éƒ½æ•£å°„ï¼Œæ··åˆæˆç™½å…‰ã€‚', author: 'u5', x: 600, y: 600, parentId: 'n1-4', date: Date.now()-75000, cluster: 'B', promisingness: 80 },
                { id: 'n1-6', topicId: 't1', type: 'riseabove', title: 'æ•£å°„èˆ‡é¡†ç²’å¤§å°çš„æ•´åˆæ¨¡å‹', content: 'æ•´åˆè§€é»ï¼šå¤©ç©ºé¡è‰²å–æ±ºæ–¼ã€Œæ•£å°„é¡†ç²’å¤§å°ã€èˆ‡ã€Œå…‰æ³¢é•·ã€çš„é—œä¿‚ã€‚å¾®å°æ°£é«”åˆ†å­é€ æˆç‘åˆ©æ•£å°„(è—/ç´…)ï¼Œè¼ƒå¤§æ°´æ»´é€ æˆç±³æ°æ•£å°„(ç™½)ã€‚', author: 'u6', x: 800, y: 700, parentId: 'n1-5', date: Date.now()-70000, cluster: 'C', promisingness: 95 },
                { id: 'n1-7', topicId: 't1', type: 'counter', title: 'é‚£ç´«è‰²å‘¢ï¼Ÿ', content: 'ç´«å…‰çš„æ³¢é•·æ¯”è—å…‰æ›´çŸ­ï¼Œç…§ç†èªªæ•£å°„æ‡‰è©²æ›´å¼·ï¼Œç‚ºä»€éº¼å¤©ç©ºä¸æ˜¯ç´«è‰²çš„ï¼Ÿ', author: 'u7', x: 500, y: 400, parentId: 'n1-3', date: Date.now()-65000, cluster: 'A', promisingness: 60 },
                { id: 'n1-8', topicId: 't1', type: 'improve', title: 'äººçœ¼çš„æ•æ„Ÿåº¦', content: 'é€™è·Ÿæˆ‘å€‘çš„çœ¼ç›æ§‹é€ æœ‰é—œï¼äººçœ¼å°ç¶ è‰²å’Œè—è‰²æ¯”è¼ƒæ•æ„Ÿï¼Œå°ç´«è‰²çš„æ•æ„Ÿåº¦è¼ƒä½ã€‚', author: 'u8', x: 600, y: 500, parentId: 'n1-7', date: Date.now()-60000, cluster: 'B', promisingness: 70 },
                { id: 'n1-9', topicId: 't1', type: 'extend', title: 'å¤ªé™½å…‰è­œçš„åˆ†ä½ˆ', content: 'é™¤äº†çœ¼ç›ï¼Œå¤ªé™½è¼»å°„å‡ºçš„èƒ½é‡ä¸­ï¼Œç´«å…‰çš„ä½”æ¯”ä¹Ÿæœ¬ä¾†å°±æ¯”è—å…‰å°‘ã€‚', author: 'u9', x: 700, y: 550, parentId: 'n1-8', date: Date.now()-55000, cluster: 'B', promisingness: 75 },
                { id: 'n1-10', topicId: 't1', type: 'question', title: 'å¤–æ˜Ÿçƒçš„å¤©ç©ºï¼Ÿ', content: 'å¦‚æœåœ¨ç«æ˜Ÿä¸Šï¼Œå¤©ç©ºæœƒæ˜¯ä»€éº¼é¡è‰²ï¼Ÿé‚£é‚Šçš„å¤§æ°£å±¤æˆåˆ†ä¸åŒå§ï¼Ÿ', author: 'u10', x: 100, y: 500, parentId: 'n1-1', date: Date.now()-50000, cluster: 'A', promisingness: 50 },
                { id: 'n1-11', topicId: 't1', type: 'extend', title: 'ç«æ˜Ÿçš„ç´…è‰²å¤©ç©º', content: 'æˆ‘çœ‹éNASAç…§ç‰‡ï¼Œç«æ˜Ÿå¤©ç©ºé€šå¸¸æ˜¯ç´…è¤è‰²çš„ï¼Œé€™è·Ÿç©ºæ°£ä¸­çš„æ°§åŒ–éµå¡µåŸƒæœ‰é—œã€‚', author: 'u2', x: 200, y: 600, parentId: 'n1-10', date: Date.now()-45000, cluster: 'A', promisingness: 65 },
                { id: 'n1-12', topicId: 't1', type: 'riseabove', title: 'å¤§æ°£æˆåˆ†èˆ‡é¡è‰²çš„æ™®é©åŸå‰‡', content: 'æ‰€ä»¥æˆ‘å€‘å¯ä»¥æ­¸ç´å‡ºï¼šå¤©ç©ºé¡è‰² = å…‰æºå…‰è­œ + å¤§æ°£æˆåˆ†(æ•£å°„æ€§è³ª) + è§€å¯Ÿè€…æ„Ÿå®˜ã€‚ä¸åƒ…é™æ–¼åœ°çƒã€‚', author: 'u1', x: 300, y: 750, parentId: 'n1-11', date: Date.now()-40000, cluster: 'C', promisingness: 90 },
                { id: 'n1-13', topicId: 't1', type: 'question', title: 'å¤œæ™šçš„å¤©ç©ºç‚ºä»€éº¼æ˜¯é»‘çš„ï¼Ÿ', content: 'é€™è½èµ·ä¾†å¾ˆç¬¨ï¼Œä½†æ—¢ç„¶å®‡å®™æœ‰ç„¡æ•¸æ†æ˜Ÿï¼Œç‚ºä»€éº¼å¤©ç©ºä¸æœƒå……æ»¿å…‰äº®ï¼Ÿ(å¥§ä¼¯æ–¯ä½¯è¬¬)', author: 'u3', x: 900, y: 200, parentId: null, date: Date.now()-35000, cluster: 'A', promisingness: 80 },
                { id: 'n1-14', topicId: 't1', type: 'improve', title: 'å®‡å®™è†¨è„¹èˆ‡ç´…ç§»', content: 'å› ç‚ºå®‡å®™åœ¨è†¨è„¹ï¼Œé æ–¹æ†æ˜Ÿçš„å…‰ç™¼ç”Ÿç´…ç§»ï¼Œè®Šæˆäº†æˆ‘å€‘è‚‰çœ¼çœ‹ä¸è¦‹çš„ç´…å¤–ç·šã€‚', author: 'u4', x: 1000, y: 350, parentId: 'n1-13', date: Date.now()-30000, cluster: 'B', promisingness: 85 },
                { id: 'n1-15', topicId: 't1', type: 'extend', title: 'å…‰é€Ÿæœ‰é™', content: 'é‚„æœ‰ä¸€å€‹åŸå› æ˜¯å®‡å®™å¹´é½¡æœ‰é™ï¼Œå¾ˆå¤šå…‰é‚„æ²’å‚³åˆ°åœ°çƒã€‚', author: 'u5', x: 1100, y: 450, parentId: 'n1-14', date: Date.now()-25000, cluster: 'B', promisingness: 80 },

                // --- T2: AI æ˜¯å¦å…·æœ‰å‰µé€ åŠ›ï¼Ÿ (15+ nodes) ---
                { id: 'n2-1', topicId: 't2', type: 'question', title: 'AI çœŸçš„èƒ½ã€Œå‰µä½œã€å—ï¼Ÿ', content: 'AI ç”Ÿæˆçš„ç•«ä½œå¾ˆç¾ï¼Œä½†é€™ç®—æ˜¯å‰µé€ å—ï¼Ÿé‚„æ˜¯åªæ˜¯é«˜ç´šçš„æ‹¼è²¼ï¼Ÿ', author: 'u1', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 40 },
                { id: 'n2-2', topicId: 't2', type: 'counter', title: 'åªæ˜¯çµ±è¨ˆå­¸é¸šéµ¡', content: 'ç›®å‰çš„ LLM æˆ– Diffusion æ¨¡å‹æœ¬è³ªä¸Šæ˜¯é æ¸¬ä¸‹ä¸€å€‹å­—/åƒç´ çš„æ©Ÿç‡ï¼Œæ²’æœ‰éˆé­‚æˆ–æ„åœ–ã€‚', author: 'u2', x: 100, y: 300, parentId: 'n2-1', date: Date.now()-90000, cluster: 'A', promisingness: 50 },
                { id: 'n2-3', topicId: 't2', type: 'improve', title: 'äººé¡å‰µé€ ä¹Ÿæ˜¯é‡çµ„', content: 'ä½†ç•¢å¡ç´¢èªªéã€Œå¥½çš„è—è¡“å®¶æ¨¡ä»¿ï¼Œå‰å¤§çš„è—è¡“å®¶å·ç«Šã€ã€‚äººé¡çš„å‰µæ„ä¸ä¹Ÿæ˜¯åŸºæ–¼éå¾€ç¶“é©—çš„é‡çµ„å—ï¼Ÿ', author: 'u3', x: 350, y: 300, parentId: 'n2-1', date: Date.now()-85000, cluster: 'B', promisingness: 60 },
                { id: 'n2-4', topicId: 't2', type: 'extend', title: 'Boden çš„ä¸‰ç¨®å‰µé€ åŠ›', content: 'ç‘ªæ ¼éº—ç‰¹Â·åšç™»æå‡ºä¸‰ç¨®å‰µé€ åŠ›ï¼šçµ„åˆæ€§ã€æ¢ç´¢æ€§ã€è®Šé©æ€§ã€‚AI ç›®å‰å¾ˆæ“…é•·å‰å…©è€…ã€‚', author: 'u1', x: 600, y: 300, parentId: 'n2-3', date: Date.now()-80000, cluster: 'B', promisingness: 85 },
                { id: 'n2-5', topicId: 't2', type: 'extend', title: 'AlphaGo çš„ç¬¬ 37 æ‰‹', content: 'AlphaGo ä¸‹å‡ºçš„ç¬¬ 37 æ‰‹è¢«åœæ£‹ç•Œç¨±ç‚ºã€Œç¥ä¹‹ä¸€æ‰‹ã€ï¼Œé€™æ˜¯äººé¡å¾æœªæƒ³éçš„ä¸‹æ³•ï¼Œé€™ç®—è®Šé©æ€§å‰µé€ åŠ›å§ï¼Ÿ', author: 'u4', x: 850, y: 400, parentId: 'n2-4', date: Date.now()-75000, cluster: 'B', promisingness: 90 },
                { id: 'n2-6', topicId: 't2', type: 'counter', title: 'ç¼ºä¹æ„åœ– (Intentionality)', content: 'ä½† AlphaGo ä¸çŸ¥é“è‡ªå·±åœ¨ä¸‹æ£‹ï¼Œå®ƒåªæ˜¯åœ¨å„ªåŒ–å‡½æ•¸ã€‚æ²’æœ‰ã€Œæƒ³è¡¨é”ä»€éº¼ã€çš„æ„åœ–ï¼Œèƒ½ç®—è—è¡“å—ï¼Ÿ', author: 'u5', x: 600, y: 500, parentId: 'n2-5', date: Date.now()-70000, cluster: 'A', promisingness: 70 },
                { id: 'n2-7', topicId: 't2', type: 'riseabove', title: 'é‡æ–°å®šç¾©å‰µé€ åŠ›', content: 'æˆ–è¨±æˆ‘å€‘éœ€è¦å€åˆ†ã€Œéç¨‹çš„å‰µé€ åŠ›ã€èˆ‡ã€Œçµæœçš„å‰µé€ åŠ›ã€ã€‚AI æ“æœ‰çµæœçš„å‰µé€ åŠ›ï¼Œä½†ç¼ºä¹éç¨‹ä¸­çš„ä¸»è§€é«”é©—ã€‚', author: 'u6', x: 500, y: 700, parentId: 'n2-6', date: Date.now()-65000, cluster: 'C', promisingness: 95 },
                { id: 'n2-8', topicId: 't2', type: 'question', title: 'ç‰ˆæ¬Šæ­¸å±¬å•é¡Œ', content: 'å¦‚æœ AI çœŸçš„æœ‰å‰µé€ åŠ›ï¼Œé‚£ç”Ÿæˆçš„ä½œå“ç‰ˆæ¬Šæ­¸èª°ï¼Ÿ', author: 'u7', x: 1000, y: 200, parentId: null, date: Date.now()-60000, cluster: 'A', promisingness: 50 },
                { id: 'n2-9', topicId: 't2', type: 'improve', title: 'æç¤ºè©å·¥ç¨‹å¸«çš„è²¢ç»', content: 'æ‡‰è©²æ­¸çµ¦å¯« Prompt çš„äººï¼Ÿå› ç‚ºé‚£æ˜¯å‰µæ„çš„æºé ­ã€‚', author: 'u8', x: 1000, y: 400, parentId: 'n2-8', date: Date.now()-55000, cluster: 'B', promisingness: 55 },
                { id: 'n2-10', topicId: 't2', type: 'counter', title: 'å·¥å…·è«–', content: 'å°±åƒç”¨ Photoshop ç•«åœ–ï¼Œç‰ˆæ¬Šä¸å±¬æ–¼ Adobeã€‚AI åªæ˜¯å·¥å…·ã€‚', author: 'u9', x: 1200, y: 500, parentId: 'n2-8', date: Date.now()-50000, cluster: 'B', promisingness: 60 },
                { id: 'n2-11', topicId: 't2', type: 'extend', title: 'å¹»è¦ºä½œç‚ºå‰µæ„', content: 'æœ‰æ™‚å€™ AI çš„ Hallucination (å¹»è¦º/èƒ¡èªªå…«é“) åè€Œæ˜¯ä¸€ç¨®è·³è„«æ¡†æ¶çš„å‰µæ„ä¾†æºã€‚', author: 'u10', x: 200, y: 600, parentId: 'n2-1', date: Date.now()-45000, cluster: 'B', promisingness: 75 },
                { id: 'n2-12', topicId: 't2', type: 'question', title: 'äººæ©Ÿå”ä½œ (Co-Creation)', content: 'æœªä¾†æœƒä¸æœƒä¸å†å€åˆ†äººæˆ– AIï¼Œè€Œæ˜¯ã€Œäººé¦¬åº§ (Centaur)ã€æ¨¡å¼ï¼Ÿ', author: 'u2', x: 400, y: 800, parentId: 'n2-7', date: Date.now()-40000, cluster: 'C', promisingness: 85 },
                { id: 'n2-13', topicId: 't2', type: 'improve', title: 'æƒ…æ„Ÿå…±é³´æ‰æ˜¯é—œéµ', content: 'å‰µé€ åŠ›çš„åƒ¹å€¼åœ¨æ–¼å¼•ç™¼å…±é³´ã€‚AI å¯«çš„è©©å¦‚æœè®“äººæ„Ÿå‹•ï¼Œé‚£å°±æ˜¯çœŸçš„ï¼Œå³ä¾¿å®ƒæ²’æœ‰å¿ƒã€‚', author: 'u3', x: 600, y: 800, parentId: 'n2-6', date: Date.now()-35000, cluster: 'C', promisingness: 80 },
                { id: 'n2-14', topicId: 't2', type: 'counter', title: 'ä¸­æ–‡æˆ¿é–“è«–è­‰', content: 'Searle çš„ä¸­æ–‡æˆ¿é–“å¯¦é©—å‘Šè¨´æˆ‘å€‘ï¼Œæœƒæ“ä½œç¬¦è™Ÿä¸ä»£è¡¨ç†è§£æ„ç¾©ã€‚', author: 'u5', x: 100, y: 500, parentId: 'n2-2', date: Date.now()-30000, cluster: 'A', promisingness: 80 },
                { id: 'n2-15', topicId: 't2', type: 'riseabove', title: 'å¾Œäººé¡ç¾å­¸', content: 'AI å¯èƒ½æœƒå‰µé€ å‡ºä¸€ç¨®äººé¡ç„¡æ³•å®Œå…¨ç†è§£ï¼Œä½†æ¥µå…·ç§©åºæ„Ÿçš„æ–°ç¾å­¸å½¢å¼ã€‚', author: 'u1', x: 800, y: 800, parentId: 'n2-12', date: Date.now()-25000, cluster: 'C', promisingness: 90 },

                // --- T3: é€²æ“Šçš„å·¨äººä¸­çš„è‡ªç”±æ„å¿— (15 nodes) ---
                { id: 'n3-1', topicId: 't3', type: 'question', title: 'è‰¾é€£æ˜¯è‡ªç”±çš„å—ï¼Ÿ', content: 'è‰¾é€£ä¸€ç›´è¿½æ±‚è‡ªç”±ï¼Œä½†ä»–çœ‹è¦‹æœªä¾†è¨˜æ†¶å¾Œï¼Œåšçš„ä¸€åˆ‡ä¼¼ä¹éƒ½æ˜¯ç‚ºäº†å¯¦ç¾é‚£å€‹æœªä¾†ã€‚é€™ç®—è‡ªç”±å—ï¼Ÿ', author: 'u2', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 60 },
                { id: 'n3-2', topicId: 't3', type: 'extend', title: 'æ±ºå®šè«–çš„çŸ›ç›¾', content: 'å¦‚æœæœªä¾†å·²ç¶“è¢«æ±ºå®šï¼Œé‚£ã€Œé¸æ“‡ã€å°±åªæ˜¯å¹»è¦ºã€‚ä»–åªæ˜¯åŠ‡æœ¬çš„æ¼”å“¡ã€‚', author: 'u7', x: 100, y: 300, parentId: 'n3-1', date: Date.now()-90000, cluster: 'A', promisingness: 70 },
                { id: 'n3-3', topicId: 't3', type: 'improve', title: 'ç›¸å®¹è«– (Compatibilism)', content: 'é›–ç„¶æœªä¾†æ˜¯å›ºå®šçš„ï¼Œä½†é‚£æ˜¯å› ç‚ºè‰¾é€£ã€Œæ¸´æœ›ã€é‚£æ¨£çš„çµæœã€‚ä»–æ˜¯æŒ‰è‡ªå·±çš„æ„å¿—å»é¸æ“‡äº†é‚£å€‹å¿…ç„¶çš„æœªä¾†ã€‚', author: 'u4', x: 350, y: 300, parentId: 'n3-1', date: Date.now()-85000, cluster: 'B', promisingness: 85 },
                { id: 'n3-4', topicId: 't3', type: 'extend', title: 'é€²æ“Šçš„å·¨äººçš„èƒ½åŠ›', content: 'é€²æ“Šçš„å·¨äººèƒ½çœ‹è¦‹æœªä¾†ç¹¼æ‰¿è€…çš„è¨˜æ†¶ï¼Œé€™æœ¬èº«å°±æ˜¯ä¸€ç¨®è©›å’’ã€‚', author: 'u8', x: 600, y: 300, parentId: 'n3-3', date: Date.now()-80000, cluster: 'B', promisingness: 75 },
                { id: 'n3-5', topicId: 't3', type: 'improve', title: 'è‚¯å°¼çš„éºè¨€', content: 'ã€Œäººéƒ½å¿…é ˆæ²ˆé†‰åœ¨æŸäº›æ±è¥¿è£¡ï¼Œå¦å‰‡æ´»ä¸ä¸‹å»ã€‚å¤§å®¶éƒ½æ˜¯æŸç¨®æ±è¥¿çš„å¥´éš¸ã€‚ã€è‰¾é€£æ˜¯è‡ªç”±çš„å¥´éš¸ã€‚', author: 'u5', x: 850, y: 400, parentId: 'n3-4', date: Date.now()-75000, cluster: 'B', promisingness: 90 },
                { id: 'n3-6', topicId: 't3', type: 'counter', title: 'é˜¿çˆ¾æ•çš„è‡ªç”±', content: 'å°æ¯”è‰¾é€£ï¼Œé˜¿çˆ¾æ•æƒ³çœ‹æµ·çš„å¤¢æƒ³ï¼Œä¼¼ä¹æ›´æ¥è¿‘ç´”ç²¹çš„è‡ªç”±ï¼Ÿ', author: 'u9', x: 600, y: 500, parentId: 'n3-1', date: Date.now()-70000, cluster: 'A', promisingness: 65 },
                { id: 'n3-7', topicId: 't3', type: 'riseabove', title: 'è‡ªç”±æ˜¯éç¨‹è€Œéç‹€æ…‹', content: 'è‡ªç”±ä¸æ˜¯ã€Œæƒ³åšä»€éº¼å°±åšä»€éº¼ã€ï¼Œè€Œæ˜¯ã€Œç‚ºäº†ä¿¡å¿µè€Œä¸æ–·æŠ—çˆ­çš„éç¨‹ã€ã€‚', author: 'u1', x: 500, y: 700, parentId: 'n3-6', date: Date.now()-65000, cluster: 'C', promisingness: 90 },
                { id: 'n3-8', topicId: 't3', type: 'question', title: 'å°¤ç±³çˆ¾çš„é¸æ“‡', content: 'å°¤ç±³çˆ¾åœ¨é“è·¯ä¸­å¾…äº†å…©åƒå¹´ï¼Œå¥¹æ˜¯å¥´éš¸é‚„æ˜¯ç¥ï¼Ÿ', author: 'u3', x: 1000, y: 200, parentId: null, date: Date.now()-60000, cluster: 'A', promisingness: 50 },
                { id: 'n3-9', topicId: 't3', type: 'improve', title: 'æ„›çš„æŸç¸›', content: 'å¥¹æ˜¯æ„›çš„å¥´éš¸ã€‚å¥¹å°å¼—é‡ŒèŒ²ç‹çš„æ‰­æ›²ä¹‹æ„›æŸç¸›äº†å¥¹ã€‚', author: 'u10', x: 1000, y: 400, parentId: 'n3-8', date: Date.now()-55000, cluster: 'B', promisingness: 60 },
                { id: 'n3-10', topicId: 't3', type: 'extend', title: 'ç±³å¡èçš„é—œéµä½œç”¨', content: 'æ‰€ä»¥ç±³å¡èæœ€å¾Œçš„é¸æ“‡ï¼ˆæ–¬æ®ºæ„›äººï¼‰æ‰è§£æ”¾äº†å°¤ç±³çˆ¾ã€‚é‚£æ‰æ˜¯çœŸæ­£çš„è‡ªç”±æ„å¿—å±•ç¾ã€‚', author: 'u6', x: 1200, y: 500, parentId: 'n3-9', date: Date.now()-50000, cluster: 'B', promisingness: 80 },
                { id: 'n3-11', topicId: 't3', type: 'question', title: 'ç‰†å£çš„è±¡å¾µæ„ç¾©', content: 'ç‰†å£ä¿è­·äº†äººï¼Œä¹Ÿå¥ªèµ°äº†è‡ªç”±ã€‚é€™è·Ÿç¾å¯¦ç¤¾æœƒæœ‰ä»€éº¼å°æ‡‰ï¼Ÿ', author: 'u2', x: 200, y: 600, parentId: null, date: Date.now()-45000, cluster: 'A', promisingness: 55 },
                { id: 'n3-12', topicId: 't3', type: 'extend', title: 'ç„¡çŸ¥æ˜¯å¹¸ç¦å—ï¼Ÿ', content: 'ç‰†å…§ç‹æ¶ˆé™¤äº†è¨˜æ†¶ï¼Œè®“äººå€‘æ´»åœ¨è™›å‡çš„å’Œå¹³ä¸­ã€‚çŸ¥æƒ…ä½†ç—›è‹¦ vs ç„¡çŸ¥ä½†å¹¸ç¦ï¼Œå“ªå€‹æ¯”è¼ƒå¥½ï¼Ÿ', author: 'u4', x: 400, y: 800, parentId: 'n3-11', date: Date.now()-40000, cluster: 'C', promisingness: 75 },
                { id: 'n3-13', topicId: 't3', type: 'improve', title: 'èµ°å‡ºæ£®æ—', content: 'è–©å¤çˆ¶è¦ªèªªçš„ã€Œå¿…é ˆè®“å­©å­å€‘èµ°å‡ºæ£®æ—ã€ï¼Œæ˜¯æŒ‡åˆ‡æ–·ä»‡æ¨çš„é€£é–ï¼Œé€™æ‰æ˜¯äººé¡çœŸæ­£çš„è§£æ”¾ã€‚', author: 'u1', x: 600, y: 800, parentId: 'n3-12', date: Date.now()-35000, cluster: 'C', promisingness: 95 },
                { id: 'n3-14', topicId: 't3', type: 'counter', title: 'æ»…ä¸–æ˜¯è‡ªç”±å—ï¼Ÿ', content: 'è‰¾é€£é¸æ“‡è¸å¹³ä¸–ç•Œä¾†ä¿è­·å¸•æ‹‰è¿ªå³¶ï¼Œé€™ç¨®å‰å¥ªä»–äººè‡ªç”±ä¾†æ›å–è‡ªå·±è‡ªç”±çš„è¡Œç‚ºï¼ŒçŸ›ç›¾ä¸”æ‚²åŠ‡ã€‚', author: 'u5', x: 100, y: 500, parentId: 'n3-1', date: Date.now()-30000, cluster: 'A', promisingness: 85 },
                { id: 'n3-15', topicId: 't3', type: 'riseabove', title: 'å­˜åœ¨ä¸»ç¾©è§€é»', content: 'ã€Œå› ç‚ºæˆ‘èª•ç”Ÿåœ¨é€™å€‹ä¸–ç•Œä¸Šã€‚ã€é€™å¥è©±è¡¨æ˜ç”Ÿå‘½æœ¬èº«å°±æ˜¯ç›®çš„ï¼Œè‡ªç”±åœ¨æ–¼è³¦äºˆè‡ªå·±ç”Ÿå‘½æ„ç¾©ã€‚', author: 'u3', x: 800, y: 800, parentId: 'n3-13', date: Date.now()-25000, cluster: 'C', promisingness: 90 },

                // --- T4: Discord Bot (15 nodes) ---
                { id: 'n4-1', topicId: 't4', type: 'question', title: 'å¦‚ä½•é–‹å§‹å¯«ä¸€å€‹ Botï¼Ÿ', content: 'æˆ‘å®Œå…¨æ˜¯æ–°æ‰‹ï¼Œè¦å…ˆå®‰è£ä»€éº¼ï¼ŸDiscord Developer Portal è¦æ€éº¼è¨­å®šï¼Ÿ', author: 'u3', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 40 },
                { id: 'n4-2', topicId: 't4', type: 'improve', title: 'ç’°å¢ƒå»ºç½®', content: 'é¦–å…ˆè¦å®‰è£ Pythonï¼Œç„¶å¾Œç”¨ `pip install discord.py`ã€‚è¨˜å¾—è¦åœ¨ Developer Portal é–‹å•Ÿ Privileged Gateway Intentsã€‚', author: 'u7', x: 100, y: 300, parentId: 'n4-1', date: Date.now()-90000, cluster: 'B', promisingness: 60 },
                { id: 'n4-3', topicId: 't4', type: 'extend', title: 'Token å®‰å…¨', content: 'çµ•å°ä¸è¦æŠŠ Token ç›´æ¥å¯«åœ¨ç¨‹å¼ç¢¼è£¡ä¸Šå‚³ GitHubï¼è¦ç”¨ `.env` æª”æˆ–æ˜¯ç’°å¢ƒè®Šæ•¸ã€‚', author: 'u9', x: 350, y: 300, parentId: 'n4-2', date: Date.now()-85000, cluster: 'B', promisingness: 90 },
                { id: 'n4-4', topicId: 't4', type: 'question', title: 'Prefix vs Slash Commands', content: 'ä»¥å‰éƒ½ç”¨ `!` é–‹é ­çš„æŒ‡ä»¤ï¼Œç¾åœ¨å¥½åƒéƒ½æ¨è–¦ç”¨æ–œç·šæŒ‡ä»¤ (Slash Commands)ï¼Ÿ', author: 'u10', x: 600, y: 300, parentId: 'n4-1', date: Date.now()-80000, cluster: 'A', promisingness: 50 },
                { id: 'n4-5', topicId: 't4', type: 'improve', title: 'äº¤äº’é«”é©—å·®ç•°', content: 'Slash commands æœ‰ UI æç¤ºï¼Œä½¿ç”¨è€…é«”é©—å¥½å¾ˆå¤šï¼Œè€Œä¸” Discord å®˜æ–¹ä¹Ÿå¼·æ¨ã€‚å»ºè­°ç”¨ `app_commands`ã€‚', author: 'u1', x: 850, y: 400, parentId: 'n4-4', date: Date.now()-75000, cluster: 'B', promisingness: 70 },
                { id: 'n4-6', topicId: 't4', type: 'question', title: 'Async/Await æ˜¯ä»€éº¼ï¼Ÿ', content: 'ç¨‹å¼ç¢¼è£¡åˆ°è™•éƒ½æ˜¯ `async def` å’Œ `await`ï¼Œä¸å¯«æœƒæ€æ¨£ï¼Ÿ', author: 'u6', x: 100, y: 500, parentId: 'n4-1', date: Date.now()-70000, cluster: 'A', promisingness: 65 },
                { id: 'n4-7', topicId: 't4', type: 'extend', title: 'éåŒæ­¥æ¦‚å¿µ', content: 'Discord bot æ˜¯ I/O bound çš„ï¼Œå¦‚æœä¸ç”¨ asyncï¼Œç•¶æ©Ÿå™¨äººåœ¨ç­‰ç¶²è·¯å›æ‡‰æ™‚ï¼Œæ•´å€‹ç¨‹å¼æœƒå¡ä½ï¼Œå…¶ä»–äººéƒ½ä¸èƒ½ç”¨ã€‚', author: 'u8', x: 350, y: 600, parentId: 'n4-6', date: Date.now()-65000, cluster: 'B', promisingness: 85 },
                { id: 'n4-8', topicId: 't4', type: 'question', title: 'æ€éº¼è®“æ©Ÿå™¨äººæ’­éŸ³æ¨‚ï¼Ÿ', content: 'æƒ³åšä¸€å€‹åƒ Rythm çš„éŸ³æ¨‚æ©Ÿå™¨äººã€‚', author: 'u2', x: 600, y: 500, parentId: null, date: Date.now()-60000, cluster: 'A', promisingness: 50 },
                { id: 'n4-9', topicId: 't4', type: 'improve', title: 'FFmpeg èˆ‡ VoiceClient', content: 'éœ€è¦å®‰è£ FFmpegã€‚é‚è¼¯æ˜¯ï¼šåŠ å…¥èªéŸ³é »é“ -> ä¸‹è¼‰/ä¸²æµéŸ³è¨Š -> ç”¨ FFmpeg è½‰ç¢¼ -> æ’­æ”¾ã€‚', author: 'u4', x: 800, y: 600, parentId: 'n4-8', date: Date.now()-55000, cluster: 'B', promisingness: 75 },
                { id: 'n4-10', topicId: 't4', type: 'counter', title: 'æ³•å¾‹é¢¨éšª', content: 'è¦æ³¨æ„ YouTube çš„ TOSï¼Œæœ€è¿‘å¾ˆå¤šéŸ³æ¨‚æ©Ÿå™¨äººéƒ½è¢«è¿«é—œé–‰äº†ã€‚', author: 'u5', x: 1000, y: 650, parentId: 'n4-8', date: Date.now()-50000, cluster: 'A', promisingness: 80 },
                { id: 'n4-11', topicId: 't4', type: 'riseabove', title: 'æ©Ÿå™¨äººæ¶æ§‹æ¨¡å¼', content: 'éš¨è‘—åŠŸèƒ½è®Šå¤šï¼Œè¦ç”¨ `Cogs` ä¾†ç®¡ç†æ¨¡çµ„ã€‚ä¸è¦æŠŠæ‰€æœ‰ç¨‹å¼ç¢¼å¯«åœ¨ `main.py`ã€‚', author: 'u1', x: 500, y: 800, parentId: 'n4-2', date: Date.now()-45000, cluster: 'C', promisingness: 90 },
                { id: 'n4-12', topicId: 't4', type: 'question', title: '24å°æ™‚é‹ä½œ', content: 'æˆ‘é—œæ‰é›»è…¦æ©Ÿå™¨äººå°±ä¸‹ç·šäº†ï¼Œæ€éº¼è®“å®ƒä¸€ç›´è·‘ï¼Ÿ', author: 'u3', x: 100, y: 700, parentId: null, date: Date.now()-40000, cluster: 'A', promisingness: 60 },
                { id: 'n4-13', topicId: 't4', type: 'improve', title: 'é›²ç«¯éƒ¨ç½²', content: 'å¯ä»¥ç”¨ Heroku (ç¾åœ¨è¦éŒ¢äº†)ã€Renderã€æˆ–æ˜¯è²·å€‹ä¾¿å®œçš„ VPS (å¦‚ DigitalOcean)ã€‚', author: 'u7', x: 300, y: 800, parentId: 'n4-12', date: Date.now()-35000, cluster: 'B', promisingness: 70 },
                { id: 'n4-14', topicId: 't4', type: 'extend', title: 'UptimeRobot å¤§æ³•', content: 'å¦‚æœæ˜¯ Replitï¼Œå¯ä»¥ç”¨ UptimeRobot å®šæ™‚ ping ä½ çš„ç¶²å€ä¾†ä¿æŒå–šé†’ (ä½†ä¸æ¨è–¦ï¼Œä¸ç©©å®š)ã€‚', author: 'u10', x: 300, y: 900, parentId: 'n4-13', date: Date.now()-30000, cluster: 'B', promisingness: 50 },
                { id: 'n4-15', topicId: 't4', type: 'riseabove', title: 'è³‡æ–™åº«æ•´åˆ', content: 'å¦‚æœè¦è¨˜ä½ä½¿ç”¨è€…çš„ç­‰ç´šæˆ–é‡‘éŒ¢ï¼Œéœ€è¦ä¸²æ¥è³‡æ–™åº«ã€‚å»ºè­°æ–°æ‰‹å¾ SQLite é–‹å§‹ï¼Œé€²éšç”¨ MongoDBã€‚', author: 'u9', x: 600, y: 900, parentId: 'n4-11', date: Date.now()-25000, cluster: 'C', promisingness: 85 },

                // --- T5: æ–‡è—å¾©èˆˆ (15 nodes) ---
                { id: 'n5-1', topicId: 't5', type: 'question', title: 'æ–‡è—å¾©èˆˆçš„æ ¸å¿ƒç²¾ç¥æ˜¯ä»€éº¼ï¼Ÿ', content: 'æ˜¯ç•«ç•«è®Šå¾—å¾ˆåƒçœŸçš„äººå—ï¼Ÿé‚„æ˜¯æœ‰æ›´æ·±å±¤çš„å«ç¾©ï¼Ÿ', author: 'u1', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 50 },
                { id: 'n5-2', topicId: 't5', type: 'improve', title: 'äººæ–‡ä¸»ç¾© (Humanism)', content: 'æ ¸å¿ƒæ˜¯ã€Œä»¥äººç‚ºæœ¬ã€ã€‚å¾ä¸­ä¸–ç´€é—œæ³¨ã€Œç¥ã€ï¼Œè½‰è®Šç‚ºé—œæ³¨ã€Œäººã€çš„åƒ¹å€¼ã€æƒ…æ„Ÿèˆ‡ç¾ä¸–ç”Ÿæ´»ã€‚', author: 'u5', x: 100, y: 300, parentId: 'n5-1', date: Date.now()-90000, cluster: 'B', promisingness: 80 },
                { id: 'n5-3', topicId: 't5', type: 'extend', title: 'é€è¦–æ³•çš„ç™¼ç¾', content: 'å¸ƒé­¯å…§èŠæ–¯åŸºç™¼ç¾äº†ç·šæ€§é€è¦–æ³•ï¼Œé€™è®“äºŒç¶­å¹³é¢èƒ½å±•ç¾ä¸‰ç¶­ç©ºé–“ï¼Œæ”¹è®Šäº†äººé¡è§€çœ‹ä¸–ç•Œçš„æ–¹å¼ã€‚', author: 'u6', x: 350, y: 300, parentId: 'n5-2', date: Date.now()-85000, cluster: 'B', promisingness: 75 },
                { id: 'n5-4', topicId: 't5', type: 'extend', title: 'è§£å‰–å­¸çš„æ‡‰ç”¨', content: 'é”æ–‡è¥¿é€éè§£å‰–å±é«”ä¾†äº†è§£è‚Œè‚‰çµæ§‹ï¼Œé€™è®“è—è¡“èˆ‡ç§‘å­¸çµåˆã€‚', author: 'u8', x: 600, y: 300, parentId: 'n5-2', date: Date.now()-80000, cluster: 'B', promisingness: 70 },
                { id: 'n5-5', topicId: 't5', type: 'counter', title: 'ä¸­ä¸–ç´€çœŸçš„é»‘æš—å—ï¼Ÿ', content: 'æˆ‘å€‘å¸¸èªªæ–‡è—å¾©èˆˆæ˜¯å…‰æ˜çš„ï¼Œä½†ä¸­ä¸–ç´€å…¶å¯¦ä¹Ÿæœ‰å¾ˆå¤šæŠ€è¡“é€²æ­¥ï¼Œä¸è©²å®Œå…¨å¦å®šã€‚', author: 'u2', x: 350, y: 500, parentId: 'n5-2', date: Date.now()-75000, cluster: 'A', promisingness: 65 },
                { id: 'n5-6', topicId: 't5', type: 'riseabove', title: 'å¤ä»Šèåˆçš„å‰µæ–°', content: 'æ–‡è—å¾©èˆˆä¸æ˜¯å–®ç´”å¾©å¤ï¼Œè€Œæ˜¯çµåˆå¤å…¸å¸Œè‡˜ç¾…é¦¬ç¾å­¸èˆ‡åŸºç£æ•™ç²¾ç¥ï¼Œå‰µé€ å‡ºå…¨æ–°çš„æ–‡åŒ–é«”ç³»ã€‚', author: 'u1', x: 600, y: 600, parentId: 'n5-2', date: Date.now()-70000, cluster: 'C', promisingness: 85 },
                { id: 'n5-7', topicId: 't5', type: 'question', title: 'å°ç¾ä»£è¨­è¨ˆçš„å½±éŸ¿ï¼Ÿ', content: 'ç¾åœ¨çš„å¹³é¢è¨­è¨ˆæˆ–å»ºç¯‰ï¼Œé‚„æœ‰æ–‡è—å¾©èˆˆçš„å½±å­å—ï¼Ÿ', author: 'u4', x: 900, y: 200, parentId: null, date: Date.now()-65000, cluster: 'A', promisingness: 55 },
                { id: 'n5-8', topicId: 't5', type: 'improve', title: 'é»ƒé‡‘æ¯”ä¾‹', content: 'å¾ˆå¤šç¾ä»£ Logo (å¦‚ Apple, Twitter) ä»åœ¨ä½¿ç”¨é»ƒé‡‘æ¯”ä¾‹ï¼Œé€™æ˜¯æ–‡è—å¾©èˆˆæ™‚æœŸæ¨å´‡çš„ç¾å­¸æ¨™æº–ã€‚', author: 'u7', x: 900, y: 400, parentId: 'n5-7', date: Date.now()-60000, cluster: 'B', promisingness: 70 },
                { id: 'n5-9', topicId: 't5', type: 'extend', title: 'å€‹äººå“ç‰Œçš„èˆˆèµ·', content: 'è—è¡“å®¶é–‹å§‹ç°½åï¼Œå»ºç«‹å€‹äººé¢¨æ ¼ï¼Œé€™å¯ä»¥èªªæ˜¯ç¾ä»£ã€Œå€‹äººå“ç‰Œã€çš„é››å½¢ã€‚', author: 'u3', x: 1150, y: 400, parentId: 'n5-7', date: Date.now()-55000, cluster: 'B', promisingness: 60 },
                { id: 'n5-10', topicId: 't5', type: 'question', title: 'æ¢…è¿ªå¥‡å®¶æ—çš„è§’è‰²', content: 'æ²’æœ‰é‡‘ä¸»è´ŠåŠ©ï¼Œæœƒæœ‰æ–‡è—å¾©èˆˆå—ï¼Ÿ', author: 'u10', x: 100, y: 600, parentId: null, date: Date.now()-50000, cluster: 'A', promisingness: 60 },
                { id: 'n5-11', topicId: 't5', type: 'improve', title: 'è—è¡“èˆ‡æ¬ŠåŠ›', content: 'è—è¡“æˆç‚ºå±•ç¤ºæ¬ŠåŠ›èˆ‡è²¡å¯Œçš„å·¥å…·ã€‚é€™è·Ÿç¾ä»£ä¼æ¥­è´ŠåŠ©è—è¡“å±•è¦½å¾ˆåƒã€‚', author: 'u9', x: 100, y: 800, parentId: 'n5-10', date: Date.now()-45000, cluster: 'B', promisingness: 75 },
                { id: 'n5-12', topicId: 't5', type: 'riseabove', title: 'è·¨é ˜åŸŸé€šæ‰ (Polymath)', content: 'æ–‡è—å¾©èˆˆäºº(Renaissance Man) ä»£è¡¨é€šæ›‰å¤šç¨®é ˜åŸŸçš„äººã€‚åœ¨ç¾ä»£åˆ†å·¥ç´°åŒ–çš„ç¤¾æœƒï¼Œæˆ‘å€‘æ˜¯å¦æ›´éœ€è¦é€™ç¨®æ•´åˆèƒ½åŠ›ï¼Ÿ', author: 'u1', x: 500, y: 800, parentId: 'n5-4', date: Date.now()-40000, cluster: 'C', promisingness: 95 },
                { id: 'n5-13', topicId: 't5', type: 'counter', title: 'èè‹±ä¸»ç¾©çš„ä¾·é™', content: 'ä½†ç•¶æ™‚çš„è—è¡“ä¸»è¦æ˜¯æœå‹™è²´æ—å’Œæ•™æœƒï¼Œå¹³æ°‘ç™¾å§“çš„ç”Ÿæ´»ä¸¦æ²’æœ‰å¤ªå¤§æ”¹å–„ã€‚', author: 'u5', x: 300, y: 700, parentId: 'n5-2', date: Date.now()-35000, cluster: 'A', promisingness: 70 },
                { id: 'n5-14', topicId: 't5', type: 'extend', title: 'å°åˆ·è¡“çš„æ¨æ³¢åŠ©ç€¾', content: 'å¤é¨°å ¡å°åˆ·è¡“åŠ é€Ÿäº†çŸ¥è­˜å‚³æ’­ï¼Œé€™æ‰æ˜¯æ–‡è—å¾©èˆˆèƒ½æ“´æ•£åˆ°å…¨æ­æ´²çš„é—œéµã€‚', author: 'u6', x: 700, y: 500, parentId: 'n5-6', date: Date.now()-30000, cluster: 'B', promisingness: 80 },
                { id: 'n5-15', topicId: 't5', type: 'riseabove', title: 'çŸ¥è­˜çš„æ°‘ä¸»åŒ–', content: 'å¾æ–‡è—å¾©èˆˆçš„å°åˆ·è¡“åˆ°ç¾ä»£çš„ç¶²éš›ç¶²è·¯ï¼ŒçŸ¥è­˜è¼‰é«”çš„æ”¹è®Šç¸½æ˜¯å¼•ç™¼æ€æƒ³é©å‘½ã€‚', author: 'u1', x: 900, y: 700, parentId: 'n5-14', date: Date.now()-25000, cluster: 'C', promisingness: 90 },

                // --- T7: è‹±æ–‡å£èªª (15 nodes) ---
                { id: 'n7-1', topicId: 't7', type: 'question', title: 'ä¸æ•¢é–‹å£æ€éº¼è¾¦ï¼Ÿ', content: 'æˆ‘çœ‹å¾—æ‡‚ä¹Ÿæœƒå¯«ï¼Œä½†é‡åˆ°å¤–åœ‹äººå°±è…¦è¢‹ä¸€ç‰‡ç©ºç™½ï¼Œæ€•è¬›éŒ¯æ–‡æ³•ã€‚', author: 'u3', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 50 },
                { id: 'n7-2', topicId: 't7', type: 'improve', title: 'å¿ƒæ…‹èª¿æ•´', content: 'æºé€šçš„ç›®çš„æ˜¯ã€Œå‚³é”è¨Šæ¯ã€ï¼Œä¸æ˜¯ã€Œè€ƒè©¦ã€ã€‚åªè¦å°æ–¹è½å¾—æ‡‚ï¼Œæ–‡æ³•éŒ¯äº†ä¹Ÿæ²’é—œä¿‚ã€‚', author: 'u8', x: 100, y: 300, parentId: 'n7-1', date: Date.now()-90000, cluster: 'B', promisingness: 80 },
                { id: 'n7-3', topicId: 't7', type: 'extend', title: 'è·Ÿè®€æ³• (Shadowing)', content: 'æ¨è–¦ Echo Method æˆ– Shadowingã€‚æ¨¡ä»¿æ¯èªäººå£«çš„èªèª¿å’Œæ–·å¥ï¼Œç·´åˆ°è‚Œè‚‰è¨˜æ†¶ã€‚', author: 'u2', x: 350, y: 300, parentId: 'n7-2', date: Date.now()-85000, cluster: 'B', promisingness: 85 },
                { id: 'n7-4', topicId: 't7', type: 'question', title: 'æ²’æœ‰ç·´ç¿’å°è±¡ï¼Ÿ', content: 'èº«é‚Šéƒ½æ˜¯å°ç£äººï¼Œæ²’ç’°å¢ƒæ€éº¼ç·´ï¼Ÿ', author: 'u6', x: 600, y: 200, parentId: null, date: Date.now()-80000, cluster: 'A', promisingness: 60 },
                { id: 'n7-5', topicId: 't7', type: 'improve', title: 'è‡ªè¨€è‡ªèª', content: 'å¯ä»¥è©¦è‘—ç”¨è‹±æ–‡æè¿°è‡ªå·±æ­£åœ¨åšçš„äº‹ï¼ˆä¾‹å¦‚ï¼šI am making coffee nowï¼‰ã€‚', author: 'u10', x: 600, y: 400, parentId: 'n7-4', date: Date.now()-75000, cluster: 'B', promisingness: 70 },
                { id: 'n7-6', topicId: 't7', type: 'extend', title: 'åˆ©ç”¨ AI å·¥å…·', content: 'ç¾åœ¨ ChatGPT çš„èªéŸ³åŠŸèƒ½å¾ˆå¼·ï¼Œå¯ä»¥æŠŠå®ƒç•¶æˆç·´å£èªªçš„å®¶æ•™ï¼Œå®ƒä¸æœƒç¬‘ä½ ï¼Œé‚„æœƒç³¾æ­£ä½ ã€‚', author: 'u9', x: 850, y: 400, parentId: 'n7-5', date: Date.now()-70000, cluster: 'B', promisingness: 90 },
                { id: 'n7-7', topicId: 't7', type: 'counter', title: 'å£éŸ³é‡è¦å—ï¼Ÿ', content: 'å¾ˆå¤šäººåŸ·è‘—è¦ç·´æˆç¾å¼æˆ–è‹±å¼å£éŸ³ï¼Œä½†å…¶å¯¦æœ‰å£éŸ³å¾ˆæ­£å¸¸ï¼Œé‚£æ˜¯èº«ä»½èªåŒçš„ä¸€éƒ¨åˆ†ã€‚', author: 'u5', x: 350, y: 500, parentId: 'n7-3', date: Date.now()-65000, cluster: 'A', promisingness: 75 },
                { id: 'n7-8', topicId: 't7', type: 'improve', title: 'æ¸…æ™°åº¦ > å£éŸ³', content: 'é‡é»æ˜¯ç™¼éŸ³ (Pronunciation) è¦æ¸…æ™°ï¼Œé‡éŸ³ (Intonation) è¦å°ï¼Œè€Œä¸æ˜¯å£éŸ³ (Accent)ã€‚', author: 'u1', x: 600, y: 600, parentId: 'n7-7', date: Date.now()-60000, cluster: 'C', promisingness: 85 },
                { id: 'n7-9', topicId: 't7', type: 'question', title: 'å­—å½™é‡ä¸è¶³', content: 'è¬›ä¸€è¬›å¸¸å¸¸å¡ä½ï¼Œå› ç‚ºæƒ³ä¸åˆ°é‚£å€‹å–®å­—ã€‚', author: 'u7', x: 100, y: 600, parentId: 'n7-1', date: Date.now()-55000, cluster: 'A', promisingness: 60 },
                { id: 'n7-10', topicId: 't7', type: 'improve', title: 'æ›å¥è©±èªª (Paraphrasing)', content: 'å­¸æœƒç”¨ç°¡å–®çš„å­—è§£é‡‹è¤‡é›œçš„æ¦‚å¿µã€‚ä¸çŸ¥é“ "ambitious" å¯ä»¥èªª "really wants to succeed"ã€‚', author: 'u4', x: 100, y: 800, parentId: 'n7-9', date: Date.now()-50000, cluster: 'B', promisingness: 90 },
                { id: 'n7-11', topicId: 't7', type: 'riseabove', title: 'æ²‰æµ¸å¼ç’°å¢ƒ', content: 'æŠŠæ‰‹æ©Ÿä»‹é¢æ”¹æˆè‹±æ–‡ã€çœ‹ Netflix é–‹è‹±æ–‡å­—å¹•ï¼ŒæŠŠè‡ªå·±ã€Œæ³¡ã€åœ¨è‹±æ–‡è£¡ã€‚', author: 'u2', x: 400, y: 800, parentId: 'n7-4', date: Date.now()-45000, cluster: 'C', promisingness: 80 },
                { id: 'n7-12', topicId: 't7', type: 'extend', title: 'Filler Words çš„é‹ç”¨', content: 'å­¸æœƒç”¨ "Well", "You know", "Let me see" ä¾†çˆ­å–æ€è€ƒæ™‚é–“ï¼Œè½èµ·ä¾†æœƒæ›´è‡ªç„¶ã€‚', author: 'u8', x: 800, y: 600, parentId: 'n7-2', date: Date.now()-40000, cluster: 'B', promisingness: 65 },
                { id: 'n7-13', topicId: 't7', type: 'counter', title: 'èƒŒæ¼”è¬›ç¨¿æœ‰ç”¨å—ï¼Ÿ', content: 'èƒŒ TED Talk æœ‰ç”¨å—ï¼Ÿé‚„æ˜¯æœƒè®Šå¾—å¤ªåƒèƒŒæ›¸ï¼Ÿ', author: 'u3', x: 1100, y: 300, parentId: 'n7-3', date: Date.now()-35000, cluster: 'A', promisingness: 50 },
                { id: 'n7-14', topicId: 't7', type: 'improve', title: 'å…§åŒ–è€Œéæ­»èƒŒ', content: 'è¦åˆ†æè¬›è€…çš„é‚è¼¯æ¶æ§‹ï¼Œè€Œä¸åªæ˜¯èƒŒé€å­—ç¨¿ã€‚æ¨¡ä»¿ä»–å€‘çš„ body language ä¹Ÿæœ‰å¹«åŠ©ã€‚', author: 'u1', x: 1100, y: 500, parentId: 'n7-13', date: Date.now()-30000, cluster: 'B', promisingness: 75 },
                { id: 'n7-15', topicId: 't7', type: 'riseabove', title: 'èªè¨€æ˜¯æ–‡åŒ–çš„è¼‰é«”', content: 'å­¸è‹±æ–‡ä¸åªæ˜¯å­¸èªè¨€ï¼Œæ›´æ˜¯å­¸ç¿’å¦ä¸€ç¨®é‚è¼¯æ€ç¶­å’Œæ–‡åŒ–åƒ¹å€¼è§€ã€‚', author: 'u6', x: 800, y: 800, parentId: 'n7-8', date: Date.now()-25000, cluster: 'C', promisingness: 95 },

                // --- T8: ç—…æ¯’ (15 nodes) ---
                { id: 'n8-1', topicId: 't8', type: 'question', title: 'ç—…æ¯’æ˜¯ç”Ÿç‰©å—ï¼Ÿ', content: 'å®ƒæœ‰éºå‚³ç‰©è³ªï¼Œæœƒæ¼”åŒ–ï¼Œä½†ä¸èƒ½è‡ªå·±ç¹æ®–ï¼Œå¿…é ˆå¯„ç”Ÿã€‚é€™æ¨£ç®—ç”Ÿç‰©å—ï¼Ÿ', author: 'u1', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 50 },
                { id: 'n8-2', topicId: 't8', type: 'extend', title: 'ç”Ÿç‰©çš„å®šç¾©', content: 'å‚³çµ±å®šç¾©è¦æœ‰ï¼šç”Ÿé•·ã€ä»£è¬ã€åæ‡‰ã€ç”Ÿæ®–ã€‚ç—…æ¯’ç¼ºä¹ä»£è¬èƒ½åŠ›ã€‚', author: 'u4', x: 100, y: 300, parentId: 'n8-1', date: Date.now()-90000, cluster: 'B', promisingness: 60 },
                { id: 'n8-3', topicId: 't8', type: 'improve', title: 'ä»‹æ–¼é‚Šç·£', content: 'ç§‘å­¸å®¶é€šå¸¸æŠŠå®ƒæ­¸é¡ç‚ºã€Œä»‹æ–¼ç”Ÿç‰©èˆ‡éç”Ÿç‰©ä¹‹é–“çš„è¤‡é›œæœ‰æ©Ÿé«”ã€ã€‚', author: 'u5', x: 350, y: 300, parentId: 'n8-2', date: Date.now()-85000, cluster: 'B', promisingness: 70 },
                { id: 'n8-4', topicId: 't8', type: 'counter', title: 'å·¨å‹ç—…æ¯’çš„ç™¼ç¾', content: 'ä½†æœ€è¿‘ç™¼ç¾çš„æ“¬èŒç—…æ¯’ (Mimivirus) å¾ˆå¤§ï¼ŒåŸºå› ä¹Ÿå¾ˆå¤šï¼Œç”šè‡³æœ‰éƒ¨åˆ†ä»£è¬æ©Ÿåˆ¶ï¼ŒæŒ‘æˆ°äº†é‚Šç•Œã€‚', author: 'u6', x: 600, y: 400, parentId: 'n8-3', date: Date.now()-80000, cluster: 'A', promisingness: 85 },
                { id: 'n8-5', topicId: 't8', type: 'riseabove', title: 'é€£çºŒå…‰è­œè§€é»', content: 'ç”Ÿå‘½å¯èƒ½ä¸æ˜¯äºŒåˆ†æ³• (æ˜¯/å¦)ï¼Œè€Œæ˜¯ä¸€å€‹é€£çºŒçš„å…‰è­œã€‚ç—…æ¯’è™•æ–¼åŒ–å­¸ç‰©è³ªæ¼”åŒ–æˆç”Ÿå‘½çš„éæ¸¡éšæ®µã€‚', author: 'u1', x: 500, y: 600, parentId: 'n8-4', date: Date.now()-75000, cluster: 'C', promisingness: 90 },
                { id: 'n8-6', topicId: 't8', type: 'question', title: 'ç—…æ¯’èµ·æºå‡èªª', content: 'ç—…æ¯’æ˜¯æœ€æ—©çš„ç”Ÿå‘½ï¼Ÿé‚„æ˜¯å¾ç´°èƒé€€åŒ–ä¾†çš„ï¼Ÿ', author: 'u9', x: 800, y: 200, parentId: null, date: Date.now()-70000, cluster: 'A', promisingness: 60 },
                { id: 'n8-7', topicId: 't8', type: 'extend', title: 'é€ƒé€¸å‡èªª (Escaped)', content: 'å¯èƒ½æ˜¯ç´°èƒå…§çš„ DNA/RNA ç‰‡æ®µã€Œé€ƒå®¶ã€äº†ï¼Œç²å¾—äº†å¤–æ®¼ã€‚', author: 'u2', x: 800, y: 400, parentId: 'n8-6', date: Date.now()-65000, cluster: 'B', promisingness: 70 },
                { id: 'n8-8', topicId: 't8', type: 'extend', title: 'é€€åŒ–å‡èªª (Regressive)', content: 'å¯èƒ½æ˜¯åŸæœ¬å¯„ç”Ÿçš„ç´°èƒé€€åŒ–åˆ°åªå‰©ä¸‹æ ¸å¿ƒéºå‚³ç‰©è³ªã€‚', author: 'u8', x: 1050, y: 400, parentId: 'n8-6', date: Date.now()-60000, cluster: 'B', promisingness: 70 },
                { id: 'n8-9', topicId: 't8', type: 'extend', title: 'ç—…æ¯’å„ªå…ˆå‡èªª (Virus-first)', content: 'åœ¨ç´°èƒå‡ºç¾å‰å°±å­˜åœ¨ï¼Œèˆ‡åŸå§‹æ¹¯å…±æ¼”åŒ–ã€‚', author: 'u10', x: 1300, y: 400, parentId: 'n8-6', date: Date.now()-55000, cluster: 'B', promisingness: 70 },
                { id: 'n8-10', topicId: 't8', type: 'improve', title: 'RNA ä¸–ç•Œå­¸èªª', content: 'é€™æ”¯æŒ RNA ä¸–ç•Œå­¸èªªï¼Œæœ€æ—©çš„ç”Ÿå‘½å½¢å¼å¯èƒ½æ˜¯å…·æœ‰è‡ªæˆ‘è¤‡è£½èƒ½åŠ›çš„ RNAã€‚', author: 'u3', x: 1050, y: 600, parentId: 'n8-9', date: Date.now()-50000, cluster: 'C', promisingness: 80 },
                { id: 'n8-11', topicId: 't8', type: 'question', title: 'ç—…æ¯’å°æ¼”åŒ–çš„è²¢ç»', content: 'ç—…æ¯’åªæœƒè‡´ç—…å—ï¼Ÿå°æ¼”åŒ–æœ‰å¹«åŠ©å—ï¼Ÿ', author: 'u7', x: 100, y: 500, parentId: null, date: Date.now()-45000, cluster: 'A', promisingness: 55 },
                { id: 'n8-12', topicId: 't8', type: 'improve', title: 'åŸºå› æ°´å¹³è½‰ç§»', content: 'ç—…æ¯’æ˜¯åŸºå› çš„æ¬é‹å·¥ï¼Œèƒ½åœ¨ä¸åŒç‰©ç¨®é–“å‚³éåŸºå› ï¼ŒåŠ é€Ÿæ¼”åŒ–ã€‚', author: 'u6', x: 100, y: 700, parentId: 'n8-11', date: Date.now()-40000, cluster: 'B', promisingness: 85 },
                { id: 'n8-13', topicId: 't8', type: 'extend', title: 'èƒç›¤çš„å½¢æˆ', content: 'å“ºä¹³é¡æ¼”åŒ–å‡ºèƒç›¤ï¼Œæ“šèªªå°±è·Ÿé å¤ç—…æ¯’æ„ŸæŸ“å¸¶ä¾†çš„åŸºå› æœ‰é—œ (Syncytin)ã€‚', author: 'u1', x: 300, y: 800, parentId: 'n8-12', date: Date.now()-35000, cluster: 'B', promisingness: 95 },
                { id: 'n8-14', topicId: 't8', type: 'counter', title: 'å™¬èŒé«”ç™‚æ³•', content: 'ç—…æ¯’ä¹Ÿå¯ä»¥ç”¨ä¾†æ®ºç´°èŒ (å™¬èŒé«”)ï¼Œåœ¨æŠ—ç”Ÿç´ æŠ—è—¥æ€§åš´é‡çš„ä»Šå¤©å¾ˆæœ‰æ½›åŠ›ã€‚', author: 'u4', x: 300, y: 600, parentId: 'n8-11', date: Date.now()-30000, cluster: 'B', promisingness: 75 },
                { id: 'n8-15', topicId: 't8', type: 'riseabove', title: 'å…±ç”Ÿèˆ‡å¹³è¡¡', content: 'ç—…æ¯’æ˜¯ç”Ÿæ…‹ç³»èª¿ç¯€è€…ï¼Œæ§åˆ¶å®¿ä¸»æ•¸é‡ï¼Œä¸¦ç¶­æŒåŸºå› å¤šæ¨£æ€§ã€‚', author: 'u1', x: 500, y: 800, parentId: 'n8-14', date: Date.now()-25000, cluster: 'C', promisingness: 90 },

                // --- T9: æ•¸å­¸ç™¼ç¾æˆ–ç™¼æ˜ (15 nodes) ---
                { id: 'n9-1', topicId: 't9', type: 'question', title: 'æ•¸å­¸æ˜¯ç™¼ç¾é‚„æ˜¯ç™¼æ˜ï¼Ÿ', content: 'åœ“å‘¨ç‡ Pi æ˜¯å®‡å®™ä¸­æœ¬ä¾†å°±æœ‰çš„ï¼Œé‚„æ˜¯äººé¡å®šç¾©å‡ºä¾†çš„ï¼Ÿ', author: 'u1', x: 100, y: 100, parentId: null, date: Date.now()-100000, cluster: 'A', promisingness: 60 },
                { id: 'n9-2', topicId: 't9', type: 'extend', title: 'æŸæ‹‰åœ–ä¸»ç¾© (ç™¼ç¾è«–)', content: 'æŸæ‹‰åœ–èªç‚ºæ•¸å­¸å¯¦é«”å­˜åœ¨æ–¼ä¸€å€‹ç¨ç«‹çš„ç†å‹ä¸–ç•Œï¼Œæˆ‘å€‘åªæ˜¯ã€Œç™¼ç¾ã€äº†å®ƒå€‘ã€‚', author: 'u5', x: 100, y: 300, parentId: 'n9-1', date: Date.now()-90000, cluster: 'B', promisingness: 75 },
                { id: 'n9-3', topicId: 't9', type: 'improve', title: 'å¤–æ˜Ÿäººä¹Ÿæœƒç®— Pi', content: 'å¦‚æœæœ‰å¤–æ˜Ÿæ–‡æ˜ï¼Œä»–å€‘ç®—çš„åœ“å‘¨ç‡ä¸€å®šä¹Ÿæ˜¯ 3.14159... é€™è­‰æ˜æ•¸å­¸æ˜¯å®¢è§€å­˜åœ¨çš„çœŸç†ã€‚', author: 'u3', x: 350, y: 300, parentId: 'n9-2', date: Date.now()-85000, cluster: 'B', promisingness: 80 },
                { id: 'n9-4', topicId: 't9', type: 'counter', title: 'å½¢å¼ä¸»ç¾© (ç™¼æ˜è«–)', content: 'ä½†æ•¸å­¸ç¬¦è™Ÿã€å…¬ç†é«”ç³» (Axioms) æ˜¯äººé¡ç™¼æ˜çš„éŠæˆ²è¦å‰‡ã€‚å°±åƒè¥¿æ´‹æ£‹è¦å‰‡æ˜¯ç™¼æ˜çš„ã€‚', author: 'u2', x: 600, y: 300, parentId: 'n9-1', date: Date.now()-80000, cluster: 'A', promisingness: 70 },
                { id: 'n9-5', topicId: 't9', type: 'extend', title: 'éæ­å¹¾ä½•', content: 'ç•¶æˆ‘å€‘æ”¹è®Šå¹³è¡Œå…¬è¨­ï¼Œå°±å‰µé€ å‡ºéæ­å¹¾ä½•ã€‚é€™é¡¯ç¤ºæ•¸å­¸çµæ§‹å¯ä»¥è¢«äººé¡éš¨æ„å‰µé€ ï¼Œåªè¦é‚è¼¯è‡ªæ´½ã€‚', author: 'u8', x: 850, y: 400, parentId: 'n9-4', date: Date.now()-75000, cluster: 'B', promisingness: 85 },
                { id: 'n9-6', topicId: 't9', type: 'improve', title: 'ç‰©ç†ä¸–ç•Œçš„æœ‰æ•ˆæ€§', content: 'Wigner æå‡ºã€Œæ•¸å­¸åœ¨è‡ªç„¶ç§‘å­¸ä¸­ä¸åˆç†çš„æœ‰æ•ˆæ€§ã€ã€‚ç‚ºä»€éº¼äººé¡ç™¼æ˜çš„æ•¸å­¸ï¼Œç«Ÿèƒ½ç²¾æº–é æ¸¬é»‘æ´ï¼Ÿ', author: 'u6', x: 600, y: 500, parentId: 'n9-3', date: Date.now()-70000, cluster: 'C', promisingness: 90 },
                { id: 'n9-7', topicId: 't9', type: 'riseabove', title: 'é›™é‡æ€§è³ª', content: 'æˆ–è¨±æ˜¯å…©è€…çš†æ˜¯ï¼Ÿæ¦‚å¿µå’Œé—œä¿‚æ˜¯ã€Œç™¼ç¾ã€çš„(å—åˆ¶æ–¼é‚è¼¯)ï¼Œä½†æè¿°èªè¨€å’Œç¬¦è™Ÿæ˜¯ã€Œç™¼æ˜ã€çš„ã€‚', author: 'u1', x: 500, y: 700, parentId: 'n9-6', date: Date.now()-65000, cluster: 'C', promisingness: 95 },
                { id: 'n9-8', topicId: 't9', type: 'question', title: 'æ•¸å­¸å­˜åœ¨æ–¼å¤§è…¦ä¸­å—ï¼Ÿ', content: 'ç¥ç¶“ç§‘å­¸æ€éº¼çœ‹ï¼Ÿæ•¸å­¸åªæ˜¯å¤§è…¦ç¥ç¶“é€£çµçš„ç”¢ç‰©ï¼Ÿ', author: 'u9', x: 900, y: 200, parentId: null, date: Date.now()-60000, cluster: 'A', promisingness: 50 },
                { id: 'n9-9', topicId: 't9', type: 'improve', title: 'å…·èº«èªçŸ¥ (Embodied Cognition)', content: 'Lakoff èªç‚ºæ•¸å­¸æºè‡ªæ–¼æˆ‘å€‘çš„èº«é«”ç¶“é©—ï¼ˆå¦‚æ‰‹æŒ‡è¨ˆæ•¸ã€ç©ºé–“æ„Ÿï¼‰ã€‚', author: 'u10', x: 900, y: 400, parentId: 'n9-8', date: Date.now()-55000, cluster: 'B', promisingness: 65 },
                { id: 'n9-10', topicId: 't9', type: 'counter', title: 'ç„¡çª®çš„æ¦‚å¿µ', content: 'ä½†æˆ‘å€‘ç„¡æ³•ç¶“é©—ã€Œç„¡çª®ã€ï¼Œæ•¸å­¸å»èƒ½è™•ç†ç„¡çª®ã€‚é€™è¶…è¶Šäº†èº«é«”ç¶“é©—ã€‚', author: 'u4', x: 1150, y: 400, parentId: 'n9-9', date: Date.now()-50000, cluster: 'A', promisingness: 75 },
                { id: 'n9-11', topicId: 't9', type: 'extend', title: 'ç¢å½¢ (Fractals)', content: 'æ›¼å¾·åšé›†åˆåœ¨é›»è…¦è¢«ç™¼æ˜å‰å°±å­˜åœ¨äº†å—ï¼Ÿå®ƒçš„åœ–å½¢è¤‡é›œåº¦ç„¡é™ï¼Œä¼¼ä¹ä¸€ç›´åœ¨é‚£è£¡ç­‰è‘—è¢«çœ‹è¦‹ã€‚', author: 'u7', x: 200, y: 600, parentId: 'n9-2', date: Date.now()-45000, cluster: 'B', promisingness: 80 },
                { id: 'n9-12', topicId: 't9', type: 'improve', title: 'è™›æ•¸çš„çœŸå¯¦æ€§', content: 'è™›æ•¸ i ä¸€é–‹å§‹è¢«èªç‚ºæ˜¯è™›æ§‹çš„ï¼Œå¾Œä¾†å»ç™¼ç¾æ˜¯æè¿°é›»ç£æ³¢æ‰€å¿…éœ€çš„ã€‚ç™¼æ˜çš„å·¥å…·è®Šæˆäº†ç™¼ç¾çœŸç†çš„é‘°åŒ™ã€‚', author: 'u3', x: 400, y: 800, parentId: 'n9-6', date: Date.now()-40000, cluster: 'C', promisingness: 85 },
                { id: 'n9-13', topicId: 't9', type: 'question', title: 'å‹•ç‰©æ‡‚æ•¸å­¸å—ï¼Ÿ', content: 'å¦‚æœå‹•ç‰©ä¹Ÿæœ‰æ•¸å­¸æ„Ÿï¼Œé‚£æ•¸å­¸å°±æ˜¯ç”Ÿç‰©æ¼”åŒ–çš„ä¸€éƒ¨åˆ†ï¼Ÿ', author: 'u5', x: 1100, y: 600, parentId: null, date: Date.now()-35000, cluster: 'A', promisingness: 55 },
                { id: 'n9-14', topicId: 't9', type: 'extend', title: 'æ•¸æ„Ÿ (Number Sense)', content: 'çƒé´‰å’Œèœœèœ‚éƒ½æœ‰æ•¸é‡æ„Ÿï¼Œé€™æ˜¯ä¸€ç¨®ç”Ÿå­˜æœ¬èƒ½ï¼Œä¸æ˜¯æŠ½è±¡é‚è¼¯ã€‚', author: 'u2', x: 1300, y: 700, parentId: 'n9-13', date: Date.now()-30000, cluster: 'B', promisingness: 60 },
                { id: 'n9-15', topicId: 't9', type: 'riseabove', title: 'å®‡å®™çš„èªè¨€', content: 'ä¼½åˆ©ç•¥èªªï¼šã€Œå®‡å®™æ˜¯ç”¨æ•¸å­¸èªè¨€å¯«æˆçš„ã€‚ã€ç„¡è«–æ˜¯ç™¼ç¾é‚„æ˜¯ç™¼æ˜ï¼Œå®ƒéƒ½æ˜¯æˆ‘å€‘èˆ‡å®‡å®™å°è©±çš„å”¯ä¸€ä»‹é¢ã€‚', author: 'u1', x: 800, y: 800, parentId: 'n9-6', date: Date.now()-25000, cluster: 'C', promisingness: 100 }
            ]
        };

        window.state = {
            // ğŸ”¥ [FIX] Initialize with seed user to prevent "null" errors before cloud load
            user: window.SEED_DATA.userList['teacher'], 
            userList: {...window.SEED_DATA.userList},
            topics: [], nodes: [], trash: [], currentView: 'entrance', currentTopicId: null,
            activeFilter: 'å…¨éƒ¨', tempSelectedCategories: [], 
            editingTopicId: null, // Add editing state
            canvas: { 
                scale: 1, offsetX: 0, offsetY: 0, 
                isDragging: false, lastX: 0, lastY: 0, 
                draggedNodeId: null, isClusterMode: false, isHeatmapMode: false, 
                animFrame: null,
                // Selection Box State
                isSelecting: false, selectionStart: {x: 0, y: 0}, selectionCurrent: {x: 0, y: 0},
                isPanMode: false,
                // Pinch Zoom State
                isPinching: false, lastPinchDist: 0, startPinchScale: 1
            },
            selectedNodeIds: [],
            composer: { parentId: null, selectedScaffold: null }, profile: null
        };
        
        // ğŸ”¥ [MODIFIED] 3. Data Manager Logic (Cloud Sync)
        window.dataManager = {
            save: () => { 
                const dataToSave = {
                    userList: window.state.userList,
                    topics: window.state.topics,
                    nodes: window.state.nodes,
                    trash: window.state.trash
                };
                db.collection(DB_COLLECTION).doc(DB_DOC).set(dataToSave)
                  .then(() => { console.log("Cloud Saved"); })
                  .catch((e) => { console.error("Save error:", e); });
                
                // Save session state to local storage
                window.dataManager.saveLocalSession();
            },
            saveLocalSession: () => {
                // FORCE SAVE CURRENT USER TO LOCAL STORAGE
                if (!window.state.user) return;
                const userKey = Object.keys(window.state.userList).find(key => window.state.userList[key].id === window.state.user.id);
                const localState = {
                    currentUserKey: userKey || 'teacher',
                    currentView: window.state.currentView, 
                    currentTopicId: window.state.currentTopicId
                };
                localStorage.setItem('kb_local_session', JSON.stringify(localState));
            },
            load: () => {
                // 1. Listen to Cloud Data
                db.collection(DB_COLLECTION).doc(DB_DOC).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        window.state.userList = data.userList || window.SEED_DATA.userList;
                        window.state.topics = data.topics || window.SEED_DATA.topics;
                        window.state.nodes = data.nodes || window.SEED_DATA.nodes;
                        window.state.trash = data.trash || [];
                        
                        // [FIX] Robust User Restoration
                        // Always try to restore user from LocalStorage first, even if cloud updates
                        const localSession = localStorage.getItem('kb_local_session');
                        let userKey = 'teacher';
                        if(localSession) {
                            try {
                                const parsed = JSON.parse(localSession);
                                // Verify if the key still exists in the new userList
                                if(window.state.userList[parsed.currentUserKey]) {
                                    userKey = parsed.currentUserKey;
                                }
                            } catch(e){}
                        }
                        
                        // Set User
                        window.state.user = window.state.userList[userKey] || window.state.userList['teacher'];

                        // Re-render current view
                        if (window.state.currentView === 'entrance') window.ui.renderEntrance();
                        else if (window.state.currentView === 'canvas') window.ui.renderCanvas();
                        else if (window.state.currentView === 'profile') window.ui.renderProfile();
                        window.ui.renderUserInfo();
                        window.ui.renderUserMenu();
                        window.app.updateTrashBadge();
                    } else {
                        // Init seed data if empty
                        window.state.userList = JSON.parse(JSON.stringify(window.SEED_DATA.userList));
                        window.state.topics = JSON.parse(JSON.stringify(window.SEED_DATA.topics));
                        window.state.nodes = JSON.parse(JSON.stringify(window.SEED_DATA.nodes));
                        window.state.trash = [];
                        window.state.user = window.state.userList['teacher'];
                        window.dataManager.save();
                    }
                });

                // 2. Load Local Session State (View/Topic)
                const localSession = localStorage.getItem('kb_local_session');
                if (localSession) {
                    try {
                        const parsed = JSON.parse(localSession);
                        window.state.currentView = parsed.currentView || 'entrance';
                        window.state.currentTopicId = parsed.currentTopicId || null;
                    } catch(e) {}
                }
            },
            reset: () => { 
                if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿé€™å°‡åˆªé™¤é›²ç«¯è³‡æ–™åº«ä¸¦è¼‰å…¥æœ€æ–°çš„ã€ŒçŸ¥è­˜å»ºæ§‹ç¯„ä¾‹æ•™æã€ã€‚")) {
                    const seed = {
                        userList: window.SEED_DATA.userList,
                        topics: window.SEED_DATA.topics,
                        nodes: window.SEED_DATA.nodes,
                        trash: []
                    };
                    db.collection(DB_COLLECTION).doc(DB_DOC).set(seed)
                    .then(() => { 
                        window.location.reload(); 
                    });
                }
            }
        };

        window.app = {};

        // Helper functions
        window.app.generateCategoryOptions = () => Object.entries(window.TOPIC_CATEGORIES).map(([value, label]) => `<option value="${value}">${label}</option>`).join('');
        
        window.app.generateCategoryFilters = () => {
            let html = `<button class="px-4 py-1.5 rounded-full text-sm font-medium filter-btn transition ${window.state.activeFilter === 'å…¨éƒ¨' ? 'active bg-slate-200 text-slate-900 border-slate-300' : 'bg-white text-slate-500 border border-slate-200'}" data-category="å…¨éƒ¨">æ‰€æœ‰ä¸»é¡Œ</button>`;
            html += Object.keys(window.TOPIC_CATEGORIES).map(key => {
                const isActive = window.state.activeFilter === key;
                const label = window.TOPIC_CATEGORIES[key];
                return `<button class="px-4 py-1.5 rounded-full text-sm font-medium filter-btn transition ${isActive ? 'active bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-white text-slate-500 border border-slate-200'}" data-category="${key}">${label}</button>`;
            }).join('');
            return html;
        };

        window.app.setFilter = (category) => { window.state.activeFilter = category; window.ui.renderEntrance(); };
        window.app.initCategorySelector = () => { };
        window.app.renderCategorySelector = () => {
            const container = document.getElementById('topic-category-selector'); if(!container) return;
            container.innerHTML = Object.keys(window.TOPIC_CATEGORIES).map(key => {
                const isSelected = window.state.tempSelectedCategories.includes(key);
                return `<span onclick="window.app.toggleTempCategory('${key}')" class="category-tag px-3 py-1 rounded-full text-xs font-bold border ${isSelected ? 'selected' : 'bg-white text-slate-500 border-slate-200'}">${window.TOPIC_CATEGORIES[key]}</span>`;
            }).join('');
        };
        window.app.toggleTempCategory = (key) => {
            if (window.state.tempSelectedCategories.includes(key)) { window.state.tempSelectedCategories = window.state.tempSelectedCategories.filter(c => c !== key); } else { window.state.tempSelectedCategories.push(key); }
            window.app.renderCategorySelector();
        };

        // Routing & User
        window.app.router = (view) => {
            if (view === 'canvas' && !window.state.currentTopicId) { window.ui.showToast('è«‹å…ˆå¾ä¸»é¡Œå…¥å£é¸æ“‡ä¸€å€‹æ¢ç©¶ä¸»é¡Œ', 'error'); window.app.router('entrance'); return; }
            window.state.currentView = view;
            if(view === 'entrance') { window.state.currentTopicId = null; }
            window.dataManager.saveLocalSession(); // Save view change
            window.ui.updateNav(view);
            document.getElementById('user-menu').classList.add('hidden');
            if(view === 'entrance') { window.ui.renderEntrance(); }
            else if(view === 'canvas') { window.ui.renderCanvas(); }
            else if(view === 'profile') { window.ui.renderProfile(); }
        };
        
        // Add Mobile Analytics Menu Opener
        window.app.openAnalyticsMenu = () => {
            document.getElementById('modal-analytics-menu').classList.remove('hidden');
        };

        window.app.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
        window.app.openAddUserModal = () => { document.getElementById('modal-addUser').classList.remove('hidden'); document.getElementById('user-menu').classList.add('hidden'); document.getElementById('new-user-name').focus(); };
        window.app.createNewUser = () => {
            const nameInput = document.getElementById('new-user-name'); const roleInput = document.getElementById('new-user-role');
            const name = nameInput.value.trim(); if (!name) return window.ui.showToast('æš±ç¨±ä¸èƒ½ç‚ºç©º', 'error');
            const newKey = `user${Date.now()}`; const newId = `u${Date.now()}`;
            window.state.userList[newKey] = { id: newId, name, role: roleInput.value, avatar: `https://api.dicebear.com/9.x/notionists/svg?seed=${name}` };
            window.dataManager.save(); window.ui.closeModal('modal-addUser'); window.ui.renderUserMenu(); window.ui.showToast('æ–°å¢æˆåŠŸ'); window.app.switchUser(newKey);
        };
        window.app.deleteUser = (key) => {
            if (window.state.userList[key].id === window.state.user.id) return window.ui.showToast('ç„¡æ³•åˆªé™¤ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…', 'error');
            if (Object.keys(window.state.userList).length <= 1) return window.ui.showToast('ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€ä½ä½¿ç”¨è€…', 'error');
            window.ui.confirm('ç¢ºå®šåˆªé™¤ä½¿ç”¨è€…ï¼Ÿ', 'æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => { delete window.state.userList[key]; window.dataManager.save(); window.ui.renderUserMenu(); window.ui.showToast('ä½¿ç”¨è€…å·²åˆªé™¤'); window.ui.closeModal('modal-confirm'); });
        };
        window.app.switchUser = (userKey) => {
            if (!window.state.userList[userKey]) return;
            window.state.user = window.state.userList[userKey]; 
            window.state.profile = null; 
            
            // [FIX] Force immediate local save before cloud sync
            window.dataManager.saveLocalSession();
            
            window.dataManager.save(); // Also sync to cloud
            window.ui.renderUserInfo(); 
            window.ui.renderUserMenu(); 
            window.ui.showToast(`å·²åˆ‡æ›ï¼š${window.state.user.name}`); 
            document.getElementById('user-menu').classList.add('hidden');
            if(window.state.currentView === 'canvas') window.ui.renderCanvas(); else if(window.state.currentView === 'profile') window.ui.renderProfile(); else window.ui.renderEntrance();
        };

        // Data Manipulation
        window.app.openCreateTopic = () => {
            window.state.editingTopicId = null;
            document.getElementById('modal-topic-title').innerHTML = '<i class="fa-solid fa-folder-plus text-indigo-600"></i> é–‹å•Ÿæ¢ç©¶ä¸»é¡Œ';
            document.getElementById('btn-topic-save').innerText = 'å»ºç«‹';
            document.getElementById('topic-name').value = '';
            document.getElementById('topic-desc').value = '';
            window.state.tempSelectedCategories = [];
            window.app.renderCategorySelector();
            document.getElementById('modal-topic').classList.remove('hidden');
        };

        window.app.openEditTopic = (id) => {
            const topic = window.state.topics.find(t => t.id === id);
            if (!topic) return;
            
            window.state.editingTopicId = id;
            document.getElementById('modal-topic-title').innerHTML = '<i class="fa-solid fa-pen-to-square text-indigo-600"></i> ç·¨è¼¯æ¢ç©¶ä¸»é¡Œ';
            document.getElementById('btn-topic-save').innerText = 'å„²å­˜ä¿®æ”¹';
            
            document.getElementById('topic-name').value = topic.name;
            document.getElementById('topic-desc').value = topic.desc;
            window.state.tempSelectedCategories = [...(topic.categories || [])];
            window.app.renderCategorySelector();
            
            document.getElementById('modal-topic').classList.remove('hidden');
        };

        window.app.saveTopic = () => {
            const name = document.getElementById('topic-name').value; 
            if(!name) return window.ui.showToast('è«‹è¼¸å…¥å•é¡Œ', 'error');
            const categories = window.state.tempSelectedCategories.length > 0 ? window.state.tempSelectedCategories : ['å…¶ä»–'];
            const desc = document.getElementById('topic-desc').value;

            if (window.state.editingTopicId) {
                // Update existing topic
                const topicIndex = window.state.topics.findIndex(t => t.id === window.state.editingTopicId);
                if (topicIndex !== -1) {
                    window.state.topics[topicIndex].name = name;
                    window.state.topics[topicIndex].categories = categories;
                    window.state.topics[topicIndex].desc = desc;
                    window.ui.showToast('ä¸»é¡Œå·²æ›´æ–°');
                }
            } else {
                // Create new topic
                window.state.topics.unshift({ 
                    id: 't'+Date.now(), 
                    name, 
                    categories: categories, 
                    desc: desc, 
                    author: window.state.user.id, 
                    date: new Date().toISOString() 
                });
                window.ui.showToast('ä¸»é¡Œå·²å»ºç«‹');
            }
            
            window.dataManager.save(); 
            window.ui.closeModal('modal-topic'); 
            window.ui.renderEntrance();
        };

        window.app.updateTrashBadge = () => {
            const badge = document.getElementById('trash-count-badge'); if(!badge) return;
            const count = window.state.trash.length;
            if(count > 0) { badge.innerText = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
        };
        window.app.openTrash = () => { window.ui.renderTrashList(); document.getElementById('modal-trash').classList.remove('hidden'); document.getElementById('user-menu').classList.add('hidden'); };
        window.app.restoreTrashItem = (trashId) => {
            const itemIndex = window.state.trash.findIndex(t => t.id === trashId); if(itemIndex === -1) return;
            const item = window.state.trash[itemIndex];
            if (item.type === 'topic') { window.state.topics.unshift(item.data); window.state.nodes.push(...item.relatedNodes); } else { window.state.nodes.push(...item.data); }
            window.state.trash.splice(itemIndex, 1); window.dataManager.save(); window.ui.renderTrashList(); window.app.updateTrashBadge();
            if(window.state.currentView === 'entrance') window.ui.renderEntrance(); if(window.state.currentView === 'canvas') window.ui.renderCanvas();
            window.ui.showToast('å·²é‚„åŸé …ç›®', 'success');
        };
        window.app.deleteTrashItem = (trashId) => {
            window.ui.confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ', 'æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼', () => { window.state.trash = window.state.trash.filter(t => t.id !== trashId); window.dataManager.save(); window.ui.renderTrashList(); window.app.updateTrashBadge(); window.ui.closeModal('modal-confirm'); window.ui.showToast('å·²æ°¸ä¹…åˆªé™¤'); });
        };
        window.app.emptyTrash = () => {
            if(window.state.trash.length === 0) return;
            window.ui.confirm('ç¢ºå®šæ¸…ç©ºå›æ”¶æ¡¶ï¼Ÿ', 'æ‰€æœ‰é …ç›®å°‡æ°¸ä¹…æ¶ˆå¤±ï¼', () => { window.state.trash = []; window.dataManager.save(); window.ui.renderTrashList(); window.app.updateTrashBadge(); window.ui.closeModal('modal-confirm'); window.ui.showToast('å›æ”¶æ¡¶å·²æ¸…ç©º'); });
        };
        window.app.deleteTopic = (id) => {
            window.ui.confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 'ä¸»é¡Œå°‡è¢«ç§»è‡³è³‡æºå›æ”¶æ¡¶ã€‚', () => {
                const topic = window.state.topics.find(t => t.id === id); const associatedNodes = window.state.nodes.filter(n => n.topicId === id);
                window.state.trash.unshift({ id: `trash-${Date.now()}`, type: 'topic', data: topic, relatedNodes: associatedNodes, deletedAt: Date.now(), deletedBy: window.state.user.id });
                window.state.topics = window.state.topics.filter(t => t.id !== id); window.state.nodes = window.state.nodes.filter(n => n.topicId !== id);
                window.dataManager.save(); window.app.updateTrashBadge(); window.ui.closeModal('modal-confirm'); window.ui.renderEntrance(); window.ui.showToast('ä¸»é¡Œå·²ç§»è‡³å›æ”¶æ¡¶');
            });
        };
        window.app.deleteNode = (id) => {
            window.ui.confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 'æƒ³æ³•å°‡è¢«ç§»è‡³è³‡æºå›æ”¶æ¡¶ã€‚', () => {
                const toDel = [];
                const findChildren = (pid) => { window.state.nodes.filter(n => n.parentId === pid).forEach(c => { toDel.push(c); findChildren(c.id); }); };
                const target = window.state.nodes.find(n => n.id === id);
                if(target) { toDel.push(target); findChildren(id); }
                window.state.trash.unshift({ id: `trash-${Date.now()}`, type: 'node', data: toDel, deletedAt: Date.now(), deletedBy: window.state.user.id });
                const idsToDelete = toDel.map(n => n.id);
                window.state.nodes = window.state.nodes.filter(n => !idsToDelete.includes(n.id));
                window.dataManager.save(); window.app.updateTrashBadge(); window.ui.closeModal('modal-confirm'); window.ui.renderCanvas(); window.ui.showToast('æƒ³æ³•å·²ç§»è‡³å›æ”¶æ¡¶');
            });
        };
        window.app.enterTopic = (id) => { window.state.currentTopicId = id; window.state.canvas.scale=1; window.state.canvas.offsetX=0; window.state.canvas.offsetY=0; window.app.router('canvas'); };
        
        // Node Composition
        window.app.openComposer = (pid) => {
            window.state.composer.parentId = pid;
            document.getElementById('scaffold-selector').innerHTML = Object.values(window.SCAFFOLDS).map(s => `
                <button onclick="window.app.selectScaffold('${s.id}')" id="btn-scaffold-${s.id}" class="flex flex-col items-center justify-center p-2 rounded-lg border-2 border-slate-100 opacity-60 transition hover:opacity-80">
                    <div class="w-8 h-8 md:w-8 md:h-8 rounded-full ${s.color} text-white flex justify-center items-center mb-1"><i class="fa-solid ${s.icon}"></i></div>
                    <span class="text-[10px] md:text-xs font-bold text-slate-600">${s.label}</span>
                </button>`).join('');
            const descEl = document.getElementById('scaffold-desc');
            if(descEl) { descEl.innerHTML = ''; descEl.className = 'hidden'; }
            document.getElementById('modal-node').classList.remove('hidden');
        };
        window.app.selectScaffold = (t) => {
            window.state.composer.selectedScaffold = t;
            Object.values(window.SCAFFOLDS).forEach(s => {
                const btn = document.getElementById(`btn-scaffold-${s.id}`);
                if(s.id === t) { btn.classList.remove('opacity-60', 'border-slate-100'); btn.classList.add('opacity-100', window.SCAFFOLDS[t].border, window.SCAFFOLDS[t].bgSoft); }
                else { btn.classList.add('opacity-60', 'border-slate-100'); btn.classList.remove('opacity-100', window.SCAFFOLDS[s.id].border, window.SCAFFOLDS[s.id].bgSoft); }
            });
            const s = window.SCAFFOLDS[t];
            const descEl = document.getElementById('scaffold-desc');
            if(descEl) {
                descEl.innerHTML = `<i class="fa-solid fa-circle-info mr-2"></i><span>${s.desc}</span>`;
                descEl.className = `text-xs md:text-sm mb-4 px-3 py-2 md:px-4 md:py-3 rounded-lg border flex items-start animate-fade-in ${s.bgSoft} ${s.text} ${s.border}`;
                descEl.classList.remove('hidden');
            }
        };
        window.app.checkAIIntervention = (e) => {
            const len = e.target.value.length;
            const box = document.getElementById('ai-suggestion-box');
            if(len > 5 && len < 20) box.classList.remove('hidden'); else box.classList.add('hidden');
        };
        window.app.submitNode = () => {
            if(!window.state.composer.selectedScaffold) return window.ui.showToast('è«‹é¸æ“‡æ„åœ–', 'error');
            const title = document.getElementById('node-title').value; // Get Title
            const content = document.getElementById('node-content').value;
            if(!title) return window.ui.showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'error'); // Validate Title
            if(!content) return window.ui.showToast('è«‹è¼¸å…¥å…§å®¹', 'error');
            
            const pid = window.state.composer.parentId;
            let nx, ny;
            if(pid) {
                const p = window.state.nodes.find(n => n.id === pid);
                nx = p.x + (Math.random()*100 - 50); ny = p.y + 200;
            } else {
                const wrap = document.getElementById('canvas-wrapper');
                nx = -window.state.canvas.offsetX + wrap.clientWidth/2 - 140;
                ny = -window.state.canvas.offsetY + wrap.clientHeight/2 - 100;
            }
            const randomCluster = ['A', 'B', 'C'][Math.floor(Math.random() * 3)];
            const randomProm = Math.floor(Math.random() * 100);
            
            window.state.nodes.push({ 
                id: 'n'+Date.now(), 
                topicId: window.state.currentTopicId, 
                type: window.state.composer.selectedScaffold, 
                title: title, // Save Title
                content: content, 
                author: window.state.user.id, 
                date: Date.now(), 
                x: nx, y: ny, 
                parentId: pid, 
                cluster: randomCluster, 
                promisingness: randomProm 
            });
            window.dataManager.save(); window.ui.closeModal('modal-node'); window.ui.renderCanvas();
        };
        window.app.openNodeDetail = (id) => {
            const n = window.state.nodes.find(x => x.id === id); if(!n) return;
            const s = window.SCAFFOLDS[n.type]; const u = Object.values(window.state.userList).find(u => u.id === n.author);
            const icon = document.getElementById('detail-scaffold-icon');
            icon.className = `w-8 h-8 md:w-10 md:h-10 rounded-full flex justify-center items-center text-white text-lg ${s.color}`;
            icon.innerHTML = `<i class="fa-solid ${s.icon}"></i>`;
            document.getElementById('detail-scaffold-label').innerText = s.label;
            document.getElementById('detail-scaffold-label').className = `text-xs font-bold uppercase mb-0.5 ${s.text}`;
            document.getElementById('detail-title').innerText = n.title || 'ç„¡æ¨™é¡Œ'; // Show Title
            document.getElementById('detail-author').innerText = u ? u.name : '?';
            document.getElementById('detail-date').innerText = new Date(n.date).toLocaleString();
            document.getElementById('detail-content').innerText = n.content;
            document.getElementById('btn-detail-reply').onclick = () => { window.ui.closeModal('modal-detail'); setTimeout(() => window.app.openComposer(n.id), 200); };
            document.getElementById('modal-detail').classList.remove('hidden');
        };

        // AI Mock
        window.app.generateAIProfile = () => {
            const btn = document.getElementById('btn-gen-profile'); const loading = document.getElementById('ai-loading');
            btn.classList.add('hidden'); loading.classList.remove('hidden'); document.getElementById('ai-profile-result').classList.add('hidden');
            setTimeout(() => {
                const myNodes = window.state.nodes.filter(n => n.author === window.state.user.id);
                const profileData = window.app.mockGeminiAnalysis(window.state.user, myNodes);
                window.state.profile = profileData; window.ui.renderProfileContent(profileData); loading.classList.add('hidden');
            }, 1500);
        };
        window.app.mockGeminiAnalysis = (user, nodes) => {
            const counts = { question:0, extend:0, improve:0, counter:0, riseabove:0 };
            nodes.forEach(n => { if(counts[n.type] !== undefined) counts[n.type]++; });
            const total = nodes.length || 1;
            let role, desc, icon;
            const maxType = Object.keys(counts).length > 0 ? Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b) : 'question';
            if (maxType === 'question') { role = "å‰ç»æ¢ç´¢è€… (Epistemic Explorer)"; desc = "ä½ å–„æ–¼ç™¼æ˜å•é¡Œçš„æœ¬è³ª..."; icon = "fa-compass"; } 
            else if (maxType === 'riseabove') { role = "è§€é»æ˜‡è¯è€… (Idea Synthesizer)"; desc = "ä½ æ“æœ‰å“è¶Šçš„æ•´åˆèƒ½åŠ›..."; icon = "fa-layer-group"; } 
            else if (maxType === 'counter') { role = "å»ºè¨­æ€§æ‰¹åˆ¤è€… (Constructive Critic)"; desc = "ä½ å‹‡æ–¼æŒ‘æˆ°æ—¢æœ‰å‡è¨­..."; icon = "fa-gavel"; } 
            else if (maxType === 'improve') { role = "ç†è«–å„ªåŒ–è€… (Theory Improver)"; desc = "ä½ æŒçºŒè‡´åŠ›æ–¼æ”¹å–„ä»–äººçš„æƒ³æ³•..."; icon = "fa-wrench"; } 
            else { role = "ç©æ¥µé€£çµè€… (Active Connector)"; desc = "ä½ ç©æ¥µä¸²è¯å„ç¨®æƒ³æ³•..."; icon = "fa-link"; }
            let trajectoryHTML = "";
            if (nodes.length === 0) { trajectoryHTML = "<p class='text-slate-500 italic'>å°šç„¡è¶³å¤ è³‡æ–™ä¾†åˆ†ææ¼”åŒ–è»Œè·¡ï¼Œå¿«å»è²¢ç»æƒ³æ³•å§ï¼</p>"; } else {
                const sorted = [...nodes].sort((a,b) => b.date - a.date).slice(0, 3);
                trajectoryHTML = sorted.map((n, i) => { const s = window.SCAFFOLDS[n.type]; return `<div class="flex items-start gap-3 relative pb-4 last:pb-0">${i !== sorted.length -1 ? '<div class="absolute left-[14px] top-8 bottom-0 w-0.5 bg-slate-200"></div>' : ''}<div class="w-7 h-7 rounded-full ${s.color} text-white flex items-center justify-center shrink-0 z-10 text-xs"><i class="fa-solid ${s.icon}"></i></div><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold px-2 py-0.5 rounded-full ${s.bgSoft} ${s.text}">${s.label}</span><span class="text-[10px] text-slate-400">${new Date(n.date).toLocaleDateString()}</span></div><p class="text-slate-900 font-bold text-xs mb-1">${n.title || ''}</p><p class="text-slate-700 text-sm bg-slate-50 p-2 rounded border border-slate-100">${n.content}</p></div></div>`; }).join('');
            }
            const replyCount = nodes.filter(n => n.parentId).length; 
            const sparkedCount = Math.floor(total * 0.8); 
            const communityHTML = `<div class="grid grid-cols-2 gap-4 mb-3"><div class="bg-blue-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${replyCount}</div><div class="text-xs text-blue-800">æ‰¿æ¥ä»–äººæƒ³æ³•</div></div><div class="bg-indigo-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-indigo-600">${sparkedCount}</div><div class="text-xs text-indigo-800">æ¿€ç™¼å¾ŒçºŒè¨è«–</div></div></div><p class="text-sm text-slate-600 leading-relaxed">${replyCount > sparkedCount ? "ä½ å‚¾å‘æ–¼<span class='font-bold text-blue-600'>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</span>ï¼Œå–„æ–¼æ¶ˆåŒ–ä¸¦å»¶çºŒä»–äººçš„è§€é»..." : "ä½ çš„æƒ³æ³•å…·æœ‰<span class='font-bold text-indigo-600'>é«˜åº¦å•Ÿç™¼æ€§</span>ï¼Œç¶“å¸¸æˆç‚ºç¤¾ç¾¤ç†±çƒˆè¨è«–çš„æ ¸å¿ƒ..."}</p>`;
            const statsHTML = Object.entries(counts).map(([k, v]) => { const pct = (v / total) * 100; const s = window.SCAFFOLDS[k]; return `<div class="mb-2"><div class="flex justify-between text-xs mb-1"><span class="font-medium text-slate-600 flex items-center gap-1"><i class="fa-solid ${s.icon} ${s.text}"></i> ${s.label}</span><span class="text-slate-400">${Math.round(pct)}%</span></div><div class="w-full bg-slate-100 rounded-full h-1.5"><div class="${s.color} h-1.5 rounded-full transition-all duration-1000" style="width: ${pct}%"></div></div></div>`; }).join('');
            return { role, desc, icon, trajectoryHTML, communityHTML, statsHTML };
        };

        // --- 4. Canvas Logic (Isolated Module) ---
        window.app.canvas = {
            renderLoop: () => {
                if (window.state.currentView === 'canvas') {
                    const nodes = window.state.nodes.filter(n => n.topicId === window.state.currentTopicId);
                    if (window.state.canvas.draggedNodeId || window.state.canvas.isAnimating) {
                            window.ui.drawConnections(nodes);
                    }
                }
                requestAnimationFrame(window.app.canvas.renderLoop);
            },
            applyTransform: () => {
                const el = document.getElementById('canvas-content');
                if(el) el.style.transform = `translate(${window.state.canvas.offsetX}px, ${window.state.canvas.offsetY}px) scale(${window.state.canvas.scale})`;
                const bg = document.getElementById('canvas-bg');
                if(bg) bg.style.backgroundPosition = `${window.state.canvas.offsetX}px ${window.state.canvas.offsetY}px`;
            },
            getCoords: (e) => (e.touches && e.touches.length > 0) ? {x: e.touches[0].clientX, y: e.touches[0].clientY} : {x: e.clientX, y: e.clientY},
            getDistance: (touches) => {
                return Math.hypot(
                    touches[0].clientX - touches[1].clientX,
                    touches[0].clientY - touches[1].clientY
                );
            },
            
            toggleMode: () => {
                window.state.canvas.isPanMode = !window.state.canvas.isPanMode;
                const w = document.getElementById('canvas-wrapper');
                if (window.state.canvas.isPanMode) {
                    if(w) w.style.cursor = 'grab';
                    window.state.canvas.isSelecting = false;
                    const sb = document.getElementById('selection-box');
                    if(sb) sb.style.display = 'none';
                    window.ui.showToast('å·²åˆ‡æ›ç‚ºï¼šæ‹–æ›³æ¨¡å¼ (æŒ‰å·¦éµæ‹–æ›³)', 'success');
                } else {
                    if(w) w.style.cursor = 'default';
                    window.ui.showToast('å·²åˆ‡æ›ç‚ºï¼šé¸å–æ¨¡å¼ (æŒ‰å·¦éµæ¡†é¸)', 'info');
                }
                window.ui.renderCanvas();
            },
            
            handleDoubleClick: (e) => {
                if (e.target.closest('.node-card')) return;
                window.app.canvas.toggleMode();
            },

            startPan: (e) => {
                // Pinch to Zoom Logic
                if (e.touches && e.touches.length === 2) {
                    window.state.canvas.isPinching = true;
                    window.state.canvas.lastPinchDist = window.app.canvas.getDistance(e.touches);
                    window.state.canvas.startPinchScale = window.state.canvas.scale;
                    return; // Don't start pan if pinching
                }

                if(e.target.closest('.node-card')) {
                    const nodeId = e.target.closest('.node-card').id.replace('node-', '');
                    if (!e.shiftKey && !e.ctrlKey && !window.state.selectedNodeIds.includes(nodeId)) {
                        window.state.selectedNodeIds = [];
                        // Manually clear classes to avoid re-render that kills double click
                        document.querySelectorAll('.node-card.selected-node').forEach(el => el.classList.remove('selected-node'));
                    }
                    if (!window.state.selectedNodeIds.includes(nodeId)) {
                        window.state.selectedNodeIds.push(nodeId);
                        // ğŸ”¥ [OPTIMIZED FIX] Visual update only - NO RENDER CANVAS
                        const card = document.getElementById(`node-${nodeId}`);
                        if(card) card.classList.add('selected-node');
                    }
                    return; 
                }
                if (e.ctrlKey || window.state.canvas.isPanMode) {
                    window.state.canvas.isDragging = true;
                    const c = window.app.canvas.getCoords(e);
                    window.state.canvas.lastX = c.x; 
                    window.state.canvas.lastY = c.y;
                    const w = document.getElementById('canvas-wrapper'); if(w) w.style.cursor = 'grabbing';
                    return;
                }
                window.state.canvas.isSelecting = true;
                const c = window.app.canvas.getCoords(e);
                window.state.canvas.selectionStart = {x: c.x, y: c.y};
                window.state.canvas.selectionCurrent = {x: c.x, y: c.y};
                const box = document.getElementById('selection-box');
                box.style.left = c.x + 'px';
                box.style.top = c.y + 'px';
                box.style.width = '0px';
                box.style.height = '0px';
                box.style.display = 'block';
                if (!e.shiftKey) {
                    window.state.selectedNodeIds = [];
                    // Visual update only
                    document.querySelectorAll('.node-card.selected-node').forEach(el => el.classList.remove('selected-node'));
                }
            },
            pan: (e) => {
                // Pinch to Zoom Logic
                if (window.state.canvas.isPinching && e.touches && e.touches.length === 2) {
                    const dist = window.app.canvas.getDistance(e.touches);
                    const zoomFactor = dist / window.state.canvas.lastPinchDist;
                    const newScale = window.state.canvas.startPinchScale * zoomFactor;
                    window.state.canvas.scale = Math.min(Math.max(0.2, newScale), 3);
                    window.app.canvas.applyTransform();
                    return;
                }

                const c = window.app.canvas.getCoords(e);
                if(window.state.canvas.isDragging) {
                    window.state.canvas.offsetX += c.x - window.state.canvas.lastX;
                    window.state.canvas.offsetY += c.y - window.state.canvas.lastY;
                    window.state.canvas.lastX = c.x; window.state.canvas.lastY = c.y;
                    window.app.canvas.applyTransform();
                } else if(window.state.canvas.draggedNodeId) {
                    const dx = (c.x - window.state.canvas.lastX) / window.state.canvas.scale;
                    const dy = (c.y - window.state.canvas.lastY) / window.state.canvas.scale;
                    
                    // Check if dragged node is part of selection
                    let nodesToMoveIds = [window.state.canvas.draggedNodeId];
                    if (window.state.selectedNodeIds.includes(window.state.canvas.draggedNodeId)) {
                        nodesToMoveIds = window.state.selectedNodeIds;
                    }

                    nodesToMoveIds.forEach(id => {
                        const node = window.state.nodes.find(n => n.id === id);
                        if(node) {
                            node.x += dx;
                            node.y += dy;
                            const el = document.getElementById(`node-${node.id}`);
                            if(el) {
                                el.style.left = `${node.x}px`;
                                el.style.top = `${node.y}px`;
                            }
                        }
                    });

                    window.state.canvas.lastX = c.x; window.state.canvas.lastY = c.y;
                } else if (window.state.canvas.isSelecting) {
                    window.state.canvas.selectionCurrent = {x: c.x, y: c.y};
                    const start = window.state.canvas.selectionStart;
                    const current = window.state.canvas.selectionCurrent;
                    const x = Math.min(start.x, current.x);
                    const y = Math.min(start.y, current.y);
                    const w = Math.abs(current.x - start.x);
                    const h = Math.abs(current.y - start.y);
                    const box = document.getElementById('selection-box');
                    box.style.left = x + 'px';
                    box.style.top = y + 'px';
                    box.style.width = w + 'px';
                    box.style.height = h + 'px';
                }
            },
            handleEnd: (e) => {
                // Pinch End Logic
                if (window.state.canvas.isPinching && (!e.touches || e.touches.length < 2)) {
                    window.state.canvas.isPinching = false;
                }

                if (window.state.canvas.isDragging) {
                    window.state.canvas.isDragging = false;
                    const cursor = window.state.canvas.isPanMode ? 'grab' : 'default'; 
                    const w = document.getElementById('canvas-wrapper'); if(w) w.style.cursor = cursor;
                }
                if (window.state.canvas.draggedNodeId) {
                    window.state.canvas.draggedNodeId = null;
                }
                if (window.state.canvas.isSelecting) {
                    const start = window.state.canvas.selectionStart;
                    const current = window.state.canvas.selectionCurrent;
                    const selRect = { left: Math.min(start.x, current.x), top: Math.min(start.y, current.y), right: Math.max(start.x, current.x), bottom: Math.max(start.y, current.y) };
                    
                    // If box is tiny, just hide it and return (treat as click)
                    if (Math.abs(selRect.right - selRect.left) < 5 && Math.abs(selRect.bottom - selRect.top) < 5) {
                            window.state.canvas.isSelecting = false;
                            document.getElementById('selection-box').style.display = 'none';
                            return;
                    }

                    const nodeElements = document.querySelectorAll('.node-card');
                    const newSelectedIds = [];
                    nodeElements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        if (rect.left < selRect.right && rect.right > selRect.left &&
                            rect.top < selRect.bottom && rect.bottom > selRect.top) {
                            const id = el.id.replace('node-', '');
                            newSelectedIds.push(id);
                        }
                    });
                    
                    // Update Selection State
                    newSelectedIds.forEach(id => { if (!window.state.selectedNodeIds.includes(id)) window.state.selectedNodeIds.push(id); });
                    
                    // ğŸ”¥ [CRITICAL FIX] Visual Update Only (Direct DOM Manipulation)
                    // Do NOT call renderCanvas() here as it destroys DOM and event listeners
                    
                    // 1. Remove highlight from all nodes first (if shift not pressed, handled in startDrag/mouseDown logic, but here we just ensure sync)
                    // If we want to keep existing selection on shift click, we need to be careful.
                    // But simpler approach for visual sync:
                    document.querySelectorAll('.node-card.selected-node').forEach(el => {
                        // Check if it is still in selectedNodeIds
                        const id = el.id.replace('node-', '');
                        if(!window.state.selectedNodeIds.includes(id)) {
                             el.classList.remove('selected-node');
                        }
                    });

                    // 2. Add highlight to all currently selected nodes
                    window.state.selectedNodeIds.forEach(id => {
                        const el = document.getElementById(`node-${id}`);
                        if(el) el.classList.add('selected-node');
                    });

                    window.state.canvas.isSelecting = false;
                    document.getElementById('selection-box').style.display = 'none';
                }
            },
            handleWheel: (e) => {
                e.preventDefault();
                const d = -e.deltaY * 0.001;
                window.state.canvas.scale = Math.min(Math.max(0.2, window.state.canvas.scale + d), 3);
                window.app.canvas.applyTransform();
            },
            zoom: (d) => { window.state.canvas.scale = Math.min(Math.max(0.2, window.state.canvas.scale + d), 3); window.app.canvas.applyTransform(); },
            fitView: () => { window.state.canvas.scale = window.innerWidth < 768 ? 0.8 : 1; window.state.canvas.offsetX = 0; window.state.canvas.offsetY = 0; window.app.canvas.applyTransform(); },
            startDrag: (e, id) => {
                window.state.canvas.draggedNodeId = id;
                const c = window.app.canvas.getCoords(e);
                window.state.canvas.lastX = c.x; window.state.canvas.lastY = c.y;
                if (!window.state.selectedNodeIds.includes(id)) {
                    if (!e.shiftKey) window.state.selectedNodeIds = [];
                    window.state.selectedNodeIds.push(id);
                    
                    // ğŸ”¥ [OPTIMIZED FIX] Visual update only - NO RENDER CANVAS
                    document.querySelectorAll('.node-card').forEach(el => el.classList.remove('selected-node'));
                    window.state.selectedNodeIds.forEach(i => {
                         const el = document.getElementById(`node-${i}`);
                         if(el) el.classList.add('selected-node');
                    });
                }
            },
            toggleHeatmap: () => {
                window.state.canvas.isHeatmapMode = !window.state.canvas.isHeatmapMode;
                window.ui.renderCanvas(); 
            },
            toggleCluster: () => {
                const isCluster = !window.state.canvas.isClusterMode;
                window.state.canvas.isClusterMode = isCluster;
                const nodes = window.state.nodes.filter(n => n.topicId === window.state.currentTopicId);
                if (isCluster) {
                    const clusterGroups = { 'A': [], 'B': [], 'C': [], 'Other': [] };
                    nodes.forEach(n => {
                        if (window.CLUSTER_CENTERS[n.cluster]) clusterGroups[n.cluster].push(n);
                        else clusterGroups['Other'].push(n);
                    });
                    const targets = [];
                    const nodeW = 320; 
                    const nodeH = 200; 
                    Object.entries(clusterGroups).forEach(([key, groupNodes]) => {
                        const center = window.CLUSTER_CENTERS[key] || {x: 0, y: 0, width: 1000, height: 1000};
                        const cols = Math.max(1, Math.floor(center.width / nodeW));
                        groupNodes.forEach((n, idx) => {
                            if (n.savedX === undefined) { n.savedX = n.x; n.savedY = n.y; }
                            const col = idx % cols;
                            const row = Math.floor(idx / cols);
                            const startX = center.x - ((cols * nodeW) / 2) + (nodeW / 2);
                            const startY = center.y - (center.height / 2) + 100; 
                            const tx = startX + (col * nodeW);
                            const ty = startY + (row * nodeH);
                            targets.push({ id: n.id, x: tx, y: ty });
                        });
                    });
                    window.app.canvas.animateNodes(targets);
                } else {
                    const targets = nodes.map(n => ({ id: n.id, x: n.savedX !== undefined ? n.savedX : n.x, y: n.savedY !== undefined ? n.savedY : n.y }));
                    window.app.canvas.animateNodes(targets);
                }
                window.ui.renderCanvas();
            },
            animateNodes: (targets) => {
                const startPositions = {};
                const nodes = window.state.nodes.filter(n => n.topicId === window.state.currentTopicId);
                nodes.forEach(n => { startPositions[n.id] = {x: n.x, y: n.y}; });
                const duration = 800; const startTime = performance.now(); window.state.canvas.isAnimating = true;
                const animate = (time) => {
                    const elapsed = time - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
                    targets.forEach(target => {
                        const node = nodes.find(n => n.id === target.id);
                        if (node) {
                            const start = startPositions[target.id];
                            node.x = start.x + (target.x - start.x) * ease;
                            node.y = start.y + (target.y - start.y) * ease;
                            const el = document.getElementById(`node-${node.id}`);
                            if (el) { el.style.left = `${node.x}px`; el.style.top = `${node.y}px`; }
                        }
                    });
                    if (progress < 1) { requestAnimationFrame(animate); } 
                    else { 
                        window.state.canvas.isAnimating = false; 
                        targets.forEach(target => { const node = nodes.find(n => n.id === target.id); if(node) { node.x = target.x; node.y = target.y; } }); 
                        window.ui.drawConnections(nodes); // Redraw lines at end
                    }
                };
                requestAnimationFrame(animate);
            }
        };

        // --- 5. UI Logic (Separated for safety) ---
        window.ui = {};
        window.ui.init = () => {
            console.log("Initializing UI...");
            window.dataManager.load();
            window.app.updateTrashBadge();
            window.app.initCategorySelector();
            window.ui.renderUserInfo();
            window.ui.renderUserMenu();
            if (window.state.currentView === 'canvas' && window.state.currentTopicId && window.state.topics.find(t => t.id === window.state.currentTopicId)) { window.app.router('canvas'); }
            else if (window.state.currentView === 'profile') { window.app.router('profile'); }
            else { window.app.router('entrance'); }
            
            // Global Listeners for Canvas Interaction
            window.addEventListener('mouseup', window.app.canvas.handleEnd);
            window.addEventListener('touchend', window.app.canvas.handleEnd);
            window.addEventListener('resize', () => { if(window.state.currentView === 'canvas') window.ui.renderCanvas(); });
            
            // NEW: Escape key to close modals
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modals = ['modal-topic', 'modal-node', 'modal-detail', 'modal-confirm', 'modal-addUser', 'modal-trash', 'modal-analytics-menu'];
                    modals.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && !el.classList.contains('hidden')) {
                            window.ui.closeModal(id);
                        }
                    });
                }
            });

            window.app.canvas.renderLoop();
            console.log("UI Initialized.");
        };
        
        window.ui.renderUserInfo = () => {
            // ğŸ”¥ [CRITICAL FIX] Added guard to prevent crash on null user
            const u = window.state.user;
            if (!u) return;

            const avatarEl = document.getElementById('user-avatar');
            if(avatarEl) avatarEl.src = u.avatar;
            const nameEl = document.getElementById('user-name');
            if(nameEl) nameEl.innerText = u.name;
            const roleEl = document.getElementById('user-role');
            if(roleEl) roleEl.innerText = u.role === window.ROLES.LEAD ? 'é¦–å¸­' : 'å”åŒ';
        };
        
        window.ui.renderUserMenu = () => { 
            // ğŸ”¥ [CRITICAL FIX] Added guard here too
            if (!window.state.user) return;
            const userList = window.state.userList;
            const menuContent = Object.entries(userList).map(([key, u]) => {
                const isCurrentUser = window.state.user.id === u.id;
                const canDelete = window.state.user.role === window.ROLES.LEAD && !isCurrentUser;
                const deleteBtn = canDelete ? `<button onclick="event.stopPropagation(); window.app.deleteUser('${key}')" class="p-3 text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>` : `<div class="p-3 w-10"></div>`; 
                return `<div class="flex items-center hover:bg-slate-50 border-b border-slate-50 last:border-0 group"><button onclick="window.app.switchUser('${key}')" class="flex-1 text-left px-4 py-3 text-sm flex items-center gap-2 ${isCurrentUser ? 'bg-indigo-50 text-indigo-700' : ''}"><span class="text-xl">${u.role === window.ROLES.LEAD ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ§‘â€ğŸ“'}</span><div class="flex flex-col"><span class="font-medium">${u.name}</span><span class="text-[10px] text-slate-400">${u.role === window.ROLES.LEAD ? 'é¦–å¸­' : 'å”åŒ'}</span></div></button>${deleteBtn}</div>`;
            }).join('');
            let resetOption = window.state.user.role === window.ROLES.LEAD ? `<div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-t mt-1">ç³»çµ±è¨­å®š</div><button onclick="window.dataManager.reset()" class="w-full text-left px-4 py-3 hover:bg-red-50 text-sm flex items-center gap-2 text-red-600 font-medium"><span class="text-xl">âš ï¸</span> é‡ç½®ç³»çµ±è³‡æ–™</button>` : '';
            const menuEl = document.getElementById('user-menu');
            if(menuEl) menuEl.innerHTML = `<div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider">åˆ‡æ›èº«ä»½</div><div class="max-h-60 overflow-y-auto custom-scroll">${menuContent}</div><div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-t mt-1">äººå“¡ç®¡ç†</div><button onclick="window.app.openAddUserModal()" class="w-full text-left px-4 py-3 hover:bg-slate-50 text-sm flex items-center gap-2 text-indigo-600 font-medium"><span class="text-xl">â•</span> æ–°å¢å”åŒç ”ç©¶å“¡</button>${resetOption}`;
        };

        window.ui.renderTrashList = () => { 
            const list = document.getElementById('trash-list');
            if (!list) return;
            if (window.state.trash.length === 0) { list.innerHTML = `<div class="text-center py-10 text-slate-400"><i class="fa-regular fa-trash-can text-4xl mb-3 opacity-50"></i><p>å›æ”¶æ¡¶æ˜¯ç©ºçš„</p></div>`; return; }
            list.innerHTML = window.state.trash.map(item => {
                const isTopic = item.type === 'topic';
                const icon = isTopic ? 'fa-folder' : (window.SCAFFOLDS[item.data[0]?.type]?.icon || 'fa-note-sticky');
                const color = isTopic ? 'text-indigo-500 bg-indigo-100' : 'text-slate-500 bg-slate-100';
                const name = isTopic ? item.data.name : (item.data[0]?.content.substring(0, 30) + '...');
                const date = new Date(item.deletedAt).toLocaleString();
                return `<div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${color} flex items-center justify-center shrink-0"><i class="fa-solid ${icon}"></i></div><div><div class="font-bold text-slate-800 text-sm">${name}</div><div class="text-xs text-slate-400">åˆªé™¤æ–¼: ${date}</div></div></div><div class="flex gap-2"><button onclick="window.app.restoreTrashItem('${item.id}')" class="text-xs bg-green-50 text-green-600 px-3 py-1.5 rounded hover:bg-green-100 transition border border-green-200">é‚„åŸ</button><button onclick="window.app.deleteTrashItem('${item.id}')" class="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded hover:bg-red-100 transition border border-red-200">æ°¸ä¹…åˆªé™¤</button></div></div>`;
            }).join('');
        };
        window.ui.closeModal = (id) => { 
            document.getElementById(id).classList.add('hidden');
            if(id === 'modal-node') {
                document.getElementById('node-title').value = ''; // Clear Title
                document.getElementById('node-content').value = '';
                document.getElementById('ai-suggestion-box').classList.add('hidden');
                window.state.composer.parentId = null;
                window.state.composer.selectedScaffold = null;
            }
            if (id === 'modal-addUser') { document.getElementById('new-user-name').value = ''; }
            if (id === 'modal-topic') { 
                window.state.tempSelectedCategories = []; 
                window.state.editingTopicId = null;
                window.app.renderCategorySelector(); 
                document.getElementById('topic-name').value = ''; 
                document.getElementById('topic-desc').value = ''; 
            }
        };
        window.ui.showToast = (msg, type = 'info') => { 
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-600' : 'bg-slate-800');
            el.className = `${colors} text-white px-4 py-2 rounded-lg shadow-xl text-sm flex items-center gap-2 transform transition-all translate-y-2 opacity-0`;
            el.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.remove('translate-y-2', 'opacity-0'));
            setTimeout(() => { el.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => el.remove(), 300); }, 3000);
        };
        window.ui.confirm = (title, desc, action) => { 
            document.querySelector('#modal-confirm h3').innerText = title;
            document.querySelector('#modal-confirm p').innerText = desc;
            document.getElementById('btn-confirm-action').onclick = action;
            document.getElementById('modal-confirm').classList.remove('hidden');
        };
        window.ui.updateNav = (view) => { 
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                if(btn.dataset.nav === view) {
                    btn.classList.add('active');
                    if(btn.classList.contains('mobile-nav-btn')) btn.classList.add('text-indigo-600');
                } else {
                    btn.classList.remove('active', 'text-indigo-600');
                    if(btn.classList.contains('mobile-nav-btn')) btn.classList.add('text-slate-400');
                }
            });
        };
        window.ui.renderEntrance = () => { 
            const container = document.getElementById('app-container');
            const visibleTopics = window.state.activeFilter === 'å…¨éƒ¨' 
                ? window.state.topics 
                : window.state.topics.filter(t => t.categories && t.categories.includes(window.state.activeFilter));
            
            // Added pb-24 to ensure content clears mobile bottom nav
            container.innerHTML = `<div class="max-w-7xl mx-auto px-4 md:px-6 py-8 h-full overflow-y-auto custom-scroll pb-24"><div class="mb-6 text-center"><h2 class="text-2xl md:text-3xl font-bold text-slate-900">çŸ¥è­˜å»ºæ§‹è«–å£‡ Knowledge Building Forum</h2><p class="text-slate-500 text-sm">"çŸ¥è­˜å»ºæ§‹ä¸æ˜¯è¿½æ±‚ç­”æ¡ˆï¼Œè€Œæ˜¯ä»¥æ”¹å–„æƒ³æ³•ç‚ºå…±åŒä½¿å‘½ï¼Œè®“ç¤¾ç¾¤æ€ç¶­æŒçºŒæœå‘æ›´æ·±åˆ»çš„ç†è§£ã€‚"</p></div><div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div class="w-full md:w-auto category-scroll-container"><div id="category-filters" class="flex gap-2 whitespace-nowrap md:flex-wrap">${window.app.generateCategoryFilters()}</div></div>${window.state.user.role === window.ROLES.LEAD ? `<button onclick="window.app.openCreateTopic()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg shadow text-sm hover:bg-indigo-700 transition flex-shrink-0"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸»é¡Œ</button>` : ''}</div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4">${visibleTopics.length === 0 ? `<div class="col-span-full text-center text-slate-400 py-10">æ­¤åˆ†é¡æš«ç„¡ä¸»é¡Œï¼Œé»æ“Šå³ä¸Šè§’æ–°å¢ä¸€å€‹å§ï¼</div>` : ''}${visibleTopics.map(t => { 
                const count = window.state.nodes.filter(n => n.topicId === t.id).length; 
                const cats = t.categories || [t.category] || ['å…¶ä»–']; 
                const tagsHtml = cats.map(c => `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold mr-1">${window.TOPIC_CATEGORIES[c] || c}</span>`).join(''); 
                const adminControls = window.state.user.role === window.ROLES.LEAD ? `
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); window.app.openEditTopic('${t.id}')" class="text-slate-300 hover:text-indigo-500 transition" title="ç·¨è¼¯ä¸»é¡Œ"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="event.stopPropagation(); window.app.deleteTopic('${t.id}')" class="text-slate-300 hover:text-red-500 transition" title="åˆªé™¤ä¸»é¡Œ"><i class="fa-solid fa-trash"></i></button>
                    </div>` : '';
                return `<div onclick="window.app.enterTopic('${t.id}')" class="bg-white rounded-xl border p-5 cursor-pointer hover:shadow-lg relative overflow-hidden group transition"><div class="flex justify-between mb-3 items-start"><div class="flex flex-wrap gap-1">${tagsHtml}</div>${adminControls}</div><h3 class="font-bold text-lg mb-2 group-hover:text-indigo-600 transition">${t.name}</h3><p class="text-slate-500 text-sm mb-4 line-clamp-2">${t.desc}</p><div class="flex justify-between text-xs text-slate-400 pt-3 border-t"><span><i class="fa-solid fa-user"></i> ${window.state.userList[t.author] ? window.state.userList[t.author].name : 'Unknown'}</span><span>${count} æƒ³æ³•</span></div></div>`; 
            }).join('')}</div></div>`;
            setTimeout(() => { document.querySelectorAll('.filter-btn').forEach(button => { button.addEventListener('click', (e) => { window.app.setFilter(e.currentTarget.dataset.category); }); }); }, 0);
        };
        window.ui.renderCanvas = () => { 
            const topic = window.state.topics.find(t => t.id === window.state.currentTopicId);
            const nodes = window.state.nodes.filter(n => n.topicId === window.state.currentTopicId);
            const container = document.getElementById('app-container');
            
            const isPanMode = window.state.canvas.isPanMode;
            const modeLabel = isPanMode ? 'âœ‹ æ‹–æ›³' : 'â¬š é¸å–';
            const modeClass = isPanMode ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-white text-slate-600 border border-slate-200';
            const modeIcon = isPanMode ? '<i class="fa-solid fa-hand"></i>' : '<i class="fa-regular fa-square"></i>';

            container.innerHTML = `
            <div class="absolute top-2 left-2 right-2 md:top-4 md:left-4 md:right-4 z-40 flex justify-between pointer-events-none">
                <div class="bg-white/90 backdrop-blur shadow-sm border rounded-lg p-2 pointer-events-auto flex items-center gap-2 max-w-[40%] md:max-w-[50%]">
                    <button onclick="window.app.router('entrance')" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <h2 class="font-bold text-xs md:text-sm truncate px-1">${topic.name}</h2>
                </div>
                <div class="flex gap-2 pointer-events-auto">
                    <button onclick="window.app.canvas.toggleHeatmap()" id="btn-heatmap" class="${window.state.canvas.isHeatmapMode ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-white/90 text-slate-500 border-slate-200'} backdrop-blur shadow-sm border rounded-lg px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all hover:scale-105"><i class="fa-solid fa-fire ${window.state.canvas.isHeatmapMode ? 'animate-pulse' : ''}"></i> <span class="text-[10px] md:text-xs">æ½›åŠ›ç†±é»</span></button>
                    <button onclick="window.app.canvas.toggleCluster()" id="btn-cluster" class="${window.state.canvas.isClusterMode ? 'bg-purple-100 text-purple-600 border-purple-200' : 'bg-white/90 text-slate-500 border-slate-200'} backdrop-blur shadow-sm border rounded-lg px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all hover:scale-105"><i class="fa-solid fa-sparkles ${window.state.canvas.isClusterMode ? 'text-purple-500' : ''}"></i> <span class="text-[10px] md:text-xs">èªæ„èšé¡</span></button>
                    <div class="bg-white/90 backdrop-blur shadow-sm border rounded-lg p-1 flex">
                        <button onclick="window.app.canvas.fitView()" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100"><i class="fa-solid fa-expand"></i></button>
                        <button onclick="window.app.canvas.zoom(0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 hidden md:flex"><i class="fa-solid fa-plus"></i></button>
                        <button onclick="window.app.canvas.zoom(-0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 hidden md:flex"><i class="fa-solid fa-minus"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-20 md:bottom-6 left-1/2 transform -translate-x-1/2 z-40 pointer-events-auto transition-all duration-300">
                <button onclick="window.app.canvas.toggleMode()" class="${modeClass} pointer-events-auto cursor-pointer px-4 py-2 rounded-full shadow-md flex items-center gap-2 text-sm font-bold transition-all duration-300 hover:scale-105 active:scale-95">
                    ${modeIcon} <span>${modeLabel}</span>
                </button>
            </div>

            <div class="absolute bottom-20 right-4 md:bottom-8 md:right-8 z-40"> 
                <button onclick="window.app.openComposer(null)" class="bg-indigo-600 text-white rounded-full w-12 h-12 md:w-14 md:h-14 shadow-xl flex items-center justify-center text-xl transition transform hover:scale-105"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div class="hidden md:block absolute bottom-24 left-4 md:bottom-8 md:left-24 z-30 pointer-events-none">
                <div class="bg-white/80 backdrop-blur-sm border border-slate-200 p-3 rounded-lg shadow-sm text-xs text-slate-600 pointer-events-auto space-y-1">
                    <h4 class="font-bold text-slate-700 mb-1 flex items-center gap-1"><i class="fa-solid fa-circle-question text-indigo-500"></i> æ“ä½œæŒ‡å—</h4>
                    <div class="flex items-center justify-between gap-3"><span class="bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded text-[10px] font-mono text-slate-500">å·¦éµæ‹–æ›³</span> <span>æ¡†é¸ç¯„åœ</span></div>
                    <div class="flex items-center justify-between gap-3"><span class="bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded text-[10px] font-mono text-slate-500">Ctrl + æ‹–æ›³</span> <span>ç§»å‹•ç•«å¸ƒ</span></div>
                    <div class="flex items-center justify-between gap-3"><span class="bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded text-[10px] font-mono text-slate-500">é›™æ“Šç©ºç™½</span> <span>åˆ‡æ› æ‹–æ›³/é¸å–</span></div>
                    <div class="flex items-center justify-between gap-3"><span class="bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded text-[10px] font-mono text-slate-500">æ»¾è¼ª</span> <span>ç¸®æ”¾è¦–è§’</span></div>
                </div>
            </div>

            <div id="canvas-wrapper" class="w-full h-full overflow-hidden relative touch-none noselect" 
                 style="cursor: ${isPanMode ? 'grab' : 'default'}"
                 ondblclick="window.app.canvas.handleDoubleClick(event)"
                 onmousedown="window.app.canvas.startPan(event)" 
                 ontouchstart="window.app.canvas.startPan(event)" 
                 onmousemove="window.app.canvas.pan(event)" 
                 ontouchmove="window.app.canvas.pan(event)" 
                 onwheel="window.app.canvas.handleWheel(event)">
                <div id="canvas-bg"></div>
                <div id="canvas-content" class="absolute top-0 left-0 w-full h-full origin-top-left will-change-transform">
                    <div id="cluster-labels-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0 transition-opacity duration-500 opacity-0"></div>
                    <svg id="connections-layer" class="absolute top-0 left-0 w-[5000px] h-[5000px] pointer-events-none overflow-visible z-0"></svg>
                    <div id="nodes-layer" class="z-10"></div>
                </div>
            </div>`;
            
            if (window.state.canvas.isClusterMode) {
                const labelLayer = document.getElementById('cluster-labels-layer');
                if (labelLayer) {
                    labelLayer.innerHTML = Object.values(window.CLUSTER_CENTERS).map(c => `<div class="cluster-zone" style="left: ${c.x - c.width/2}px; top: ${c.y - c.height/2}px; width: ${c.width}px; height: ${c.height}px;"><div class="cluster-title">${c.title}</div></div>`).join('');
                    labelLayer.classList.remove('opacity-0');
                    labelLayer.style.opacity = '1';
                }
            }

            window.ui.drawNodes(nodes);
            setTimeout(() => window.ui.drawConnections(nodes), 0);
            window.app.canvas.applyTransform();
        };
        window.ui.renderProfile = () => {
            const container = document.getElementById('app-container');
            const u = window.state.user;
            // Added pb-24 for mobile nav clearance
            container.innerHTML = `<div class="max-w-2xl mx-auto px-6 py-8 h-full overflow-y-auto custom-scroll pb-24"><div class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-6 shadow-sm border border-indigo-100 text-center mb-6 relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-purple-500 to-indigo-500"></div><img src="${u.avatar}" class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-white shadow-md"><h2 class="text-2xl font-bold text-slate-800">${u.name}</h2><p class="text-slate-500 text-sm mb-1">${u.role === window.ROLES.LEAD ? 'é¦–å¸­ç ”ç©¶å“¡' : 'å”åŒç ”ç©¶å“¡'}</p><div class="flex justify-center gap-2 mt-4"><span class="bg-white/80 border px-3 py-1 rounded-full text-xs font-bold text-slate-600 shadow-sm">ID: ${u.id}</span></div></div><div class="space-y-6"><div class="flex items-center justify-between"><h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-robot text-indigo-600"></i> æˆ‘çš„çŸ¥è­˜å»ºæ§‹æª”æ¡ˆ (KB Profile)</h3><button onclick="window.app.generateAIProfile()" id="btn-gen-profile" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 transition flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> <span>ç”Ÿæˆåˆ†æ</span></button></div><div id="ai-loading" class="hidden p-8 text-center bg-white rounded-2xl border border-slate-100"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-2"></div><p class="text-sm text-slate-500 animate-pulse">æ­£åœ¨å›é¡§ä½ çš„çŸ¥è­˜æ¼”åŒ–è»Œè·¡...</p></div><div id="ai-profile-result" class="hidden space-y-4"></div></div></div>`;
            if (window.state.profile && document.getElementById('ai-profile-result')) { window.ui.renderProfileContent(window.state.profile); }
        };
        window.ui.renderProfileContent = (data) => {
            const result = document.getElementById('ai-profile-result');
            result.innerHTML = `<div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-indigo-500 relative overflow-hidden"><div class="absolute right-0 top-0 opacity-5 transform translate-x-4 -translate-y-4"><i class="fa-solid ${data.icon} text-9xl text-indigo-900"></i></div><h4 class="text-sm font-bold text-indigo-500 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="fa-solid fa-fire"></i> ä½¿ç”¨è€…çŸ¥è­˜è§’è‰²</h4><div class="relative z-10"><p class="text-xl font-bold text-slate-800 mb-2">${data.role}</p><p class="text-sm text-slate-600 leading-relaxed">${data.desc}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500" style="animation-delay: 0.1s"><h4 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-seedling"></i> æƒ³æ³•æ¼”åŒ–è»Œè·¡</h4><div class="pl-2">${data.trajectoryHTML}</div></div><div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500" style="animation-delay: 0.2s"><h4 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-puzzle-piece"></i> ç¤¾ç¾¤æ¨å‹•åŠ›</h4>${data.communityHTML}</div></div><div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500" style="animation-delay: 0.3s"><h4 class="text-sm font-bold text-purple-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-pie"></i> çŸ¥è­˜å»ºæ§‹ç­–ç•¥åˆ†ä½ˆ</h4><p class="text-xs text-slate-500 mb-4">é€™é¡¯ç¤ºäº†ä½ åœ¨çŸ¥è­˜å»ºæ§‹éç¨‹ä¸­æ‰€ä½¿ç”¨çš„èªçŸ¥ç­–ç•¥å¤šæ¨£æ€§ (Idea Diversity)ï¼š</p><div class="grid grid-cols-1 gap-2">${data.statsHTML}</div></div>`;
            result.classList.remove('hidden');
        };
        window.ui.drawNodes = (nodes) => {
            document.getElementById('nodes-layer').innerHTML = nodes.map(node => {
                const s = window.SCAFFOLDS[node.type];
                const user = Object.values(window.state.userList).find(u => u.id === node.author) || {name: '?'};
                const canDel = window.state.user.role === window.ROLES.LEAD || node.author === window.state.user.id;
                const isPromising = window.state.canvas.isHeatmapMode && node.promisingness > 70;
                const heatmapClass = isPromising ? 'promising-node' : '';
                const flameBadge = isPromising ? `<div class="absolute -top-3 -right-2 bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm animate-bounce-slow z-50"><i class="fa-solid fa-fire"></i> ç†±é»</div>` : '';
                const isSelected = window.state.selectedNodeIds.includes(node.id) ? 'selected-node' : '';
                return `<div id="node-${node.id}" class="absolute node-card w-64 md:w-72 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-visible ${heatmapClass} ${isSelected}" style="left: ${node.x}px; top: ${node.y}px;" onmousedown="event.stopPropagation(); window.app.canvas.startDrag(event, '${node.id}')" ontouchstart="event.stopPropagation(); window.app.canvas.startDrag(event, '${node.id}')" ondblclick="event.stopPropagation(); window.app.openNodeDetail('${node.id}')">${flameBadge}<div class="px-3 py-2 ${s.bgSoft} border-b ${s.border} flex justify-between items-center cursor-move rounded-t-xl"><div class="flex items-center gap-2"><span class="w-5 h-5 rounded-full ${s.color} text-white flex justify-center items-center text-xs"><i class="fa-solid ${s.icon}"></i></span><span class="text-xs font-bold ${s.text}">${s.label}</span></div><div class="flex gap-1"><button onclick="event.stopPropagation(); window.app.openNodeDetail('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 flex justify-center items-center"><i class="fa-solid fa-eye"></i></button><button onclick="event.stopPropagation(); window.app.openComposer('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 flex justify-center items-center"><i class="fa-solid fa-reply"></i></button>${canDel ? `<button onclick="event.stopPropagation(); window.app.deleteNode('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 hover:text-red-500 flex justify-center items-center"><i class="fa-solid fa-xmark"></i></button>` : ''}</div></div><div class="p-3 text-sm text-slate-700 leading-relaxed min-h-[60px] pointer-events-none bg-white"><h4 class="font-bold mb-1 text-slate-900 block truncate text-base">${node.title || 'ç„¡æ¨™é¡Œ'}</h4><p class="line-clamp-2 text-slate-600">${node.content}</p></div><div class="px-3 py-2 bg-slate-50 border-t flex justify-between text-[10px] text-slate-500 items-center rounded-b-xl"><div class="flex items-center gap-2"><img src="${user.avatar}" class="w-4 h-4 rounded-full"><span>${user.name}</span></div><span>${new Date(node.date).toLocaleDateString()}</span></div></div>`;
            }).join('');
        };
        window.ui.drawConnections = (nodes) => { 
            const layer = document.getElementById('connections-layer');
            if(!layer) return;
            layer.innerHTML = `<defs>${Object.keys(window.SCAFFOLDS).map(k => { const c = { question: '#3b82f6', extend: '#eab308', improve: '#22c55e', counter: '#ef4444', riseabove: '#a855f7' }[k]; return `<marker id="arrow-${k}" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="${c}" /></marker>`; }).join('')}</defs>`;
            const cardWidth = window.innerWidth < 768 ? 256 : 288;
            const halfW = cardWidth / 2;
            const paths = nodes.filter(n => n.parentId).map(node => {
                const parent = window.state.nodes.find(p => p.id === node.parentId);
                if (!parent) return '';
                const startX = parent.x + halfW; const startY = parent.y + 140; const endX = node.x + halfW; const endY = node.y;
                const dist = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                let curveFactor = 0.4; if (endY < startY) curveFactor = 0.6; 
                const cp1x = startX; const cp1y = startY + dist * curveFactor; const cp2x = endX; const cp2y = endY - dist * curveFactor;
                const colorMap = { question: '#3b82f6', extend: '#eab308', improve: '#22c55e', counter: '#ef4444', riseabove: '#a855f7' };
                return `<path d="M ${startX} ${startY} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${endX} ${endY}" stroke="${colorMap[node.type]}" fill="none" stroke-width="2" stroke-opacity="0.6" marker-end="url(#arrow-${node.type})" />`;
            }).join('');
            layer.innerHTML += paths;
        };

        window.addEventListener('DOMContentLoaded', () => {
            if (window.ui && typeof window.ui.init === 'function') {
                window.ui.init();
            } else {
                console.error("UI Init failed");
            }
        });
    </script>
</body>
</html>
