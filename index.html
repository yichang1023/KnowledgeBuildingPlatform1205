<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ¥è­˜å»ºæ§‹å”ä½œå¹³å° (KB Platform) - v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        kb: {
                            blue: '#3b82f6', // Question
                            yellow: '#eab308', // Extend
                            green: '#22c55e', // Improve
                            red: '#ef4444', // Counter
                            purple: '#a855f7', // Rise Above
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* æ ¸å¿ƒå„ªåŒ– */
        body { overflow: hidden; overscroll-behavior: none; }
        
        #canvas-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: -1;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .node-card {
            transition: box-shadow 0.2s; 
            user-select: none; touch-action: none; -webkit-user-select: none;
        }
        .node-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }
        
        path.connection { fill: none; stroke-width: 2; transition: stroke 0.3s; pointer-events: none; }
        
        @keyframes pulse-gentle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .ai-pulse { animation: pulse-gentle 2s infinite; }
        
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in-up 0.5s ease-out forwards; }

        .horizontal-scroll { -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }

        .nav-btn.active { color: #4f46e5; background-color: #e0e7ff; }
        .mobile-nav-btn.active { color: #4f46e5; }

        .filter-btn {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            border-color: rgb(226, 232, 240);
        }
        .filter-btn.active {
            background-color: rgb(238, 242, 255);
            color: rgb(79, 70, 229);
            border-color: rgb(165, 180, 252);
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Ensure canvas wrapper handles touch correctly */
        #canvas-wrapper {
            touch-action: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col font-sans">

    <!-- Top Navbar -->
    <nav class="h-14 md:h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 z-50 shadow-sm relative shrink-0">
        <div class="flex items-center gap-3 cursor-pointer" onclick="app.router('entrance')">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg md:text-xl shrink-0">KB</div>
            <div>
                <h1 class="font-bold text-base md:text-lg leading-tight text-slate-800 truncate max-w-[150px] md:max-w-none">çŸ¥è­˜å»ºæ§‹å¹³å°</h1>
                <p class="text-[10px] md:text-xs text-slate-500 hidden md:block">Knowledge Building Environment (v1.0)</p>
            </div>
        </div>
        
        <div class="hidden md:flex items-center bg-slate-100 p-1 rounded-lg">
            <button onclick="app.router('entrance')" data-nav="entrance" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition">ä¸»é¡Œå…¥å£</button>
            <button onclick="app.router('canvas')" data-nav="canvas" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition">çŸ¥è­˜åœ°åœ–</button>
            <button onclick="app.router('profile')" data-nav="profile" class="nav-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 transition">æˆ‘çš„æª”æ¡ˆ</button>
        </div>

        <div class="flex items-center gap-2 md:gap-4">
            <div id="ai-persona-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs font-medium border border-indigo-100">
                <i class="fa-solid fa-robot ai-pulse"></i>
                <span id="active-ai-role">AI å”ä½œä¸­</span>
            </div>
            
            <div class="h-6 w-px bg-slate-200 mx-1 md:mx-2 hidden md:block"></div>
            
            <div class="flex items-center gap-2 group relative">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-slate-200 object-cover border border-slate-300 shrink-0">
                <div class="text-right hidden sm:block">
                    <div id="user-name" class="text-sm font-semibold">User</div>
                    <div id="user-role" class="text-xs text-slate-500">Role</div>
                </div>
                <button onclick="app.toggleUserMenu()" class="ml-1 md:ml-2 text-slate-400 hover:text-indigo-600 p-1"><i class="fa-solid fa-chevron-down"></i></button>
                
                <div id="user-menu" class="absolute top-full right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-slate-100 hidden overflow-hidden z-[100]">
                    <!-- Menu Content injected by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 relative overflow-hidden bg-slate-50 w-full mb-14 md:mb-0">
        <!-- Views injected here -->
    </main>

    <!-- Desktop Footer -->
    <footer class="hidden md:flex bg-white border-t border-slate-200 px-4 py-2 text-center z-40 text-[10px] md:text-xs text-slate-500 justify-center items-center gap-2 shrink-0 safe-area-bottom">
        <i class="fa-solid fa-seedling text-green-500"></i>
        <span class="truncate">çŸ¥è­˜å»ºæ§‹ï¼šåœ¨æœªå®Œæˆçš„ç†è§£ä¸­å½¼æ­¤æ‰¿æ“”è²¬ä»»ï¼Œä½¿æƒ³æ³•åœ¨ç¤¾ç¾¤è£¡ä¸æ–·å‘æ›´å¥½çš„è§£é‡‹æ¼”åŒ–ã€‚</span>
    </footer>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-14 bg-white border-t border-slate-200 flex justify-around items-center z-50 pb-safe">
        <button onclick="app.router('entrance')" data-nav="entrance" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-indigo-600">
            <i class="fa-solid fa-house text-lg mb-0.5"></i> <span class="text-[10px]">ä¸»é¡Œ</span>
        </button>
        <button onclick="app.router('canvas')" data-nav="canvas" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-indigo-600">
            <i class="fa-solid fa-project-diagram text-lg mb-0.5"></i> <span class="text-[10px]">åœ°åœ–</span>
        </button>
        <button onclick="app.router('profile')" data-nav="profile" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-indigo-600">
            <i class="fa-solid fa-user text-lg mb-0.5"></i> <span class="text-[10px]">æª”æ¡ˆ</span>
        </button>
    </div>

    <!-- Modals -->
    <!-- 1. Topic Modal -->
    <div id="modal-topic" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-end md:items-center justify-center p-4">
        <div class="bg-white rounded-t-xl md:rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-plus text-indigo-600"></i> é–‹å•Ÿæ¢ç©¶ä¸»é¡Œ</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">æ ¸å¿ƒå•é¡Œ</label><input type="text" id="topic-name" placeholder="ä¾‹å¦‚ï¼šç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">é¡åˆ¥</label>
                    <select id="topic-category" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none bg-white">
                        <!-- Options generated by JS in ui.init() -->
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">èƒŒæ™¯èªªæ˜</label><textarea id="topic-desc" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="ui.closeModal('modal-topic')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="app.createTopic()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <!-- 2. Node Composer -->
    <div id="modal-node" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-end md:items-center justify-center sm:p-4">
        <div class="bg-white rounded-t-xl sm:rounded-xl shadow-2xl w-full max-w-2xl p-4 sm:p-6 relative max-h-[95vh] overflow-y-auto">
            <button onclick="ui.closeModal('modal-node')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-lg md:text-xl font-bold mb-2">è²¢ç»æƒ³æ³•</h3>
            <div class="grid grid-cols-3 md:grid-cols-5 gap-2 mb-6"><div id="scaffold-selector" class="contents"></div></div>
            <div class="relative">
                <textarea id="node-content" rows="4" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none text-base" placeholder="è¼¸å…¥æƒ³æ³•..."></textarea>
                <div id="ai-suggestion-box" class="hidden mt-2 md:absolute md:-bottom-16 md:left-0 md:right-0 bg-blue-50 border border-blue-100 text-blue-800 p-3 rounded-lg text-sm flex items-start gap-3 shadow-sm"><i class="fa-solid fa-lightbulb text-yellow-500 mt-1 shrink-0"></i><div><span class="font-bold block text-xs uppercase text-blue-400 mb-1">AI å»ºè­°</span><p class="text-xs md:text-sm">è©¦è‘—ç”¨ã€Œæˆ‘çš„ç†è«–æ˜¯...å› ç‚º...ã€ä¾†å»¶ä¼¸ï¼Ÿ</p></div></div>
            </div>
            <div class="mt-4 md:mt-16 flex justify-end"><button onclick="app.submitNode()" class="px-6 py-3 md:py-2 bg-slate-900 text-white rounded-lg">ç™¼å¸ƒ</button></div>
        </div>
    </div>

    <!-- 3. Detail View -->
    <div id="modal-detail" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[65] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between shrink-0 bg-slate-50 rounded-t-xl">
                <div class="flex items-center gap-3"><div id="detail-scaffold-icon" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg"></div><div><div id="detail-scaffold-label" class="text-xs font-bold uppercase mb-0.5">TYPE</div><div class="flex gap-2 text-xs text-slate-500"><span id="detail-author"></span><span>â€¢</span><span id="detail-date"></span></div></div></div>
                <button onclick="ui.closeModal('modal-detail')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-1"><p id="detail-content" class="text-base md:text-lg leading-relaxed whitespace-pre-wrap"></p></div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-3 shrink-0">
                <button id="btn-detail-reply" class="px-5 py-2 bg-indigo-600 text-white rounded-lg flex items-center gap-2"><i class="fa-solid fa-reply"></i> å»¶ä¼¸</button>
            </div>
        </div>
    </div>

    <!-- 4. Confirm Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl text-center">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="text-lg font-bold mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-slate-500 text-sm mb-6">å°‡é€£åŒå­ç¯€é»ä¸€ä½µåˆªé™¤ã€‚</p>
            <div class="flex justify-center gap-3"><button onclick="ui.closeModal('modal-confirm')" class="px-4 py-2 border rounded-lg">å–æ¶ˆ</button><button id="btn-confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg">åˆªé™¤</button></div>
        </div>
    </div>

    <!-- 5. Add User Modal -->
    <div id="modal-addUser" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-user-plus text-indigo-600"></i> æ–°å¢ä½¿ç”¨è€…
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æš±ç¨± (Nickname)</label>
                    <input type="text" id="new-user-name" placeholder="ä¾‹å¦‚ï¼šå°æ˜" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">è§’è‰²</label>
                    <select id="new-user-role" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none bg-white">
                        <option value="student">å”åŒç ”ç©¶å“¡ (å­¸ç”Ÿ)</option>
                        <option value="teacher">é¦–å¸­ç ”ç©¶å“¡ (è€å¸«)</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="ui.closeModal('modal-addUser')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="app.createNewUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm">æ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-20 md:bottom-10 right-4 md:right-6 z-[80] flex flex-col gap-2 pointer-events-none w-full max-w-[300px] md:w-auto items-end"></div>

    <script>
        // --- DATA & CONFIG ---
        const ROLES = { LEAD: 'teacher', CO: 'student' };
        const SCAFFOLDS = {
            question: { id: 'question', label: 'æå•', icon: 'fa-circle-question', color: 'bg-blue-500', border: 'border-blue-500', bgSoft: 'bg-blue-50', text: 'text-blue-700' },
            extend: { id: 'extend', label: 'å»¶ä¼¸', icon: 'fa-plus', color: 'bg-yellow-500', border: 'border-yellow-500', bgSoft: 'bg-yellow-50', text: 'text-yellow-700' },
            improve: { id: 'improve', label: 'æ”¹é€²', icon: 'fa-bolt', color: 'bg-green-500', border: 'border-green-500', bgSoft: 'bg-green-50', text: 'text-green-700' },
            counter: { id: 'counter', label: 'åä¾‹', icon: 'fa-triangle-exclamation', color: 'bg-red-500', border: 'border-red-500', bgSoft: 'bg-red-50', text: 'text-red-700' },
            riseabove: { id: 'riseabove', label: 'æ˜‡è¯', icon: 'fa-rocket', color: 'bg-purple-500', border: 'border-purple-500', bgSoft: 'bg-purple-50', text: 'text-purple-700' }
        };
        
        const TOPIC_CATEGORIES = {
            'ç§‘å­¸': 'ğŸ”¬ ç§‘å­¸',
            'STEAM': 'ğŸ’¡ STEAM',
            'å°ˆé¡Œèª²': 'ğŸ“ å°ˆé¡Œèª²',
            'é›»æ©Ÿé›»å­': 'ğŸ“¡ é›»æ©Ÿé›»å­',
            'AI': 'ğŸ¤– AI',
            'èªè¨€å­¸ç¿’': 'ğŸ“™ èªè¨€å­¸ç¿’',
            'æ–‡å­¸': 'ğŸ“– æ–‡å­¸',
            'ç¤¾æœƒè­°é¡Œ': 'â˜ï¸ ç¤¾æœƒè­°é¡Œ',
            'å…¶ä»–': 'ğŸ“¦ å…¶ä»–'
        };

        const INITIAL_USERS = {
            teacher: { id: 'u1', name: 'ç‹æ•™æˆ', role: ROLES.LEAD, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=Felix' },
            student1: { id: 'u2', name: 'å°ç¾', role: ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S1' },
            student2: { id: 'u3', name: 'å¤§è¯', role: ROLES.CO, avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S2' }
        };

        let state = {
            user: INITIAL_USERS.teacher,
            userList: { ...INITIAL_USERS },
            topics: [
                { id: 't1', name: 'ç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ', category: TOPIC_CATEGORIES.ç§‘å­¸, desc: 'æ¢è¨å…‰ç·šæ•£å°„ã€‚', author: 'u1', date: '2023-10-01' },
                { id: 't2', name: 'AI æ˜¯å¦å…·æœ‰å‰µé€ åŠ›ï¼Ÿ', category: TOPIC_CATEGORIES.AI, desc: 'å®šç¾©å‰µé€ åŠ›ã€‚', author: 'u1', date: '2023-10-05' }
            ],
            nodes: [
                { id: 'n1', topicId: 't1', type: 'question', content: 'æˆ‘å¥½å¥‡ç‚ºä»€éº¼åªæœ‰æ™´å¤©æ˜¯è—è‰²ï¼Œå¤•é™½å»æ˜¯ç´…è‰²ï¼Ÿå¦‚æœèªªæ˜¯å› ç‚ºå¤§æ°£å±¤çš„åšåº¦ä¸åŒï¼Œé‚£ç‚ºä»€éº¼ä¸­åˆçš„æ™‚å€™ä¸æ˜¯ç™½è‰²çš„å‘¢ï¼Ÿ', author: 'u2', x: 100, y: 300, parentId: null, date: Date.now() },
                { id: 'n2', topicId: 't1', type: 'improve', content: 'é€™æ‡‰è©²è·Ÿå…‰ç·šç©¿éå¤§æ°£å±¤çš„è·é›¢æœ‰é—œã€‚å¤•é™½æ™‚é™½å…‰æ–œå°„ï¼Œç©¿éçš„å¤§æ°£å±¤æ¯”è¼ƒåšã€‚', author: 'u3', x: 400, y: 200, parentId: 'n1', date: Date.now() },
                { id: 'n3', topicId: 't1', type: 'extend', content: 'æˆ‘çš„ç†è«–æ˜¯ç‘åˆ©æ•£å°„ (Rayleigh scattering) é€ æˆè—å…‰æ•£å°„è¼ƒå¤šã€‚è—å…‰çš„æ³¢é•·æ¯”è¼ƒçŸ­ï¼Œå®¹æ˜“è¢«æ°£é«”åˆ†å­æ•£å°„åˆ°å››é¢å…«æ–¹ã€‚', author: 'u1', x: 400, y: 400, parentId: 'n1', date: Date.now() },
                { id: 'n4', topicId: 't1', type: 'counter', content: 'ä½†ç‘åˆ©æ•£å°„ä¸èƒ½è§£é‡‹ç‚ºä»€éº¼é™°å¤©ä¹Ÿæ˜¯ç™½è‰²çš„ã€‚å¦‚æœåªæ˜¯åˆ†å­æ•£å°„ï¼Œé™°å¤©æ™‚æ•£å°„é«”æ›´å¤šä¸æ˜¯æ‡‰è©²æ›´è—å—ï¼Ÿ', author: 'u2', x: 800, y: 300, parentId: 'n3', date: Date.now() },
                { id: 'n6', topicId: 't2', type: 'question', content: 'æˆ‘è¦ºå¾—AIç„¡æ³•çµ¦æˆ‘æº«åº¦ï¼Œå¦‚æœAIåªèƒ½æ¨¡æ“¬ï¼Œé‚£äººé¡æƒ…æ„Ÿçš„ç¨ç‰¹æ€§åœ¨å“ªè£¡ï¼Ÿ', author: 'u2', x: 200, y: 300, parentId: 'n5', date: Date.now() + 1000 },
                { id: 'n5', topicId: 't2', type: 'riseabove', content: 'å‰µé€ åŠ›ä¸æ˜¯å–®ç´”çš„æ¨¡ä»¿ã€‚AIçš„å‰µé€ åŠ›ï¼Œæ‡‰è©²è¢«å®šç¾©ç‚ºåœ¨çµ¦å®šç´„æŸæ¢ä»¶ä¸‹çš„æ½›åœ¨è§£ç©ºé–“æ¢ç´¢ã€‚', author: 'u3', x: 100, y: 100, parentId: null, date: Date.now() },
            ],
            currentView: 'entrance',
            currentTopicId: null,
            canvas: { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0, draggedNodeId: null },
            composer: { parentId: null, selectedScaffold: null },
            profile: null
        };
        
        // --- UI & LOGIC ---
        const ui = {
            init: () => {
                const categorySelect = document.getElementById('topic-category');
                if (categorySelect) categorySelect.innerHTML = app.generateCategoryOptions();

                ui.renderUserInfo();
                ui.renderUserMenu();
                app.router('entrance');
                window.addEventListener('mouseup', app.canvas.handleEnd);
                window.addEventListener('touchend', app.canvas.handleEnd);
                window.addEventListener('resize', () => { if(state.currentView === 'canvas') ui.renderCanvas(); });
                document.getElementById('node-content').addEventListener('input', app.checkAIIntervention);
                app.canvas.renderLoop();
            },

            renderUserInfo: () => {
                const u = state.user;
                document.getElementById('user-avatar').src = u.avatar;
                document.getElementById('user-name').innerText = u.name;
                document.getElementById('user-role').innerText = u.role === ROLES.LEAD ? 'é¦–å¸­' : 'å”åŒ';
            },

            renderUserMenu: () => {
                const userList = state.userList;
                const menuContent = Object.entries(userList).map(([key, u]) => {
                    const isCurrentUser = state.user.id === u.id;
                    const deleteBtn = !isCurrentUser
                        ? `<button onclick="event.stopPropagation(); app.deleteUser('${key}')" class="p-3 text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>`
                        : `<div class="p-3 w-10"></div>`; 

                    return `
                    <div class="flex items-center hover:bg-slate-50 border-b border-slate-50 last:border-0 group">
                        <button onclick="app.switchUser('${key}')" class="flex-1 text-left px-4 py-3 text-sm flex items-center gap-2 ${isCurrentUser ? 'bg-indigo-50 text-indigo-700' : ''}">
                            <span class="text-xl">${u.role === ROLES.LEAD ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ§‘â€ğŸ“'}</span>
                            <div class="flex flex-col">
                                <span class="font-medium">${u.name}</span>
                                <span class="text-[10px] text-slate-400">${u.role === ROLES.LEAD ? 'é¦–å¸­' : 'å”åŒ'}</span>
                            </div>
                        </button>
                        ${deleteBtn}
                    </div>
                    `;
                }).join('');

                document.getElementById('user-menu').innerHTML = `
                    <div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider">åˆ‡æ›èº«ä»½</div>
                    <div class="max-h-60 overflow-y-auto custom-scroll">
                        ${menuContent}
                    </div>
                    <div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-t mt-1">ç®¡ç†</div>
                    <button onclick="app.openAddUserModal()" class="w-full text-left px-4 py-3 hover:bg-slate-50 text-sm flex items-center gap-2 text-indigo-600 font-medium">
                        <span class="text-xl">â•</span> æ–°å¢å”åŒç ”ç©¶å“¡
                    </button>
                `;
            },

            closeModal: (id) => {
                document.getElementById(id).classList.add('hidden');
                if(id === 'modal-node') {
                    document.getElementById('node-content').value = '';
                    document.getElementById('ai-suggestion-box').classList.add('hidden');
                    state.composer.parentId = null;
                    state.composer.selectedScaffold = null;
                }
                if (id === 'modal-addUser') {
                    document.getElementById('new-user-name').value = '';
                }
            },

            showToast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-600' : 'bg-slate-800');
                el.className = `${colors} text-white px-4 py-2 rounded-lg shadow-xl text-sm flex items-center gap-2 transform transition-all translate-y-2 opacity-0`;
                el.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> ${msg}`;
                container.appendChild(el);
                requestAnimationFrame(() => el.classList.remove('translate-y-2', 'opacity-0'));
                setTimeout(() => { el.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => el.remove(), 300); }, 3000);
            },

            // Helper for confirmations
            confirm: (title, desc, action) => {
                document.querySelector('#modal-confirm h3').innerText = title;
                document.querySelector('#modal-confirm p').innerText = desc;
                document.getElementById('btn-confirm-action').onclick = action;
                document.getElementById('modal-confirm').classList.remove('hidden');
            },

            updateNav: (view) => {
                document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                    if(btn.dataset.nav === view) {
                        btn.classList.add('active');
                        if(btn.classList.contains('mobile-nav-btn')) btn.classList.add('text-indigo-600');
                    } else {
                        btn.classList.remove('active', 'text-indigo-600');
                        if(btn.classList.contains('mobile-nav-btn')) btn.classList.add('text-slate-400');
                    }
                });
            },

            renderEntrance: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 md:px-6 py-8 h-full overflow-y-auto custom-scroll">
                        <div class="mb-6 text-center">
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">çŸ¥è­˜å»ºæ§‹è«–å£‡ Knowledge Building Forum</h2>
                            <p class="text-slate-500 text-sm">"çŸ¥è­˜å»ºæ§‹ä¸æ˜¯è¿½æ±‚ç­”æ¡ˆï¼Œè€Œæ˜¯ä»¥æ”¹å–„æƒ³æ³•ç‚ºå…±åŒä½¿å‘½ï¼Œè®“ç¤¾ç¾¤æ€ç¶­æŒçºŒæœå‘æ›´æ·±åˆ»çš„ç†è§£ã€‚"</p>
                        </div>
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div class="overflow-x-auto horizontal-scroll w-full md:w-auto"><div id="category-filters" class="flex gap-2 whitespace-nowrap">
                                ${app.generateCategoryFilters()}
                            </div></div>
                            ${state.user.role === ROLES.LEAD ? `<button onclick="document.getElementById('modal-topic').classList.remove('hidden')" class="bg-indigo-600 text-white px-5 py-2 rounded-lg shadow text-sm"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸»é¡Œ</button>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                            ${state.topics.map(t => {
                                const count = state.nodes.filter(n => n.topicId === t.id).length;
                                return `<div onclick="app.enterTopic('${t.id}')" class="bg-white rounded-xl border p-5 cursor-pointer hover:shadow-lg relative overflow-hidden group">
                                    <div class="flex justify-between mb-3"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${t.category}</span>
                                    ${state.user.role === ROLES.LEAD ? `<button onclick="event.stopPropagation(); app.deleteTopic('${t.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>` : ''}</div>
                                    <h3 class="font-bold text-lg mb-2 group-hover:text-indigo-600 transition">${t.name}</h3>
                                    <p class="text-slate-500 text-sm mb-4 line-clamp-2">${t.desc}</p>
                                    <div class="flex justify-between text-xs text-slate-400 pt-3 border-t"><span><i class="fa-solid fa-user"></i> ${state.userList[t.author] ? state.userList[t.author].name : 'Unknown'}</span><span>${count} æƒ³æ³•</span></div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                
                // Re-attach listeners for filter buttons
                setTimeout(() => {
                    document.querySelectorAll('.filter-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            // Visual toggle only for v1
                            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-slate-200'));
                            e.currentTarget.classList.add('active', 'bg-slate-200');
                        });
                    });
                }, 0);
            },

            renderCanvas: () => {
                const topic = state.topics.find(t => t.id === state.currentTopicId);
                const nodes = state.nodes.filter(n => n.topicId === state.currentTopicId);
                const container = document.getElementById('app-container');

                container.innerHTML = `
                    <div class="absolute top-2 left-2 right-2 md:top-4 md:left-4 md:right-4 z-40 flex justify-between pointer-events-none">
                        <div class="bg-white/90 backdrop-blur shadow-sm border rounded-lg p-2 pointer-events-auto flex items-center gap-2 max-w-[60%]">
                            <button onclick="app.router('entrance')" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500"><i class="fa-solid fa-arrow-left"></i></button>
                            <div class="h-6 w-px bg-slate-200"></div><h2 class="font-bold text-xs md:text-sm truncate px-1">${topic.name}</h2>
                        </div>
                        <div class="bg-white/90 backdrop-blur shadow-sm border rounded-lg p-1 pointer-events-auto flex">
                            <button onclick="app.canvas.fitView()" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100"><i class="fa-solid fa-expand"></i></button>
                            <button onclick="app.canvas.zoom(0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 hidden md:flex"><i class="fa-solid fa-plus"></i></button>
                            <button onclick="app.canvas.zoom(-0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 hidden md:flex"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <button onclick="app.openComposer(null)" class="absolute bottom-6 right-4 md:bottom-8 md:right-8 z-40 bg-indigo-600 text-white rounded-full w-12 h-12 md:w-14 md:h-14 shadow-xl flex items-center justify-center text-xl transition transform hover:scale-105"><i class="fa-solid fa-plus"></i></button>
                    
                    <div id="canvas-wrapper" class="w-full h-full cursor-grab active:cursor-grabbing overflow-hidden relative touch-none"
                         onmousedown="app.canvas.startPan(event)" ontouchstart="app.canvas.startPan(event)"
                         onmousemove="app.canvas.pan(event)" ontouchmove="app.canvas.pan(event)"
                         onwheel="app.canvas.handleWheel(event)">
                        <div id="canvas-bg"></div> 
                        <div id="canvas-content" class="absolute top-0 left-0 w-full h-full origin-top-left will-change-transform">
                            <svg id="connections-layer" class="absolute top-0 left-0 w-[5000px] h-[5000px] pointer-events-none overflow-visible z-0"></svg>
                            <div id="nodes-layer" class="z-10"></div>
                        </div>
                    </div>
                `;

                ui.drawNodes(nodes);
                // Important: Use setTimeout to ensure DOM is ready for connection drawing (bug fix from original)
                setTimeout(() => ui.drawConnections(nodes), 0);
                app.canvas.applyTransform();
            },

            renderProfile: () => {
                const container = document.getElementById('app-container');
                const u = state.user;
                container.innerHTML = `
                    <div class="max-w-2xl mx-auto px-6 py-8 h-full overflow-y-auto custom-scroll pb-20">
                        <div class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-6 shadow-sm border border-indigo-100 text-center mb-6 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-purple-500 to-indigo-500"></div>
                            <img src="${u.avatar}" class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-white shadow-md">
                            <h2 class="text-2xl font-bold text-slate-800">${u.name}</h2>
                            <p class="text-slate-500 text-sm mb-1">${u.role === ROLES.LEAD ? 'é¦–å¸­ç ”ç©¶å“¡' : 'å”åŒç ”ç©¶å“¡'}</p>
                            <div class="flex justify-center gap-2 mt-4"><span class="bg-white/80 border px-3 py-1 rounded-full text-xs font-bold text-slate-600 shadow-sm">ID: ${u.id}</span></div>
                        </div>
                        <div class="space-y-6">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-robot text-indigo-600"></i> æˆ‘çš„çŸ¥è­˜å»ºæ§‹æª”æ¡ˆ (KB Profile)</h3>
                                <button onclick="app.generateAIProfile()" id="btn-gen-profile" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 transition flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> <span>ç”Ÿæˆåˆ†æ</span></button>
                            </div>
                            <div id="ai-loading" class="hidden p-8 text-center bg-white rounded-2xl border border-slate-100"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-2"></div><p class="text-sm text-slate-500 animate-pulse">æ­£åœ¨å›é¡§ä½ çš„çŸ¥è­˜æ¼”åŒ–è»Œè·¡...</p></div>
                            <div id="ai-profile-result" class="hidden space-y-4"></div>
                        </div>
                    </div>`;
                if (state.profile && document.getElementById('ai-profile-result')) { app.renderProfileContent(state.profile); }
            },

            drawNodes: (nodes) => {
                document.getElementById('nodes-layer').innerHTML = nodes.map(node => {
                    const s = SCAFFOLDS[node.type];
                    const user = Object.values(state.userList).find(u => u.id === node.author) || {name: '?'};
                    const canDel = state.user.role === ROLES.LEAD || node.author === state.user.id;
                    return `
                    <div id="node-${node.id}" class="absolute node-card w-64 md:w-72 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden"
                         style="left: ${node.x}px; top: ${node.y}px;"
                         onmousedown="event.stopPropagation(); app.canvas.startDrag(event, '${node.id}')"
                         ontouchstart="event.stopPropagation(); app.canvas.startDrag(event, '${node.id}')"
                         ondblclick="event.stopPropagation(); app.openNodeDetail('${node.id}')">
                        <div class="px-3 py-2 ${s.bgSoft} border-b ${s.border} flex justify-between items-center cursor-move">
                            <div class="flex items-center gap-2"><span class="w-5 h-5 rounded-full ${s.color} text-white flex justify-center items-center text-xs"><i class="fa-solid ${s.icon}"></i></span><span class="text-xs font-bold ${s.text}">${s.label}</span></div>
                            <div class="flex gap-1">
                                <button onclick="event.stopPropagation(); app.openNodeDetail('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 flex justify-center items-center"><i class="fa-solid fa-eye"></i></button>
                                <button onclick="event.stopPropagation(); app.openComposer('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 flex justify-center items-center"><i class="fa-solid fa-reply"></i></button>
                                ${canDel ? `<button onclick="event.stopPropagation(); app.deleteNode('${node.id}')" class="w-8 h-8 rounded hover:bg-white/50 text-slate-500 hover:text-red-500 flex justify-center items-center"><i class="fa-solid fa-xmark"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="p-3 text-sm text-slate-700 leading-relaxed min-h-[60px] line-clamp-3 pointer-events-none">${node.content}</div>
                        <div class="px-3 py-2 bg-slate-50 border-t flex justify-between text-[10px] text-slate-500 items-center">
                            <div class="flex items-center gap-2"><img src="${user.avatar}" class="w-4 h-4 rounded-full"><span>${user.name}</span></div><span>${new Date(node.date).toLocaleDateString()}</span>
                        </div>
                    </div>`;
                }).join('');
            },

            drawConnections: (nodes) => {
                const layer = document.getElementById('connections-layer');
                if(!layer) return;
                
                // Clear old paths
                layer.innerHTML = `<defs>${Object.keys(SCAFFOLDS).map(k => {
                    const c = { question: '#3b82f6', extend: '#eab308', improve: '#22c55e', counter: '#ef4444', riseabove: '#a855f7' }[k];
                    return `<marker id="arrow-${k}" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="${c}" /></marker>`;
                }).join('')}</defs>`;

                const cardWidth = window.innerWidth < 768 ? 256 : 288;
                const halfW = cardWidth / 2;
                
                const paths = nodes.filter(n => n.parentId).map(node => {
                    const parent = state.nodes.find(p => p.id === node.parentId);
                    if (!parent) return '';
                    
                    const startX = parent.x + halfW;
                    const startY = parent.y + 140; 
                    const endX = node.x + halfW;
                    const endY = node.y;

                    const dist = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    let curveFactor = 0.4;
                    if (endY < startY) curveFactor = 0.6; 

                    const cp1x = startX;
                    const cp1y = startY + dist * curveFactor;
                    const cp2x = endX;
                    const cp2y = endY - dist * curveFactor;

                    const colorMap = { question: '#3b82f6', extend: '#eab308', improve: '#22c55e', counter: '#ef4444', riseabove: '#a855f7' };
                    // Use HTML string injection for connections in v1
                    return `<path d="M ${startX} ${startY} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${endX} ${endY}" stroke="${colorMap[node.type]}" fill="none" stroke-width="2" stroke-opacity="0.6" marker-end="url(#arrow-${node.type})" />`;
                }).join('');
                
                layer.innerHTML += paths;
            }
        };

        const app = {
            generateCategoryOptions: () => {
                return Object.entries(TOPIC_CATEGORIES).map(([value, label]) => `<option value="${value}">${label}</option>`).join('');
            },
            generateCategoryFilters: () => {
                let buttons = '<button class="px-4 py-1.5 rounded-full bg-slate-200 text-sm font-medium filter-btn active" data-category="å…¨éƒ¨">æ‰€æœ‰ä¸»é¡Œ</button>';
                buttons += Object.entries(TOPIC_CATEGORIES).map(([value, label]) => `<button class="px-4 py-1.5 border rounded-full text-sm filter-btn" data-category="${label}">${label}</button>`).join('');
                return buttons;
            },
            router: (view) => {
                if (view === 'canvas' && !state.currentTopicId) {
                    ui.showToast('è«‹å…ˆå¾ä¸»é¡Œå…¥å£é¸æ“‡ä¸€å€‹æ¢ç©¶ä¸»é¡Œ', 'error');
                    app.router('entrance');
                    return;
                }
                state.currentView = view;
                ui.updateNav(view);
                document.getElementById('user-menu').classList.add('hidden');
                if(view === 'entrance') { state.currentTopicId = null; ui.renderEntrance(); }
                else if(view === 'canvas') { ui.renderCanvas(); }
                else if(view === 'profile') { ui.renderProfile(); }
            },
            toggleUserMenu: () => document.getElementById('user-menu').classList.toggle('hidden'),
            openAddUserModal: () => {
                document.getElementById('modal-addUser').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
                document.getElementById('new-user-name').focus();
            },
            createNewUser: () => {
                const nameInput = document.getElementById('new-user-name');
                const roleInput = document.getElementById('new-user-role');
                const name = nameInput.value.trim();
                if (!name) return ui.showToast('æš±ç¨±ä¸èƒ½ç‚ºç©º', 'error');
                const newKey = `user${Date.now()}`;
                const newId = `u${Date.now()}`;
                state.userList[newKey] = { id: newId, name, role: roleInput.value, avatar: `https://api.dicebear.com/9.x/notionists/svg?seed=${name}` };
                ui.closeModal('modal-addUser');
                ui.renderUserMenu();
                ui.showToast('æ–°å¢æˆåŠŸ');
                app.switchUser(newKey);
            },
            deleteUser: (key) => {
                if (state.userList[key].id === state.user.id) {
                    return ui.showToast('ç„¡æ³•åˆªé™¤ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…', 'error');
                }
                if (Object.keys(state.userList).length <= 1) {
                    return ui.showToast('ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€ä½ä½¿ç”¨è€…', 'error');
                }

                ui.confirm('ç¢ºå®šåˆªé™¤ä½¿ç”¨è€…ï¼Ÿ', 'æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => {
                    delete state.userList[key];
                    ui.renderUserMenu();
                    ui.showToast('ä½¿ç”¨è€…å·²åˆªé™¤');
                    ui.closeModal('modal-confirm');
                });
            },
            switchUser: (userKey) => {
                if (!state.userList[userKey]) return;
                state.user = state.userList[userKey];
                state.profile = null; 
                ui.renderUserInfo(); 
                ui.renderUserMenu();
                ui.showToast(`å·²åˆ‡æ›ï¼š${state.user.name}`);
                document.getElementById('user-menu').classList.add('hidden');
                if(state.currentView === 'canvas') ui.renderCanvas(); 
                else if(state.currentView === 'profile') ui.renderProfile();
                else ui.renderEntrance();
            },
            createTopic: () => {
                const name = document.getElementById('topic-name').value;
                if(!name) return ui.showToast('è«‹è¼¸å…¥å•é¡Œ', 'error');
                const categoryValue = document.getElementById('topic-category').value; 
                state.topics.unshift({ id: 't'+Date.now(), name, category: TOPIC_CATEGORIES[categoryValue] || categoryValue, desc: document.getElementById('topic-desc').value, author: state.user.id, date: new Date().toISOString() });
                ui.closeModal('modal-topic'); ui.renderEntrance();
            },
            deleteTopic: (id) => {
                ui.confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 'å°‡é€£åŒå­ç¯€é»ä¸€ä½µåˆªé™¤ã€‚', () => {
                    state.topics = state.topics.filter(t => t.id !== id);
                    state.nodes = state.nodes.filter(n => n.topicId !== id);
                    ui.closeModal('modal-confirm'); ui.renderEntrance();
                });
            },
            enterTopic: (id) => { state.currentTopicId = id; state.canvas.scale=1; state.canvas.offsetX=0; state.canvas.offsetY=0; app.router('canvas'); },
            openComposer: (pid) => {
                state.composer.parentId = pid;
                document.getElementById('scaffold-selector').innerHTML = Object.values(SCAFFOLDS).map(s => `
                    <button onclick="app.selectScaffold('${s.id}')" id="btn-scaffold-${s.id}" class="flex flex-col items-center justify-center p-2 rounded-lg border-2 border-slate-100 opacity-60"><div class="w-8 h-8 rounded-full ${s.color} text-white flex justify-center items-center mb-1"><i class="fa-solid ${s.icon}"></i></div><span class="text-xs font-bold text-slate-600">${s.label}</span></button>`).join('');
                document.getElementById('modal-node').classList.remove('hidden');
            },
            selectScaffold: (t) => {
                state.composer.selectedScaffold = t;
                Object.values(SCAFFOLDS).forEach(s => {
                    const btn = document.getElementById(`btn-scaffold-${s.id}`);
                    if(s.id === t) { btn.classList.remove('opacity-60', 'border-slate-100'); btn.classList.add('opacity-100', SCAFFOLDS[t].border, SCAFFOLDS[t].bgSoft); }
                    else { btn.classList.add('opacity-60', 'border-slate-100'); btn.classList.remove('opacity-100', SCAFFOLDS[s.id].border, SCAFFOLDS[s.id].bgSoft); }
                });
            },
            checkAIIntervention: (e) => {
                const len = e.target.value.length;
                const box = document.getElementById('ai-suggestion-box');
                if(len > 5 && len < 20) box.classList.remove('hidden'); else box.classList.add('hidden');
            },
            submitNode: () => {
                if(!state.composer.selectedScaffold) return ui.showToast('è«‹é¸æ“‡æ„åœ–', 'error');
                const content = document.getElementById('node-content').value;
                if(!content) return;
                const pid = state.composer.parentId;
                let nx, ny;
                if(pid) {
                    const p = state.nodes.find(n => n.id === pid);
                    nx = p.x + (Math.random()*100 - 50); ny = p.y + 200;
                } else {
                    const wrap = document.getElementById('canvas-wrapper');
                    nx = -state.canvas.offsetX + wrap.clientWidth/2 - 140;
                    ny = -state.canvas.offsetY + wrap.clientHeight/2 - 100;
                }
                state.nodes.push({ id: 'n'+Date.now(), topicId: state.currentTopicId, type: state.composer.selectedScaffold, content, author: state.user.id, date: Date.now(), x: nx, y: ny, parentId: pid });
                ui.closeModal('modal-node'); ui.renderCanvas();
            },
            deleteNode: (id) => {
                ui.confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 'å°‡é€£åŒå­ç¯€é»ä¸€ä½µåˆªé™¤ã€‚', () => {
                    const toDel = [id];
                    const findChildren = (pid) => { state.nodes.filter(n => n.parentId === pid).forEach(c => { toDel.push(c.id); findChildren(c.id); }); };
                    findChildren(id);
                    state.nodes = state.nodes.filter(n => !toDel.includes(n.id));
                    ui.closeModal('modal-confirm'); ui.renderCanvas();
                });
            },
            openNodeDetail: (id) => {
                const n = state.nodes.find(x => x.id === id); if(!n) return;
                const s = SCAFFOLDS[n.type]; 
                const u = Object.values(state.userList).find(u => u.id === n.author);
                const icon = document.getElementById('detail-scaffold-icon');
                icon.className = `w-10 h-10 rounded-full flex justify-center items-center text-white text-lg ${s.color}`;
                icon.innerHTML = `<i class="fa-solid ${s.icon}"></i>`;
                document.getElementById('detail-scaffold-label').innerText = s.label;
                document.getElementById('detail-scaffold-label').className = `text-xs font-bold uppercase mb-0.5 ${s.text}`;
                document.getElementById('detail-author').innerText = u ? u.name : '?';
                document.getElementById('detail-date').innerText = new Date(n.date).toLocaleString();
                document.getElementById('detail-content').innerText = n.content;
                document.getElementById('btn-detail-reply').onclick = () => { ui.closeModal('modal-detail'); setTimeout(() => app.openComposer(n.id), 200); };
                document.getElementById('modal-detail').classList.remove('hidden');
            },
            generateAIProfile: () => {
                const btn = document.getElementById('btn-gen-profile');
                const loading = document.getElementById('ai-loading');
                btn.classList.add('hidden');
                loading.classList.remove('hidden');
                document.getElementById('ai-profile-result').classList.add('hidden');
                setTimeout(() => {
                    const myNodes = state.nodes.filter(n => n.author === state.user.id);
                    const profileData = app.mockGeminiAnalysis(state.user, myNodes);
                    state.profile = profileData;
                    app.renderProfileContent(profileData);
                    loading.classList.add('hidden');
                }, 1500);
            },
            mockGeminiAnalysis: (user, nodes) => {
                // 1. Calculate Scaffold Distribution
                const counts = { question:0, extend:0, improve:0, counter:0, riseabove:0 };
                nodes.forEach(n => { if(counts[n.type] !== undefined) counts[n.type]++; });
                const total = nodes.length || 1;

                // 2. Determine Role
                let role, desc, icon;
                const maxType = Object.keys(counts).length > 0 ? Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b) : 'question';
                
                if (maxType === 'question') { 
                    role = "å‰ç»æ¢ç´¢è€… (Epistemic Explorer)"; 
                    desc = "ä½ å–„æ–¼ç™¼æ˜å•é¡Œçš„æœ¬è³ªï¼Œç‚ºç¤¾ç¾¤é–‹å•Ÿäº†é—œéµçš„æ¢ç©¶è·¯å¾‘ã€‚ä½ çš„æå•å¾€å¾€èƒ½å¼•ç™¼æ·±å±¤çš„æ€è€ƒï¼Œæ˜¯çŸ¥è­˜å»ºæ§‹çš„èµ·é»ã€‚";
                    icon = "fa-compass";
                } else if (maxType === 'riseabove') { 
                    role = "è§€é»æ˜‡è¯è€… (Idea Synthesizer)"; 
                    desc = "ä½ æ“æœ‰å“è¶Šçš„æ•´åˆèƒ½åŠ›ï¼Œèƒ½å¾ç´›äº‚çš„è³‡è¨Šä¸­æ¢³ç†å‡ºé«˜å±¤æ¬¡çš„è§£é‡‹ã€‚ä½ å¹«åŠ©ç¤¾ç¾¤è¶…è¶Šäº†å€‹åˆ¥è§€é»çš„ä¾·é™ï¼Œé‚å‘æ›´çµ±ä¸€çš„ç†è§£ã€‚";
                    icon = "fa-layer-group";
                } else if (maxType === 'counter') { 
                    role = "å»ºè¨­æ€§æ‰¹åˆ¤è€… (Constructive Critic)"; 
                    desc = "ä½ å‹‡æ–¼æŒ‘æˆ°æ—¢æœ‰å‡è¨­ï¼Œé€éåä¾‹èˆ‡è¾¯è­‰ï¼Œå”åŠ©ç¤¾ç¾¤ä¿®è£œç†è«–çš„æ¼æ´ã€‚ä½ çš„å­˜åœ¨ç¢ºä¿äº†çŸ¥è­˜çš„å¼·éŸŒæ€§ã€‚";
                    icon = "fa-gavel";
                } else if (maxType === 'improve') {
                    role = "ç†è«–å„ªåŒ–è€… (Theory Improver)";
                    desc = "ä½ æŒçºŒè‡´åŠ›æ–¼æ”¹å–„ä»–äººçš„æƒ³æ³•ï¼Œä¸æ»¿è¶³æ–¼ç¾ç‹€ï¼Œç¸½èƒ½æå‡ºæ›´ç²¾ç¢ºçš„ä¿®æ­£ã€‚ä½ æ˜¯è®“ç¤¾ç¾¤çŸ¥è­˜æŒçºŒé€²æ­¥çš„å‹•åŠ›ã€‚";
                    icon = "fa-wrench";
                } else { 
                    role = "ç©æ¥µé€£çµè€… (Active Connector)"; 
                    desc = "ä½ ç©æ¥µä¸²è¯å„ç¨®æƒ³æ³•ï¼Œé€éå»¶ä¼¸è¨è«–è±å¯Œäº†çŸ¥è­˜çš„å»£åº¦ã€‚ä½ æ˜¯ç¤¾ç¾¤å”ä½œä¸­ä¸å¯æˆ–ç¼ºçš„æ©‹æ¨‘ã€‚";
                    icon = "fa-link";
                }

                // 3. Generate Trajectory (Mocking a thread logic)
                let trajectoryHTML = "";
                if (nodes.length === 0) {
                    trajectoryHTML = "<p class='text-slate-500 italic'>å°šç„¡è¶³å¤ è³‡æ–™ä¾†åˆ†ææ¼”åŒ–è»Œè·¡ï¼Œå¿«å»è²¢ç»æƒ³æ³•å§ï¼</p>";
                } else {
                    // Sort by date desc
                    const sorted = [...nodes].sort((a,b) => b.date - a.date).slice(0, 3);
                    trajectoryHTML = sorted.map((n, i) => {
                        const s = SCAFFOLDS[n.type];
                        return `
                            <div class="flex items-start gap-3 relative pb-4 last:pb-0">
                                ${i !== sorted.length -1 ? '<div class="absolute left-[14px] top-8 bottom-0 w-0.5 bg-slate-200"></div>' : ''}
                                <div class="w-7 h-7 rounded-full ${s.color} text-white flex items-center justify-center shrink-0 z-10 text-xs">
                                    <i class="fa-solid ${s.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${s.bgSoft} ${s.text}">${s.label}</span>
                                        <span class="text-[10px] text-slate-400">${new Date(n.date).toLocaleDateString()}</span>
                                    </div>
                                    <p class="text-slate-700 text-sm bg-slate-50 p-2 rounded border border-slate-100">${n.content}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // 4. Interaction Analysis (Mock logic based on node data)
                // In a real app, we'd query relation counts. Here we estimate based on 'parentId'.
                const replyCount = nodes.filter(n => n.parentId).length; 
                // Sparked count is harder without full graph traversal in this isolated function, assume mock proportional to total
                const sparkedCount = Math.floor(total * 0.8); 

                const communityHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${replyCount}</div>
                            <div class="text-xs text-blue-800">æ‰¿æ¥ä»–äººæƒ³æ³•</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600">${sparkedCount}</div>
                            <div class="text-xs text-indigo-800">æ¿€ç™¼å¾ŒçºŒè¨è«–</div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        ${replyCount > sparkedCount 
                            ? "ä½ å‚¾å‘æ–¼<span class='font-bold text-blue-600'>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</span>ï¼Œå–„æ–¼æ¶ˆåŒ–ä¸¦å»¶çºŒä»–äººçš„è§€é»ï¼Œæ˜¯ç¤¾ç¾¤è¨è«–çš„å …å¯¦åŸºç¤ã€‚" 
                            : "ä½ çš„æƒ³æ³•å…·æœ‰<span class='font-bold text-indigo-600'>é«˜åº¦å•Ÿç™¼æ€§</span>ï¼Œç¶“å¸¸æˆç‚ºç¤¾ç¾¤ç†±çƒˆè¨è«–çš„æ ¸å¿ƒï¼ŒæˆåŠŸæ¨å‹•äº†é›†é«”çŸ¥è­˜çš„å¢é•·ã€‚"}
                    </p>
                `;

                // 5. KB Spirit Stats (Scaffold Usage)
                const statsHTML = Object.entries(counts).map(([k, v]) => {
                    const pct = (v / total) * 100;
                    const s = SCAFFOLDS[k];
                    return `
                        <div class="mb-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-medium text-slate-600 flex items-center gap-1"><i class="fa-solid ${s.icon} ${s.text}"></i> ${s.label}</span>
                                <span class="text-slate-400">${Math.round(pct)}%</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-1.5">
                                <div class="${s.color} h-1.5 rounded-full transition-all duration-1000" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                return { 
                    role, 
                    desc, 
                    icon,
                    trajectoryHTML, 
                    communityHTML,
                    statsHTML
                };
            },
            renderProfileContent: (data) => {
                const result = document.getElementById('ai-profile-result');
                result.innerHTML = `
                    <!-- 1. Knowledge Role -->
                    <div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-indigo-500 relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-5 transform translate-x-4 -translate-y-4">
                            <i class="fa-solid ${data.icon} text-9xl text-indigo-900"></i>
                        </div>
                        <h4 class="text-sm font-bold text-indigo-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-fire"></i> ä½¿ç”¨è€…çŸ¥è­˜è§’è‰²
                        </h4>
                        <div class="relative z-10">
                            <p class="text-xl font-bold text-slate-800 mb-2">${data.role}</p>
                            <p class="text-sm text-slate-600 leading-relaxed">${data.desc}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 2. Trajectory -->
                        <div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500" style="animation-delay: 0.1s">
                            <h4 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-seedling"></i> æƒ³æ³•æ¼”åŒ–è»Œè·¡
                            </h4>
                            <div class="pl-2">
                                ${data.trajectoryHTML}
                            </div>
                        </div>

                        <!-- 3. Community Drive -->
                        <div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500" style="animation-delay: 0.2s">
                            <h4 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-puzzle-piece"></i> ç¤¾ç¾¤æ¨å‹•åŠ›
                            </h4>
                            ${data.communityHTML}
                        </div>
                    </div>

                    <!-- 4. KB Spirit / Scaffold Analysis -->
                    <div class="animate-fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500" style="animation-delay: 0.3s">
                        <h4 class="text-sm font-bold text-purple-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-chart-pie"></i> çŸ¥è­˜å»ºæ§‹ç­–ç•¥åˆ†ä½ˆ
                        </h4>
                        <p class="text-xs text-slate-500 mb-4">é€™é¡¯ç¤ºäº†ä½ åœ¨çŸ¥è­˜å»ºæ§‹éç¨‹ä¸­æ‰€ä½¿ç”¨çš„èªçŸ¥ç­–ç•¥å¤šæ¨£æ€§ (Idea Diversity)ï¼š</p>
                        <div class="grid grid-cols-1 gap-2">
                            ${data.statsHTML}
                        </div>
                    </div>
                `;
                result.classList.remove('hidden');
            },
            canvas: {
                renderLoop: () => {
                    if (state.currentView === 'canvas' && state.canvas.draggedNodeId) {
                        const nodes = state.nodes.filter(n => n.topicId === state.currentTopicId);
                        ui.drawConnections(nodes);
                    }
                    requestAnimationFrame(app.canvas.renderLoop);
                },
                applyTransform: () => {
                    const el = document.getElementById('canvas-content');
                    if(el) el.style.transform = `translate(${state.canvas.offsetX}px, ${state.canvas.offsetY}px) scale(${state.canvas.scale})`;
                    const bg = document.getElementById('canvas-bg');
                    if(bg) bg.style.backgroundPosition = `${state.canvas.offsetX}px ${state.canvas.offsetY}px`;
                },
                getCoords: (e) => (e.touches && e.touches.length > 0) ? {x: e.touches[0].clientX, y: e.touches[0].clientY} : {x: e.clientX, y: e.clientY},
                startPan: (e) => {
                    if(e.target.closest('.node-card')) return;
                    state.canvas.isDragging = true;
                    const c = app.canvas.getCoords(e);
                    state.canvas.lastX = c.x; state.canvas.lastY = c.y;
                    document.getElementById('canvas-wrapper').style.cursor = 'grabbing';
                },
                pan: (e) => {
                    const c = app.canvas.getCoords(e);
                    if(state.canvas.isDragging) {
                        state.canvas.offsetX += c.x - state.canvas.lastX;
                        state.canvas.offsetY += c.y - state.canvas.lastY;
                        state.canvas.lastX = c.x; state.canvas.lastY = c.y;
                        app.canvas.applyTransform();
                    } else if(state.canvas.draggedNodeId) {
                        const dx = (c.x - state.canvas.lastX) / state.canvas.scale;
                        const dy = (c.y - state.canvas.lastY) / state.canvas.scale;
                        const node = state.nodes.find(n => n.id === state.canvas.draggedNodeId);
                        if(node) {
                            node.x += dx; node.y += dy;
                            const el = document.getElementById(`node-${node.id}`);
                            if(el) { el.style.left = `${node.x}px`; el.style.top = `${node.y}px`; }
                        }
                        state.canvas.lastX = c.x; state.canvas.lastY = c.y;
                    }
                },
                handleEnd: () => {
                    state.canvas.isDragging = false; state.canvas.draggedNodeId = null;
                    const w = document.getElementById('canvas-wrapper'); if(w) w.style.cursor = 'grab';
                },
                handleWheel: (e) => {
                    e.preventDefault();
                    const d = -e.deltaY * 0.001;
                    state.canvas.scale = Math.min(Math.max(0.2, state.canvas.scale + d), 3);
                    app.canvas.applyTransform();
                },
                zoom: (d) => { state.canvas.scale = Math.min(Math.max(0.2, state.canvas.scale + d), 3); app.canvas.applyTransform(); },
                fitView: () => { state.canvas.scale = window.innerWidth < 768 ? 0.8 : 1; state.canvas.offsetX = 0; state.canvas.offsetY = 0; app.canvas.applyTransform(); },
                startDrag: (e, id) => {
                    state.canvas.draggedNodeId = id;
                    const c = app.canvas.getCoords(e);
                    state.canvas.lastX = c.x; state.canvas.lastY = c.y;
                }
            }
        };

        window.addEventListener('DOMContentLoaded', ui.init);
    </script>
</body>
</html>